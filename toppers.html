<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title> Class Toppers | Noorussalam Madrasa</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --primary: #1e3a8a;
  --secondary: #fbbf24;
  --accent: #059669;
  --light: #f0f9ff;
  --dark: #0f172a;
  --white: #ffffff;
  --gray: #64748b;
  --gold: #d4af37;
  --silver: #c0c0c0;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --gradient-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
  --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  --gradient-accent: linear-gradient(135deg, #059669 0%, #10b981 100%);
  --gradient-gold: linear-gradient(135deg, #fbbf24, #d4af37, #f59e0b);
  --gradient-silver: linear-gradient(135deg, #c0c0c0, #94a3b8, #64748b);
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}

body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  color: var(--dark);
  min-height: 100vh;
  padding: 15px;
  position: relative;
  overflow-x: hidden;
  font-size: 14px;
}

body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 250px;
  background: linear-gradient(135deg, rgba(30, 58, 138, 0.03) 0%, rgba(251, 191, 36, 0.03) 100%);
  z-index: -1;
}

.wrap {
  max-width: 1300px;
  margin: 0 auto;
  position: relative;
}

/* Header Section */
.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 25px;
  background: var(--white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
}

.header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
}

.header-content {
  position: relative;
  z-index: 2;
}

.logo-container {
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.logo-icon {
  width: 80px;
  height: 80px;
  background: var(--gradient-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 34px;
  color: var(--white);
  box-shadow: var(--shadow-lg);
  border: 3px solid var(--white);
  position: relative;
  overflow: hidden;
}

.logo-icon::after {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
  transform: rotate(45deg);
  animation: shine 3s infinite linear;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.header h1 {
  font-family: "Poppins", sans-serif;
  font-size: 32px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 8px 0;
  letter-spacing: -0.5px;
  text-shadow: 0 2px 4px rgba(30, 58, 138, 0.1);
}

.subtitle {
  font-size: 16px;
  color: var(--primary);
  font-weight: 500;
  margin: 8px 0;
  opacity: 0.9;
}

.tagline {
  display: inline-block;
  padding: 10px 24px;
  background: var(--gradient-secondary);
  color: var(--dark);
  font-weight: 600;
  border-radius: 50px;
  margin-top: 12px;
  box-shadow: var(--shadow-sm);
  border: 2px solid rgba(255, 255, 255, 0.3);
  font-size: 14px;
  position: relative;
  overflow: hidden;
}

/* Search Section */
.search-container {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
}

.search-container::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.search-header {
  text-align: center;
  margin-bottom: 25px;
}

.search-header h3 {
  font-family: "Poppins", sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.search-header p {
  color: var(--gray);
  font-size: 14px;
}

.search-box {
  display: flex;
  gap: 12px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.search-input-wrapper {
  flex: 1;
  min-width: 280px;
  max-width: 450px;
  position: relative;
}

.search-input-wrapper i {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
  font-size: 16px;
}

#classSearch {
  width: 100%;
  padding: 15px 18px 15px 45px;
  border: 2px solid #e2e8f0;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
  background: var(--white);
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
}

#classSearch:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
}

.search-btn, .clear-search-btn {
  padding: 15px 30px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow-md);
}

.search-btn {
  background: var(--gradient-primary);
  color: var(--white);
}

.clear-search-btn {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  color: var(--white);
}

.search-btn:hover, .clear-search-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.class-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 15px;
}

.class-filter-btn {
  padding: 10px 20px;
  background: var(--white);
  border: 2px solid #e2e8f0;
  border-radius: 50px;
  color: var(--primary);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.class-filter-btn:hover {
  background: rgba(30, 58, 138, 0.05);
  border-color: var(--primary);
}

.class-filter-btn.active {
  background: var(--gradient-primary);
  color: var(--white);
  border-color: var(--primary);
}

.search-results-info {
  text-align: center;
  margin-top: 15px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
  border-radius: var(--radius);
  font-weight: 600;
  color: var(--primary);
  border: 2px solid rgba(251, 191, 36, 0.2);
  display: none;
  font-size: 13px;
}

/* Classes Section */
.classes-header {
  text-align: center;
  margin: 40px 0 30px;
}

.classes-header h2 {
  font-family: "Poppins", sans-serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 12px;
  position: relative;
  display: inline-block;
}

.classes-header h2::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 3px;
  background: var(--gradient-secondary);
  border-radius: 2px;
}

.classes-header p {
  color: var(--gray);
  font-size: 15px;
  max-width: 550px;
  margin: 0 auto;
}

/* REDUCED CARD SIZES - Beautiful and Compact */
.classes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.class-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  border-radius: var(--radius-xl);
  padding: 25px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.class-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.class-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.class-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px dashed rgba(30, 58, 138, 0.1);
  position: relative;
}

.class-header h3 {
  font-size: 20px;
  color: var(--primary);
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* Topper Cards - Beautiful Compact Design */
.topper-card {
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: var(--shadow-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

.topper-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.topper-card.first {
  border-left: 4px solid var(--gold);
  background: linear-gradient(135deg, rgba(255, 251, 235, 0.9) 0%, rgba(254, 243, 199, 0.9) 100%);
}

.topper-card.second {
  border-left: 4px solid var(--silver);
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%);
}

.rank-badge {
  position: absolute;
  top: -12px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  color: var(--white);
  z-index: 2;
  box-shadow: var(--shadow-md);
  border: 3px solid var(--white);
}

.rank-badge.first {
  background: var(--gradient-gold);
  color: #92400e;
}

.rank-badge.second {
  background: var(--gradient-silver);
}

/* Photo Display - Upload Button Only */
.photo-display {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 15px;
  min-height: auto;
}

.photo-container {
  display: none; /* Hide photo container */
}

.upload-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 10px auto 15px;
  padding: 10px 24px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-md);
  width: 100%;
  max-width: 200px;
  position: relative;
  overflow: hidden;
}

.upload-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.upload-btn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s ease;
}

.upload-btn:hover::after {
  left: 100%;
}

.student-name {
  text-align: center;
  font-family: "Poppins", sans-serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  margin: 10px 0 8px;
  padding: 0 10px;
  line-height: 1.3;
}

.rank-label {
  text-align: center;
  font-weight: 700;
  margin: 8px 0;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 6px 18px;
  border-radius: 50px;
  display: inline-block;
  box-shadow: var(--shadow-sm);
}

.rank-label.first {
  background: var(--gradient-gold);
  color: #92400e;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.rank-label.second {
  background: var(--gradient-silver);
  color: #1e293b;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.student-meta {
  text-align: center;
  color: var(--accent);
  font-weight: 600;
  margin: 10px 0;
  font-size: 14px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
  border-radius: 50px;
  display: inline-block;
  border: 1px solid rgba(5, 150, 105, 0.2);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.preview-btn {
  padding: 12px 24px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  background: var(--gradient-primary);
  color: var(--white);
  box-shadow: var(--shadow-md);
  position: relative;
  overflow: hidden;
}

.preview-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.preview-btn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s ease;
}

.preview-btn:hover::after {
  left: 100%;
}

/* Clear All Button */
.clear-all-container {
  text-align: center;
  margin: 40px 0 50px;
}

#clearAllBtn {
  padding: 14px 32px;
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: var(--white);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-lg);
  display: inline-flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

#clearAllBtn:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

#clearAllBtn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s ease;
}

#clearAllBtn:hover::after {
  left: 100%;
}

/* Footer */
.footer {
  text-align: center;
  color: var(--gray);
  margin-top: 40px;
  padding: 30px 25px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  border-top: 4px solid var(--primary);
  position: relative;
  overflow: hidden;
}

.footer::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
}

.footer-content {
  max-width: 550px;
  margin: 0 auto;
  position: relative;
  z-index: 2;
}

.footer h3 {
  font-family: "Poppins", sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 15px;
}

.footer p {
  margin: 8px 0;
  font-size: 14px;
  line-height: 1.6;
}

.heart {
  color: #ef4444;
  animation: heartbeat 1.5s infinite;
  display: inline-block;
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* Loading Overlay */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.95);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: var(--white);
  backdrop-filter: blur(10px);
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  border-top-color: var(--secondary);
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#loadingText {
  font-size: 16px;
  font-weight: 500;
  letter-spacing: 0.8px;
}

/* Certificate Preview Modal */
#certificatePreview {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.98);
  z-index: 10000;
  overflow: auto;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.certificate-canvas {
  background: #ffffff !important; /* Force white background */
  width: 850px;
  max-width: 95%;
  margin: 30px auto;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  position: relative;
  border: 1px solid rgba(0, 0, 0, 0.1); /* Darker border for contrast */
}

/* Ensure high quality rendering */
canvas {
  image-rendering: -moz-crisp-edges;
  image-rendering: -webkit-crisp-edges;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}

.close-preview {
  position: fixed;
  top: 25px;
  right: 35px;
  font-size: 36px;
  color: var(--white);
  cursor: pointer;
  background: rgba(255, 255, 255, 0.1);
  width: 55px;
  height: 55px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(5px);
  border: 2px solid rgba(255, 255, 255, 0.2);
  z-index: 10001;
}

.close-preview:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg) scale(1.1);
}

/* Preview buttons */
.preview-buttons {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10001;
  flex-wrap: wrap;
  justify-content: center;
  padding: 15px;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(10px);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.preview-buttons button {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 14px;
  box-shadow: var(--shadow-lg);
  min-width: 180px;
  justify-content: center;
}

.preview-buttons button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

.preview-buttons button:first-child {
  background: var(--gradient-secondary);
  color: #1e293b;
}

.preview-buttons button:last-child {
  background: var(--gradient-primary);
  color: var(--white);
}

/* Photo Preview Modal */
#previewModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.98);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(10px);
}

#previewModal .close {
  position: absolute;
  top: 25px;
  right: 35px;
  font-size: 36px;
  color: var(--white);
  cursor: pointer;
  background: rgba(255, 255, 255, 0.1);
  width: 55px;
  height: 55px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(5px);
  border: 2px solid rgba(255, 255, 255, 0.2);
}

#previewModal .close:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg) scale(1.1);
}

#previewModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  border: 2px solid rgba(255, 255, 255, 0.1);
}

/* Responsive Design */
@media (max-width: 1200px) {
  .classes-grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
  }
}

@media (max-width: 768px) {
  .wrap {
    padding: 10px;
  }
  
  .header {
    padding: 25px 20px;
    margin-bottom: 30px;
  }
  
  .header h1 {
    font-size: 28px;
  }
  
  .subtitle {
    font-size: 15px;
  }
  
  .search-container {
    padding: 25px 20px;
    margin: 25px 0;
  }
  
  .search-box {
    flex-direction: column;
  }
  
  .search-input-wrapper {
    min-width: 100%;
  }
  
  .classes-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .class-card {
    padding: 20px;
  }
  
  .footer {
    padding: 25px 20px;
  }
  
  .preview-buttons {
    width: 90%;
    flex-direction: column;
    align-items: center;
  }
  
  .preview-buttons button {
    width: 100%;
    max-width: 300px;
  }
}

@media (max-width: 480px) {
  .header h1 {
    font-size: 24px;
  }
  
  .classes-header h2 {
    font-size: 24px;
  }
  
  .student-name {
    font-size: 16px;
  }
  
  .upload-btn, .preview-btn {
    padding: 10px 20px;
    font-size: 12px;
  }
  
  .preview-buttons {
    bottom: 20px;
    padding: 10px;
  }
  
  .preview-buttons button {
    padding: 12px 20px;
    font-size: 13px;
    min-width: auto;
  }
}

/* Floating Elements */
.floating-elements {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
  opacity: 0.5;
}

.floating-element {
  position: absolute;
  background: linear-gradient(135deg, rgba(30, 58, 138, 0.05) 0%, rgba(251, 191, 36, 0.05) 100%);
  border-radius: 50%;
  animation: float 20s infinite ease-in-out;
  backdrop-filter: blur(2px);
}

@keyframes float {
  0%, 100% { 
    transform: translate(0, 0) rotate(0deg) scale(1); 
  }
  33% { 
    transform: translate(30px, -20px) rotate(120deg) scale(1.1); 
  }
  66% { 
    transform: translate(-20px, 30px) rotate(240deg) scale(0.9); 
  }
}

/* Success Animation */
.success-animation {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10003;
  display: none;
}

.success-checkmark {
  width: 70px;
  height: 70px;
  margin: 0 auto;
  border-radius: 50%;
  display: block;
  stroke-width: 2;
  stroke: var(--white);
  stroke-miterlimit: 10;
  box-shadow: inset 0px 0px 0px var(--success);
  animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  background: var(--gradient-accent);
}

.checkmark__circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: var(--white);
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% { stroke-dashoffset: 0; }
}

@keyframes scale {
  0%, 100% { transform: none; }
  50% { transform: scale3d(1.1, 1.1, 1); }
}

@keyframes fill {
  100% { box-shadow: inset 0px 0px 0px 100px var(--success); }
}

/* Hidden class for search */
.hidden {
  display: none !important;
}

/* Smooth transitions */
* {
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(30, 58, 138, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--gradient-primary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gradient-secondary);
}
</style>
</head>
<body>

<!-- Floating Elements -->
<div class="floating-elements">
  <div class="floating-element" style="width: 80px; height: 80px; top: 10%; left: 5%; animation-delay: 0s;"></div>
  <div class="floating-element" style="width: 120px; height: 120px; top: 60%; right: 5%; animation-delay: 2s;"></div>
  <div class="floating-element" style="width: 60px; height: 60px; bottom: 20%; left: 15%; animation-delay: 4s;"></div>
  <div class="floating-element" style="width: 100px; height: 100px; top: 20%; right: 15%; animation-delay: 6s;"></div>
  <div class="floating-element" style="width: 70px; height: 70px; bottom: 10%; right: 20%; animation-delay: 8s;"></div>
</div>

<div class="wrap">
  <!-- Header Section -->
  <header class="header">
    <div class="header-content">
      <div class="logo-container">
        <div>
          <h1>NOORUSSALAM MADRASA</h1>
          <p class="subtitle">Annual Examination Results 2025-26</p>
          <p class="tagline">Celebrating Excellence</p>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Search Section -->
  <div class="search-container">
    <div class="search-header">
      <h3>Find Students & Classes</h3>
      <p>Search by class number or student name to filter results</p>
    </div>
    
    <div class="search-box">
      <div class="search-input-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="classSearch" placeholder="Type class number (1-10) or student name..." autocomplete="off">
      </div>
      <button class="search-btn" onclick="searchClasses()">
        <i class="fas fa-search"></i> Search
      </button>
      <button class="clear-search-btn" onclick="clearSearch()">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
    
    <div class="class-filters" id="classFilterButtons">
      <!-- Class filter buttons will be generated by JavaScript -->
    </div>
    
    <div class="search-results-info" id="searchResultsInfo">
      <!-- Search results info will be shown here -->
    </div>
  </div>
  
  <!-- Classes Section -->
  <div class="classes-header">
    <h2>Class Toppers & Achievers</h2>
    <p>Select a class to view top performers and generate certificates</p>
  </div>
  
  <div id="grid" class="classes-grid"></div>
  
  <!-- Clear All Button -->
  <div class="clear-all-container">
    <button id="clearAllBtn" onclick="clearAllPhotos()">
      <i class="fas fa-broom"></i> Clear All Uploaded Photos
    </button>
  </div>
  
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <h3>Noorussalam Madrasa</h3>
      <p>Kambippalam-Kerala Estate â€¢ Academic Year 2025-2026</p>
      <p>Designed with <i class="fas fa-heart heart"></i> By Suhail Kerala</p>
      <p style="margin-top: 15px; font-size: 12px; color: #94a3b8;">Â© 2025-2026 All Rights Reserved</p>
    </div>
  </footer>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p id="loadingText">Generating High-Quality Certificate...</p>
</div>

<!-- Certificate Preview Modal -->
<div id="certificatePreview">
  <div class="close-preview" onclick="closeCertificatePreview()">Ã—</div>
  <canvas id="previewCanvas" class="certificate-canvas"></canvas>
</div>

<!-- Photo Preview Modal -->
<div id="previewModal">
  <span class="close" onclick="closePreview()">Ã—</span>
  <img id="previewImage" src="" alt="Photo Preview">
</div>

<!-- Success Animation -->
<div class="success-animation" id="successAnimation">
  <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
  </svg>
</div>

<!-- Sound -->
<audio id="certSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>

<script>
// Certificate background image URL
const CERT_BG = "https://i.postimg.cc/fLShP7BV/NSM-TOPPER-copy.jpg";

// Class data with two toppers per class (First and Second)
const classesData = [
  { 
    class: "1", 
    toppers: [
      { name: "AZIM FAIZAN M", mark: "291 / 300", rank: "First" },
      { name: "AYISHA ZAHRA P", mark: "278 / 300", rank: "Second" }
    ]
  },
  { 
    class: "2", 
    toppers: [
      { name: "Muhammed Shahid", mark: "493 / 500", rank: "First" },
      { name: "Ashmil T", mark: "490 / 500", rank: "Second" }
    ]
  },
  { 
    class: "3", 
    toppers: [
      { name: "Muhammed Hadi K", mark: "487 / 500", rank: "First" },
      { name: "Danish T", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "4", 
    toppers: [
      { name: "Faris P", mark: "489 / 500", rank: "First" },
      { name: "Rifaee P", mark: "486 / 500", rank: "Second" }
    ]
  },
  { 
    class: "5", 
    toppers: [
      { name: "Shamil N", mark: "491 / 500", rank: "First" },
      { name: "Nida Mol", mark: "488 / 500", rank: "Second" }
    ]
  },
  { 
    class: "6", 
    toppers: [
      { name: "Hana M", mark: "480 / 500", rank: "First" },
      { name: "Riya T", mark: "478 / 500", rank: "Second" }
    ]
  },
  { 
    class: "7", 
    toppers: [
      { name: "Riyas M", mark: "485 / 500", rank: "First" },
      { name: "Riya Mol", mark: "482 / 500", rank: "Second" }
    ]
  },
  { 
    class: "8", 
    toppers: [
      { name: "Zainab K", mark: "492 / 500", rank: "First" },
      { name: "Muhsin P", mark: "489 / 500", rank: "Second" }
    ]
  },
  { 
    class: "9", 
    toppers: [
      { name: "Thaj T", mark: "488 / 500", rank: "First" },
      { name: "Sinan P", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "10", 
    toppers: [
      { name: "Saniya F", mark: "495 / 500", rank: "First" },
      { name: "Asna K", mark: "492 / 500", rank: "Second" }
    ]
  }
];

// Initialize uploaded photos array from localStorage
const uploadedPhotos = {};
classesData.forEach((cls, classIndex) => {
  uploadedPhotos[classIndex] = [];
  cls.toppers.forEach((topper, topperIndex) => {
    const saved = localStorage.getItem(`topperPhoto_${classIndex}_${topperIndex}`);
    uploadedPhotos[classIndex][topperIndex] = saved || null;
  });
});

// Track certificate generation count
let certCount = parseInt(localStorage.getItem('certCount') || '0');

// Track active search
let activeSearch = '';

// Helper functions
function escapeHtml(s){ 
  return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

function placeholderDataURL(){ 
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
    <defs>
      <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#f0f9ff"/>
        <stop offset="100%" stop-color="#e0f2fe"/>
      </linearGradient>
      <linearGradient id="circle" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#1e3a8a"/>
        <stop offset="100%" stop-color="#3b82f6"/>
      </linearGradient>
    </defs>
    <rect width="500" height="500" fill="url(#bg)" rx="250"/>
    <circle cx="250" cy="200" r="120" fill="url(#circle)" opacity="0.1"/>
    <circle cx="250" cy="200" r="100" fill="#f8fafc" stroke="#3b82f6" stroke-width="2"/>
    <g fill="#1e3a8a" font-family="Arial" text-anchor="middle">
      <text x="250" y="190" font-size="28" font-weight="bold">Student</text>
      <text x="250" y="230" font-size="22" font-weight="bold">Photo</text>
      <text x="250" y="350" font-size="18">Click "Upload Photo"</text>
      <text x="250" y="380" font-size="16">to add student image</text>
    </g>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

// Show notification with beautiful style
function showNotification(message, type = 'info') {
  const icon = {
    success: 'check-circle',
    error: 'exclamation-circle',
    info: 'info-circle',
    warning: 'exclamation-triangle'
  }[type];
  
  const color = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  }[type];
  
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 25px;
    right: 25px;
    background: ${color};
    color: white;
    padding: 18px 22px;
    border-radius: 14px;
    font-weight: 500;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 13px;
  `;
  notification.innerHTML = `
    <div style="font-size: 20px;">
      <i class="fas fa-${icon}"></i>
    </div>
    <div>
      <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
      <div>${message}</div>
    </div>
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 10);
  
  setTimeout(() => {
    notification.style.transform = 'translateX(150%)';
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

// Show success animation
function showSuccessAnimation() {
  const animation = document.getElementById('successAnimation');
  animation.style.display = 'block';
  setTimeout(() => {
    animation.style.display = 'none';
  }, 2000);
}

// Create class filter buttons
function createClassFilterButtons() {
  const container = document.getElementById('classFilterButtons');
  container.innerHTML = '';
  
  // Add "All Classes" button
  const allButton = document.createElement('button');
  allButton.className = 'class-filter-btn active';
  allButton.innerHTML = '<i class="fas fa-layer-group"></i> All Classes';
  allButton.onclick = () => filterByClass('all');
  container.appendChild(allButton);
  
  // Add buttons for each class
  classesData.forEach((cls, index) => {
    const button = document.createElement('button');
    button.className = 'class-filter-btn';
    button.innerHTML = `<i class="fas fa-graduation-cap"></i> Class ${cls.class}`;
    button.onclick = () => filterByClass(cls.class);
    container.appendChild(button);
  });
}

// Filter classes by class number
function filterByClass(classNumber) {
  activeSearch = classNumber === 'all' ? '' : classNumber;
  
  // Update active button
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Find and activate the clicked button
  const buttons = Array.from(document.querySelectorAll('.class-filter-btn'));
  if (classNumber === 'all') {
    buttons[0].classList.add('active');
  } else {
    const buttonIndex = classesData.findIndex(cls => cls.class === classNumber) + 1;
    if (buttonIndex > 0 && buttonIndex < buttons.length) {
      buttons[buttonIndex].classList.add('active');
    }
  }
  
  // Update search input
  document.getElementById('classSearch').value = classNumber === 'all' ? '' : classNumber;
  
  // Apply filter
  applySearchFilter();
}

// Search classes
function searchClasses() {
  const searchTerm = document.getElementById('classSearch').value.trim().toLowerCase();
  
  if (!searchTerm) {
    clearSearch();
    return;
  }
  
  activeSearch = searchTerm;
  applySearchFilter();
  
  // Update filter buttons
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // If searching by class number, activate that button
  if (/^[1-9]|10$/.test(searchTerm)) {
    const buttons = Array.from(document.querySelectorAll('.class-filter-btn'));
    const classNum = parseInt(searchTerm);
    if (classNum >= 1 && classNum <= 10) {
      buttons[classNum].classList.add('active');
    }
  }
}

// Apply search filter
function applySearchFilter() {
  const searchTerm = activeSearch.toLowerCase();
  const classCards = document.querySelectorAll('.class-card');
  let visibleCount = 0;
  
  classCards.forEach(card => {
    const classNumber = card.querySelector('.class-header h3').textContent.replace('Class ', '').replace('ðŸŽ“', '').trim();
    const studentNames = Array.from(card.querySelectorAll('.student-name')).map(el => el.textContent.toLowerCase());
    
    let shouldShow = false;
    
    if (!searchTerm) {
      shouldShow = true;
    } else if (/^[1-9]|10$/.test(searchTerm)) {
      shouldShow = classNumber === searchTerm;
    } else {
      shouldShow = studentNames.some(name => name.includes(searchTerm));
    }
    
    if (shouldShow) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  // Update search results info
  const resultsInfo = document.getElementById('searchResultsInfo');
  if (searchTerm) {
    if (visibleCount === 0) {
      resultsInfo.innerHTML = `<i class="fas fa-info-circle"></i> No classes or students found for "${searchTerm}"`;
      resultsInfo.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%)';
      resultsInfo.style.borderColor = 'rgba(239, 68, 68, 0.2)';
    } else {
      resultsInfo.innerHTML = `<i class="fas fa-check-circle"></i> Showing ${visibleCount} class${visibleCount !== 1 ? 'es' : ''} for "${searchTerm}"`;
      resultsInfo.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%)';
      resultsInfo.style.borderColor = 'rgba(16, 185, 129, 0.2)';
    }
    resultsInfo.style.display = 'block';
  } else {
    resultsInfo.style.display = 'none';
  }
  
  // Scroll to first visible card
  if (visibleCount > 0) {
    const firstVisible = document.querySelector('.class-card[style*="display: block"]');
    if (firstVisible) {
      firstVisible.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

// Clear search
function clearSearch() {
  document.getElementById('classSearch').value = '';
  activeSearch = '';
  
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.querySelectorAll('.class-filter-btn')[0].classList.add('active');
  
  document.getElementById('searchResultsInfo').style.display = 'none';
  
  document.querySelectorAll('.class-card').forEach(card => {
    card.style.display = 'block';
  });
  
  document.getElementById('classSearch').focus();
}

// Load class cards
const grid = document.getElementById('grid');
function loadClassCards() {
  grid.innerHTML = '';
  
  classesData.forEach((cls, classIndex) => {
    const card = document.createElement('div');
    card.className = 'class-card';
    
    let toppersHTML = '';
    cls.toppers.forEach((topper, topperIndex) => {
      const photoURL = uploadedPhotos[classIndex][topperIndex] || placeholderDataURL();
      const isFirst = topper.rank === 'First';
      
      toppersHTML += `
        <div class="topper-card ${isFirst ? 'first' : 'second'}">
          <div class="rank-badge ${isFirst ? 'first' : 'second'}">
            ${isFirst ? '1st' : '2nd'}
          </div>
          <div class="photo-display">
            <!-- Upload button only - photo display is hidden -->
            <button class="upload-btn" onclick="document.getElementById('file-${classIndex}-${topperIndex}').click()">
              <i class="fas fa-cloud-upload-alt"></i> Upload Photo
            </button>
            <input type="file" id="file-${classIndex}-${topperIndex}" accept="image/*" style="display:none" 
                   onchange="handlePhotoUpload(this, ${classIndex}, ${topperIndex})">
          </div>
          <div class="student-name">${escapeHtml(topper.name)}</div>
          <div class="rank-label ${isFirst ? 'first' : 'second'}">${topper.rank} Place in Class</div>
          <div class="student-meta">Marks: ${escapeHtml(topper.mark)}</div>
          <div class="action-buttons">
            <button class="preview-btn" onclick="previewCertificate('${topper.name}','${cls.class}','${topper.mark}', '${topper.rank}', uploadedPhotos[${classIndex}][${topperIndex}] || '${photoURL}')">
              <i class="fas fa-certificate"></i> Preview Certificate
            </button>
          </div>
        </div>
      `;
    });
    
    card.innerHTML = `
      <div class="class-header">
        <h3><span class="class-icon">ðŸŽ“</span> Class ${escapeHtml(cls.class)}</h3>
      </div>
      ${toppersHTML}
    `;
    
    grid.appendChild(card);
  });
}

// Validate photo
function validatePhoto(file) {
  const maxSize = 10 * 1024 * 1024;
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  
  if (!allowedTypes.includes(file.type)) {
    showNotification('Please upload JPG, PNG, GIF, or WebP images only.', 'error');
    return false;
  }
  
  if (file.size > maxSize) {
    showNotification('Image size should be less than 10MB.', 'error');
    return false;
  }
  
  return true;
}

// Handle photo upload
async function handlePhotoUpload(input, classIndex, topperIndex) {
  const file = input.files[0]; 
  if(!file) return;
  
  if(!validatePhoto(file)) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      uploadedPhotos[classIndex][topperIndex] = e.target.result;
      localStorage.setItem(`topperPhoto_${classIndex}_${topperIndex}`, e.target.result);
      
      // Update button to show success
      const uploadBtn = input.previousElementSibling;
      const originalHTML = uploadBtn.innerHTML;
      uploadBtn.innerHTML = '<i class="fas fa-check-circle"></i> Photo Uploaded!';
      uploadBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      
      showNotification('Photo uploaded successfully! ðŸŽ‰', 'success');
      showSuccessAnimation();
      
      // Add subtle animation to the upload button
      uploadBtn.style.transform = 'scale(1.05)';
      setTimeout(() => {
        uploadBtn.style.transform = 'scale(1)';
      }, 300);
      
      // Revert button after 2 seconds
      setTimeout(() => {
        uploadBtn.innerHTML = originalHTML;
        uploadBtn.style.background = 'var(--gradient-primary)';
      }, 2000);
      
    } catch(error) {
      console.error('Error uploading image:', error);
      showNotification('Error uploading photo. Please try again.', 'error');
    }
  };
  
  reader.onerror = function() {
    showNotification('Error uploading photo. Please try again.', 'error');
  };
  
  reader.readAsDataURL(file);
}

// Preview photo in modal
function previewPhoto(src) {
  if(src.includes('Student</text>')) return;
  document.getElementById('previewImage').src = src;
  document.getElementById('previewModal').style.display = 'flex';
}

// Close photo preview modal
function closePreview() {
  document.getElementById('previewModal').style.display = 'none';
}

// Show loading
function showLoading(text = 'Generating High-Quality Certificate...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loading').style.display = 'flex';
}

// Hide loading
function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// Load image helper
function loadImage(src) { 
  return new Promise((resolve, reject) => { 
    const img = new Image(); 
    img.crossOrigin = "anonymous"; 
    img.onload = () => resolve(img); 
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`)); 
    img.src = src; 
  }); 
}

// Function to draw soft ribbon patterns in background
function drawSoftRibbons(ctx, w, h) {
  ctx.save();
  ctx.globalAlpha = 0.03;
  
  const ribbonColors = ['#1e3a8a', '#fbbf24', '#059669', '#9333ea'];
  
  for (let i = 0; i < 8; i++) {
    const color = ribbonColors[i % ribbonColors.length];
    const y = (h / 8) * i + 100;
    
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(-100, y);
    ctx.bezierCurveTo(w/4, y - 50, w/2, y + 50, w + 100, y);
    ctx.bezierCurveTo(w/2, y + 150, w/4, y + 50, -100, y + 100);
    ctx.closePath();
    ctx.fill();
  }
  
  ctx.restore();
}

// Render certificate canvas WITHOUT photo border - HIGH QUALITY VERSION
async function renderCertificateCanvas(name, cls, mark, rank, photo) {
  // Double the resolution for high quality
  const w = 2400, h = 3200;
  const canvas = document.createElement("canvas"); 
  canvas.width = w; 
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  
  // Set high quality rendering
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  
  try {
    const bg = await loadImage(CERT_BG); 
    // Draw background with high quality
    ctx.drawImage(bg, 0, 0, w, h);
    
    drawSoftRibbons(ctx, w, h);
    
    const cx = w/2, cy = 1600, r = 400; // Adjusted for doubled resolution
    
    if(photo && !photo.includes('Student</text>')) {
      try {
        const img = await loadImage(photo);
        ctx.save(); 
        ctx.beginPath(); 
        ctx.arc(cx, cy, r, 0, Math.PI * 2); 
        ctx.clip();
        
        // Maintain aspect ratio and position properly
        const imgRatio = img.width / img.height;
        const circleRatio = (r * 2) / (r * 2);
        
        let drawWidth, drawHeight, drawX, drawY;
        
        if (imgRatio > circleRatio) {
          // Image is wider than circle
          drawHeight = r * 2;
          drawWidth = img.width * (drawHeight / img.height);
          drawX = cx - drawWidth / 2;
          drawY = cy - drawHeight / 2;
        } else {
          // Image is taller than circle
          drawWidth = r * 2;
          drawHeight = img.height * (drawWidth / img.width);
          drawX = cx - drawWidth / 2;
          drawY = cy - drawHeight / 2;
        }
        
        // Draw with anti-aliasing
        ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 5;
        
        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
        ctx.restore();
        
        // Remove shadow for text
        ctx.shadowBlur = 0;
        ctx.shadowColor = 'transparent';
        
      } catch(e) {
        console.error("Error loading student photo:", e);
        drawPlaceholderPhoto(ctx, cx, cy, r, name, rank);
      }
    } else {
      drawPlaceholderPhoto(ctx, cx, cy, r, name, rank);
    }
    
    // Text with better quality
    ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 4;
    
    // Use Poppins font for all text with higher resolution
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 112px "Poppins"'; // Doubled font size
    ctx.textAlign = 'center';
    ctx.fillText(name, cx, 2160); // Adjusted position
    
    ctx.fillStyle = '#1e3a8a';
    ctx.font = 'bold 72px "Poppins"'; // Doubled font size
    ctx.fillText(`Class: ${cls} | Marks: ${mark}`, cx, 2300); // Adjusted position
    
    const rankColor = rank === 'First' ? '#d4af37' : '#64748b';
    ctx.fillStyle = rankColor;
    ctx.font = 'bold 76px "Poppins"'; // Doubled font size
    const rankText = rank === 'First' ? 'Class Topper' : 'Second Place in Class';
    ctx.fillText(rankText, cx, 2420); // Adjusted position
    
    ctx.shadowBlur = 0;
    ctx.shadowColor = 'transparent';
    
    return canvas;
  } catch(error) {
    console.error("Error rendering certificate:", error);
    throw new Error("Failed to load certificate background");
  }
}

// Draw placeholder photo WITHOUT border
function drawPlaceholderPhoto(ctx, cx, cy, r, name, rank) {
  const solidColor = rank === 'First' ? '#fffbeb' : '#f8fafc';
  
  ctx.fillStyle = solidColor;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = rank === 'First' ? '#d4af37' : '#64748b';
  ctx.font = 'bold 48px "Font Awesome 6 Free"';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ðŸ‘¨â€ðŸŽ“', cx, cy);
}

// Preview certificate
async function previewCertificate(name, cls, mark, rank, photo) {
  try {
    showLoading();
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    hideLoading();
    
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = previewCanvas.getContext('2d');
    
    // Set preview canvas to high resolution but display smaller
    previewCanvas.width = 1600;
    previewCanvas.height = 2134;
    
    // Enable high quality scaling
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    
    // Draw the high-res canvas scaled down for preview
    ctx.drawImage(canvas, 0, 0, 2400, 3200, 0, 0, 1600, 2134);
    
    document.getElementById('certificatePreview').style.display = 'block';
    
    setTimeout(() => {
      const existingButtons = document.querySelector('.preview-buttons');
      if (existingButtons) existingButtons.remove();
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'preview-buttons';
      
      buttonContainer.innerHTML = `
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'png')">
          <i class="fas fa-download"></i> Download High-Quality PNG
        </button>
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'pdf')">
          <i class="fas fa-file-pdf"></i> Download High-Quality PDF
        </button>
      `;
      
      document.getElementById('certificatePreview').appendChild(buttonContainer);
    }, 100);
    
  } catch(error) {
    hideLoading();
    console.error("Error previewing certificate:", error);
    showNotification("Error previewing certificate. Please try again.", 'error');
  }
}

// Close certificate preview
function closeCertificatePreview() {
  document.getElementById('certificatePreview').style.display = 'none';
  const buttons = document.querySelector('.preview-buttons');
  if (buttons) buttons.remove();
}

// Download certificate - HIGH QUALITY VERSION
async function downloadCertificate(name, cls, mark, rank, photo, type) {
  try {
    showLoading(type === 'png' ? 'Generating High-Quality PNG...' : 'Generating High-Quality PDF...');
    
    const sound = document.getElementById("certSound"); 
    sound.currentTime = 0; 
    sound.play().catch(e => console.log("Audio play failed:", e));
    
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    
    // Create a final canvas with white background as fallback
    const finalCanvas = document.createElement("canvas");
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    const finalCtx = finalCanvas.getContext('2d');
    
    // Set high quality rendering
    finalCtx.imageSmoothingEnabled = true;
    finalCtx.imageSmoothingQuality = 'high';
    
    // Fill with white background first to ensure white background
    finalCtx.fillStyle = '#ffffff';
    finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    
    // Draw the certificate on top
    finalCtx.drawImage(canvas, 0, 0);
    
    // Get image data URL with highest quality
    const img = finalCanvas.toDataURL("image/png", 1.0); // 1.0 = maximum quality
    
    // Enhanced confetti
    confetti({
      particleCount: 200,
      spread: 150,
      origin: { y: 0.6 },
      colors: rank === 'First' ? ['#fbbf24', '#f59e0b', '#d97706', '#ffffff'] : ['#c0c0c0', '#94a3b8', '#64748b', '#ffffff']
    });
    
    setTimeout(() => {
      confetti({
        particleCount: 100,
        angle: 60,
        spread: 80,
        origin: { x: 0 },
        colors: rank === 'First' ? ['#fbbf24', '#f59e0b'] : ['#c0c0c0', '#94a3b8']
      });
    }, 250);
    
    setTimeout(() => {
      confetti({
        particleCount: 100,
        angle: 120,
        spread: 80,
        origin: { x: 1 },
        colors: rank === 'First' ? ['#fbbf24', '#f59e0b'] : ['#c0c0c0', '#94a3b8']
      });
    }, 500);
    
    certCount++;
    localStorage.setItem('certCount', certCount);
    
    const fileName = `Noorussalam_Class${cls}_${rank.replace(' ', '_')}_${name.replace(/\s+/g, '_')}_HQ`;
    
    if(type === "png") {
      const a = document.createElement("a"); 
      a.href = img; 
      a.download = `${fileName}.png`; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification(`ðŸŽ‰ High-quality certificate for ${name} downloaded successfully!`, 'success');
      showSuccessAnimation();
    } else if(type === "pdf") {
      const { jsPDF } = window.jspdf; 
      const pdf = new jsPDF({
        orientation: "portrait", 
        unit: "px", 
        format: [2400, 3200],
        compress: false // Disable compression for better quality
      });
      
      // Add image with high quality
      pdf.addImage(img, "PNG", 0, 0, 2400, 3200, '', 'FAST'); 
      pdf.save(`${fileName}.pdf`);
      showNotification(`ðŸ“„ High-quality PDF certificate for ${name} downloaded!`, 'success');
      showSuccessAnimation();
    }
    
    hideLoading();
    
  } catch(error) {
    hideLoading();
    console.error("Error generating certificate:", error);
    showNotification("Error generating certificate. Please try again.", 'error');
  }
}

// Clear all uploaded photos
function clearAllPhotos() {
  if(confirm("Are you sure you want to clear all uploaded photos? This action cannot be undone.")) {
    classesData.forEach((cls, classIndex) => {
      cls.toppers.forEach((topper, topperIndex) => {
        localStorage.removeItem(`topperPhoto_${classIndex}_${topperIndex}`);
        uploadedPhotos[classIndex][topperIndex] = null;
        
        // Reset upload button
        const uploadBtn = document.querySelector(`#file-${classIndex}-${topperIndex}`)?.previousElementSibling;
        if (uploadBtn) {
          uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Photo';
          uploadBtn.style.background = 'var(--gradient-primary)';
        }
      });
    });
    showNotification('All photos cleared successfully!', 'success');
  }
}

// Close modal when clicking outside
document.getElementById('previewModal').addEventListener('click', function(e) {
  if(e.target === this) closePreview();
});

document.getElementById('certificatePreview').addEventListener('click', function(e) {
  if(e.target === this) closeCertificatePreview();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if(e.key === 'Escape') {
    closePreview();
    closeCertificatePreview();
  } else if (e.key === 'Enter' && document.getElementById('classSearch').matches(':focus')) {
    e.preventDefault();
    searchClasses();
  } else if (e.key === '/' && !document.getElementById('classSearch').matches(':focus')) {
    e.preventDefault();
    document.getElementById('classSearch').focus();
  }
});

// Initialize when page loads
window.addEventListener('load', function() {
  // Test background image
  const testImg = new Image();
  testImg.onload = function() {
    console.log('Certificate background loaded successfully');
  };
  testImg.onerror = function() {
    showNotification('Note: Using enhanced certificate design', 'info');
  };
  testImg.src = CERT_BG;
  
  // Load class cards
  loadClassCards();
  
  // Create class filter buttons
  createClassFilterButtons();
  
  // Focus on search input
  setTimeout(() => {
    document.getElementById('classSearch').focus();
  }, 500);
  
  // Add floating elements dynamically
  const floatingContainer = document.querySelector('.floating-elements');
  for (let i = 0; i < 5; i++) {
    const element = document.createElement('div');
    element.className = 'floating-element';
    const size = Math.random() * 60 + 40;
    const top = Math.random() * 80 + 10;
    const left = Math.random() * 80 + 10;
    const delay = Math.random() * 20;
    element.style.cssText = `
      width: ${size}px;
      height: ${size}px;
      top: ${top}%;
      left: ${left}%;
      background: linear-gradient(135deg, rgba(${i % 2 ? '30, 58, 138' : '251, 191, 36'}, 0.05) 0%, rgba(${i % 3 ? '59, 130, 246' : '5, 150, 105'}, 0.03) 100%);
      animation-delay: ${delay}s;
    `;
    floatingContainer.appendChild(element);
  }
  
  // Add subtle entrance animation to cards
  setTimeout(() => {
    document.querySelectorAll('.class-card').forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      setTimeout(() => {
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 100);
    });
  }, 300);
});
</script>
</body>
</html>
