<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Class Topper Certificate Generator — Noorussalam Madrasa</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f4ff 50%, #f0f9ff 100%);
  color: #073045;
  padding: 20px;
  min-height: 100vh;
}

.wrap {
  max-width: 1400px;
  margin: 0 auto;
}

/* Header Section */
header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 20px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,249,255,0.95) 100%);
  border-radius: 25px;
  box-shadow: 0 15px 35px rgba(2, 6, 23, 0.08);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(13, 110, 253, 0.1);
}

header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, #0d6efd, #ffd700, #10b981);
}

.logo-container {
  margin-bottom: 20px;
}

.logo {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #0d6efd, #0b5ed7);
  color: white;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  font-size: 32px;
  margin-bottom: 15px;
  box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3);
}

header h1 {
  color: #073045;
  margin: 10px 0 5px;
  font-size: 38px;
  font-weight: 800;
  background: linear-gradient(90deg, #0d6efd 0%, #ffd700 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 0.5px;
}

.subtitle {
  color: #0b3b50;
  font-size: 18px;
  margin: 0 0 15px;
  font-weight: 500;
  opacity: 0.9;
}

.tagline {
  color: #0d6efd;
  font-size: 16px;
  margin: 0;
  font-weight: 600;
  padding: 10px 20px;
  background: rgba(13, 110, 253, 0.08);
  border-radius: 30px;
  display: inline-block;
}

/* Stats Section */
.stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 25px 0 30px;
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
  padding: 15px 25px;
  background: white;
  border-radius: 15px;
  min-width: 140px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(13, 110, 253, 0.1);
}

.stat-number {
  font-size: 32px;
  font-weight: 800;
  color: #0d6efd;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  color: #073045;
  opacity: 0.8;
}

/* Instructions */
.instructions {
  background: rgba(255, 215, 0, 0.08);
  border-radius: 18px;
  padding: 20px 25px;
  margin: 25px auto 30px;
  max-width: 900px;
  border-left: 5px solid #ffd700;
  display: flex;
  align-items: flex-start;
  gap: 20px;
}

.instructions-icon {
  font-size: 24px;
  color: #ffd700;
  background: rgba(255, 215, 0, 0.15);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.instructions-content h3 {
  margin: 0 0 10px;
  color: #073045;
  font-size: 18px;
}

.instructions-list {
  margin: 0;
  padding: 0;
  list-style: none;
}

.instructions-list li {
  margin: 8px 0;
  color: #0a3b45;
  display: flex;
  align-items: center;
  gap: 10px;
}

.instructions-list i {
  color: #0d6efd;
  font-size: 14px;
}

/* Class Cards Section */
.classes-title {
  text-align: center;
  margin: 40px 0 25px;
  font-size: 28px;
  font-weight: 700;
  color: #073045;
  position: relative;
  display: inline-block;
  left: 50%;
  transform: translateX(-50%);
  padding: 0 20px;
}

.classes-title::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 20px;
  right: 20px;
  height: 3px;
  background: linear-gradient(90deg, #0d6efd, #ffd700);
  border-radius: 3px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 25px;
  margin-bottom: 50px;
}

.class-card {
  background: white;
  border-radius: 20px;
  padding: 25px;
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
  border: 2px solid rgba(13, 110, 253, 0.1);
  position: relative;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  overflow: hidden;
}

.class-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 40px rgba(2, 6, 23, 0.12);
  border-color: rgba(13, 110, 253, 0.3);
}

.class-header {
  text-align: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid rgba(255, 215, 0, 0.3);
}

.class-header h3 {
  margin: 0;
  font-size: 22px;
  color: #0d6efd;
  font-weight: 700;
}

/* Topper Cards */
.topper-card {
  background: #f8fbff;
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(13, 110, 253, 0.1);
  position: relative;
}

.topper-card:last-child {
  margin-bottom: 0;
}

.topper-card.first {
  border-left: 5px solid #ffd700;
  background: linear-gradient(to right, rgba(255, 215, 0, 0.05), #f8fbff);
}

.topper-card.second {
  border-left: 5px solid #6c757d;
  background: linear-gradient(to right, rgba(108, 117, 125, 0.05), #f8fbff);
}

.rank-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 18px;
  color: white;
  z-index: 2;
}

.rank-badge.first {
  background: linear-gradient(135deg, #ffd700, #ffcc00);
  color: #000;
  box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
  border: 2px solid white;
}

.rank-badge.second {
  background: linear-gradient(135deg, #6c757d, #495057);
  box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
  border: 2px solid white;
}

/* INCREASED PHOTO SIZE WITH STYLISH BORDER */
.photo-container {
  width: 160px; /* Increased from 140px */
  height: 160px; /* Increased from 140px */
  margin: 0 auto 15px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.photo-frame {
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Stylish Border Effect */
.photo-border {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(45deg, 
    #0d6efd 0%, 
    #0b5ed7 25%, 
    #0a58ca 50%, 
    #0952c3 75%, 
    #084bb5 100%);
  padding: 6px;
  z-index: 1;
  box-shadow: 
    0 8px 25px rgba(13, 110, 253, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo-border.first {
  background: linear-gradient(45deg, 
    #ffd700 0%, 
    #ffcc00 25%, 
    #ffc107 50%, 
    #ffb300 75%, 
    #ffa500 100%);
  box-shadow: 
    0 8px 25px rgba(255, 215, 0, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo-border.second {
  background: linear-gradient(45deg, 
    #6c757d 0%, 
    #5a6268 25%, 
    #495057 50%, 
    #343a40 75%, 
    #212529 100%);
  box-shadow: 
    0 8px 25px rgba(108, 117, 125, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo {
  width: calc(100% - 12px);
  height: calc(100% - 12px);
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  z-index: 2;
  background: #f6fbff;
  box-shadow: 
    inset 0 0 10px rgba(0, 0, 0, 0.1),
    0 0 0 3px white;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Inner decorative circle */
.photo::before {
  content: "";
  position: absolute;
  top: -3px;
  left: -3px;
  right: -3px;
  bottom: -3px;
  border-radius: 50%;
  background: linear-gradient(45deg, 
    transparent 0%, 
    rgba(255, 255, 255, 0.6) 50%, 
    transparent 100%);
  z-index: -1;
  opacity: 0.3;
}

.upload-btn {
  display: block;
  margin: 15px auto 15px; /* Increased margin */
  padding: 10px 20px; /* Increased padding */
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 15px rgba(13, 110, 253, 0.25);
  position: relative;
  overflow: hidden;
}

.upload-btn:hover {
  background: #0b5ed7;
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(13, 110, 253, 0.4);
}

.upload-btn::after {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent 30%,
    rgba(255, 255, 255, 0.1) 50%,
    transparent 70%
  );
  transform: rotate(45deg);
  transition: all 0.5s ease;
  opacity: 0;
}

.upload-btn:hover::after {
  opacity: 1;
  transform: rotate(45deg) translate(10%, 10%);
}

.student-name {
  text-align: center;
  font-weight: 700;
  margin: 15px 0 8px; /* Increased margin */
  font-size: 22px; /* Larger font */
  color: #073045;
  position: relative;
  padding-bottom: 8px;
}

.student-name::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, #0d6efd, #ffd700);
  border-radius: 1px;
}

.student-meta {
  text-align: center;
  color: #0a3b45;
  font-weight: 600;
  margin-top: 8px;
  font-size: 16px; /* Larger font */
  padding: 10px 18px; /* Increased padding */
  background: rgba(13, 110, 253, 0.05);
  border-radius: 25px;
  display: inline-block;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid rgba(13, 110, 253, 0.1);
}

.rank-label {
  text-align: center;
  color: #0d6efd;
  font-weight: 700;
  margin-top: 8px;
  font-size: 16px; /* Larger font */
  text-transform: uppercase;
  letter-spacing: 0.8px;
  position: relative;
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  background: rgba(13, 110, 253, 0.08);
}

.rank-label.first {
  color: #d4af37;
  background: rgba(255, 215, 0, 0.08);
}

.rank-label.second {
  color: #6c757d;
  background: rgba(108, 117, 125, 0.08);
}

/* ONLY PREVIEW BUTTON - REMOVED PDF AND PRINT BUTTONS */
.btns {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.btn {
  padding: 14px 40px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 16px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-width: 200px;
  position: relative;
  overflow: hidden;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.btn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  transition: left 0.6s ease;
}

.btn:hover::after {
  left: 100%;
}

.btn-preview {
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  color: #fff;
  border: 1px solid rgba(13, 110, 253, 0.3);
  box-shadow: 0 6px 20px rgba(13, 110, 253, 0.25);
}

.btn-preview:hover {
  box-shadow: 0 10px 30px rgba(13, 110, 253, 0.4);
}

/* Footer */
footer {
  text-align: center;
  color: #345;
  margin-top: 40px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 20px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
}

footer p {
  margin: 8px 0;
}

.cert-count {
  font-weight: 700;
  color: #0d6efd;
  font-size: 18px;
}

/* Modal */
#previewModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

#previewModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
}

#previewModal .close {
  position: absolute;
  top: 25px;
  right: 35px;
  font-size: 32px;
  color: #fff;
  cursor: pointer;
  font-weight: 700;
  background: rgba(0, 0, 0, 0.5);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

#previewModal .close:hover {
  background: rgba(255, 0, 0, 0.7);
  transform: rotate(90deg);
}

/* Clear All Button */
.clear-all-container {
  text-align: center;
  margin: 20px 0 40px;
}

#clearAllBtn {
  padding: 14px 30px;
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: 600;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

#clearAllBtn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
}

#clearAllBtn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  transition: left 0.5s ease;
}

#clearAllBtn:hover::after {
  left: 100%;
}

/* Responsive */
@media(max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .stats {
    gap: 15px;
  }
  
  .stat-item {
    min-width: 120px;
    padding: 12px 20px;
  }
  
  header h1 {
    font-size: 30px;
  }
  
  .photo-container {
    width: 140px;
    height: 140px;
  }
  
  .btn {
    min-width: 180px;
    padding: 12px 30px;
  }
}

@media(max-width: 480px) {
  .photo-container {
    width: 130px;
    height: 130px;
  }
  
  .btn {
    min-width: 160px;
    padding: 12px 25px;
    font-size: 15px;
  }
}

/* Certificate Preview */
#certificatePreview {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  overflow: auto;
  padding: 20px;
}

.certificate-canvas {
  background: white;
  width: 800px;
  max-width: 90%;
  margin: 30px auto;
  border-radius: 10px;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.3);
  position: relative;
}

.close-preview {
  position: fixed;
  top: 20px;
  right: 30px;
  font-size: 36px;
  color: white;
  cursor: pointer;
  background: rgba(0, 0, 0, 0.5);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.close-preview:hover {
  background: rgba(255, 0, 0, 0.7);
  transform: rotate(90deg);
}

/* Preview buttons - Now only Download PNG and Download PDF */
.preview-buttons {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10001;
  flex-wrap: wrap;
  justify-content: center;
}

.preview-buttons button {
  padding: 12px 25px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-size: 14px;
}

.preview-buttons button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

/* Loading Animation */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10002;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: white;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #0d6efd;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Header Section -->
  <header>
    <div class="logo-container">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <h1>NOORUSSALAM MADRASA</h1>
      <p class="subtitle">Annual Examination Results - Academic Year 2025-2026</p>
      <p class="tagline">Celebrating Academic Excellence & Achievement</p>
    </div>
    
    <!-- Stats Section -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number">10</div>
        <div class="stat-label">Classes</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">20</div>
        <div class="stat-label">Top Students</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">100%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="certCount">0</div>
        <div class="stat-label">Certificates Generated</div>
      </div>
    </div>
    
    <!-- Instructions -->
    <div class="instructions">
      <div class="instructions-icon">
        <i class="fas fa-lightbulb"></i>
      </div>
      <div class="instructions-content">
        <h3>How to Generate Certificates</h3>
        <ul class="instructions-list">
          <li><i class="fas fa-camera"></i> Upload high-quality photos for best results</li>
          <li><i class="fas fa-eye"></i> Preview the certificate before downloading</li>
          <li><i class="fas fa-download"></i> Download as PNG or PDF from preview</li>
          <li><i class="fas fa-trash-alt"></i> Clear all photos if needed</li>
        </ul>
      </div>
    </div>
  </header>
  
  <!-- Classes Section -->
  <h2 class="classes-title">Class Toppers & Second Place</h2>
  
  <div id="grid" class="grid"></div>
  
  <!-- Clear All Button -->
  <div class="clear-all-container">
    <button id="clearAllBtn" onclick="clearAllPhotos()">
      <i class="fas fa-trash-alt"></i> Clear All Uploaded Photos
    </button>
  </div>
  
  <!-- Footer -->
  <footer>
    <p>© 2025-2026 Noorussalam Madrasa — Kambippalam-Kerala Estate</p>
    <p>Certificates generated: <span class="cert-count" id="certCountFooter">0</span></p>
    <p>Designed with <i class="fas fa-heart" style="color:#dc3545;"></i> for celebrating student achievements</p>
  </footer>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p>Generating Certificate...</p>
</div>

<!-- Certificate Preview Modal -->
<div id="certificatePreview">
  <div class="close-preview" onclick="closeCertificatePreview()">×</div>
  <canvas id="previewCanvas" class="certificate-canvas"></canvas>
</div>

<!-- Photo Preview Modal -->
<div id="previewModal">
  <span class="close" onclick="closePreview()">×</span>
  <img id="previewImage" src="" alt="Photo Preview">
</div>

<!-- Sound -->
<audio id="certSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>

<script>
// Certificate background image URL
const CERT_BG = "https://i.ibb.co/JRqqvrm0/TOPPER.jpg";

// Class data with two toppers per class (First and Second)
const classesData = [
  { 
    class: "1", 
    toppers: [
      { name: "Suhail P", mark: "498 / 500", rank: "First" },
      { name: "Minhaj P", mark: "495 / 500", rank: "Second" }
    ]
  },
  { 
    class: "2", 
    toppers: [
      { name: "Muhammed Shahid", mark: "493 / 500", rank: "First" },
      { name: "Ashmil T", mark: "490 / 500", rank: "Second" }
    ]
  },
  { 
    class: "3", 
    toppers: [
      { name: "Muhammed Hadi K", mark: "487 / 500", rank: "First" },
      { name: "Danish T", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "4", 
    toppers: [
      { name: "Faris P", mark: "489 / 500", rank: "First" },
      { name: "Rifaee P", mark: "486 / 500", rank: "Second" }
    ]
  },
  { 
    class: "5", 
    toppers: [
      { name: "Shamil N", mark: "491 / 500", rank: "First" },
      { name: "Nida Mol", mark: "488 / 500", rank: "Second" }
    ]
  },
  { 
    class: "6", 
    toppers: [
      { name: "Hana M", mark: "480 / 500", rank: "First" },
      { name: "Riya T", mark: "478 / 500", rank: "Second" }
    ]
  },
  { 
    class: "7", 
    toppers: [
      { name: "Riyas M", mark: "485 / 500", rank: "First" },
      { name: "Riya Mol", mark: "482 / 500", rank: "Second" }
    ]
  },
  { 
    class: "8", 
    toppers: [
      { name: "Zainab K", mark: "492 / 500", rank: "First" },
      { name: "Muhsin P", mark: "489 / 500", rank: "Second" }
    ]
  },
  { 
    class: "9", 
    toppers: [
      { name: "Thaj T", mark: "488 / 500", rank: "First" },
      { name: "Sinan P", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "10", 
    toppers: [
      { name: "Saniya F", mark: "495 / 500", rank: "First" },
      { name: "Asna K", mark: "492 / 500", rank: "Second" }
    ]
  }
];

// Initialize uploaded photos array from localStorage
const uploadedPhotos = {};
classesData.forEach((cls, classIndex) => {
  uploadedPhotos[classIndex] = [];
  cls.toppers.forEach((topper, topperIndex) => {
    const saved = localStorage.getItem(`topperPhoto_${classIndex}_${topperIndex}`);
    uploadedPhotos[classIndex][topperIndex] = saved || null;
  });
});

// Track certificate generation count
let certCount = parseInt(localStorage.getItem('certCount') || '0');
updateCertCount();

// Helper functions
function escapeHtml(s){ 
  return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

function placeholderDataURL(){ 
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#0d6efd;stop-opacity:1" />
        <stop offset="50%" style="stop-color:#0b5ed7;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#084298;stop-opacity:1" />
      </linearGradient>
      <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#eef9ff;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#cfeeff;stop-opacity:1" />
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#grad2)"/>
    <circle cx="250" cy="200" r="135" fill="url(#grad1)" opacity="0.1"/>
    <circle cx="250" cy="200" r="120" fill="#cfeeff"/>
    <text x="250" y="200" text-anchor="middle" dy=".3em" font-family="Arial" font-size="32" fill="#0d6efd" font-weight="bold">Student</text>
    <text x="250" y="250" text-anchor="middle" dy=".3em" font-family="Arial" font-size="24" fill="#073045" font-weight="bold">Photo</text>
    <text x="250" y="400" text-anchor="middle" dy=".3em" font-family="Arial" font-size="18" fill="#0d6efd">Click "Upload Photo"</text>
    <text x="250" y="430" text-anchor="middle" dy=".3em" font-family="Arial" font-size="18" fill="#073045">to add student image</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function updateCertCount() {
  document.getElementById('certCount').textContent = certCount;
  document.getElementById('certCountFooter').textContent = certCount;
}

// Show notification
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#dc3545' : '#0d6efd'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => notification.style.transform = 'translateX(0)', 10);
  
  // Remove after 3 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(150%)';
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

// Load class cards
const grid = document.getElementById('grid');
classesData.forEach((cls, classIndex) => {
  const card = document.createElement('div');
  card.className = 'class-card';
  
  let toppersHTML = '';
  cls.toppers.forEach((topper, topperIndex) => {
    const photoURL = uploadedPhotos[classIndex][topperIndex] || placeholderDataURL();
    const isFirst = topper.rank === 'First';
    
    toppersHTML += `
      <div class="topper-card ${isFirst ? 'first' : 'second'}">
        <div class="rank-badge ${isFirst ? 'first' : 'second'}">
          ${isFirst ? '1st' : '2nd'}
        </div>
        <div class="photo-container">
          <div class="photo-frame">
            <div class="photo-border ${isFirst ? 'first' : 'second'}"></div>
            <div class="photo">
              <img src="${photoURL}" alt="${escapeHtml(topper.name)}" 
                   onclick="previewPhoto('${photoURL.replace(/'/g, "\\'")}')">
            </div>
          </div>
        </div>
        <button class="upload-btn" onclick="document.getElementById('file-${classIndex}-${topperIndex}').click()">
          <i class="fas fa-upload"></i> Upload Photo
        </button>
        <input type="file" id="file-${classIndex}-${topperIndex}" accept="image/*" style="display:none" 
               onchange="handlePhotoUpload(this, ${classIndex}, ${topperIndex})">
        <div class="student-name">${escapeHtml(topper.name)}</div>
        <div class="rank-label ${isFirst ? 'first' : 'second'}">${topper.rank} Place in Class</div>
        <div class="student-meta">Marks: ${escapeHtml(topper.mark)}</div>
        <div class="btns">
          <button class="btn btn-preview" onclick="previewCertificate('${topper.name}','${cls.class}','${topper.mark}', '${topper.rank}', uploadedPhotos[${classIndex}][${topperIndex}] || '${photoURL}')">
            <i class="fas fa-eye"></i> Preview Certificate
          </button>
        </div>
      </div>
    `;
  });
  
  card.innerHTML = `
    <div class="class-header">
      <h3>Class ${escapeHtml(cls.class)}</h3>
    </div>
    ${toppersHTML}
  `;
  
  grid.appendChild(card);
});

// Handle photo upload
function handlePhotoUpload(input, classIndex, topperIndex) {
  const file = input.files[0]; 
  if(!file) return;
  
  // Check file size (max 10MB for larger photos)
  if(file.size > 10 * 1024 * 1024) {
    showNotification('File too large! Please choose an image under 10MB.', 'error');
    return;
  }
  
  // Check file type
  if(!file.type.match('image.*')) {
    showNotification('Please select an image file (JPG, PNG, etc.)', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedPhotos[classIndex][topperIndex] = e.target.result;
    localStorage.setItem(`topperPhoto_${classIndex}_${topperIndex}`, e.target.result);
    
    // Update the photo in the card
    const img = input.closest('.photo-frame').querySelector('img');
    if(img) img.src = e.target.result;
    
    showNotification('Photo uploaded successfully!', 'success');
  };
  
  reader.onerror = function() {
    showNotification('Error uploading photo. Please try again.', 'error');
  };
  
  reader.readAsDataURL(file);
}

// Preview photo in modal
function previewPhoto(src) {
  if(src.includes('Student</text>')) return; // Don't open placeholder
  document.getElementById('previewImage').src = src;
  document.getElementById('previewModal').style.display = 'flex';
}

// Close photo preview modal
function closePreview() {
  document.getElementById('previewModal').style.display = 'none';
}

// Show loading
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
}

// Hide loading
function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// Load image helper
function loadImage(src) { 
  return new Promise((resolve, reject) => { 
    const img = new Image(); 
    img.crossOrigin = "anonymous"; 
    img.onload = () => resolve(img); 
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`)); 
    img.src = src; 
  }); 
}

// Render certificate canvas
async function renderCertificateCanvas(name, cls, mark, rank, photo) {
  const w = 1200, h = 1600;
  const canvas = document.createElement("canvas"); 
  canvas.width = w; 
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  
  try {
    // Draw background from your image URL
    const bg = await loadImage(CERT_BG); 
    ctx.drawImage(bg, 0, 0, w, h);
    
    // Add student photo - LARGER PHOTO SIZE WITH STYLISH BORDER
    const cx = w/2, cy = 800, r = 200; // Increased from 180 to 200
    
    // Draw stylish border for certificate photo
    const borderColor = rank === 'First' ? '#ffd700' : '#6c757d';
    const gradient = ctx.createLinearGradient(cx - r - 10, cy - r - 10, cx + r + 10, cy + r + 10);
    
    if (rank === 'First') {
      gradient.addColorStop(0, '#ffd700');
      gradient.addColorStop(0.5, '#ffcc00');
      gradient.addColorStop(1, '#ffa500');
    } else {
      gradient.addColorStop(0, '#6c757d');
      gradient.addColorStop(0.5, '#495057');
      gradient.addColorStop(1, '#343a40');
    }
    
    // Draw outer border
    ctx.beginPath();
    ctx.arc(cx, cy, r + 12, 0, Math.PI * 2);
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Draw inner white border
    ctx.beginPath();
    ctx.arc(cx, cy, r + 8, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
    ctx.fill();
    
    // Draw the photo if available
    if(photo && !photo.includes('Student</text>')) {
      try {
        const img = await loadImage(photo);
        ctx.save(); 
        ctx.beginPath(); 
        ctx.arc(cx, cy, r, 0, Math.PI * 2); 
        ctx.clip();
        
        const scale = Math.max(r * 2 / img.width, r * 2 / img.height);
        const x = cx - (img.width * scale) / 2;
        const y = cy - (img.height * scale) / 2;
        
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        ctx.restore();
      } catch(e) {
        console.error("Error loading student photo:", e);
        drawPlaceholderPhoto(ctx, cx, cy, r, name);
      }
    } else {
      drawPlaceholderPhoto(ctx, cx, cy, r, name);
    }
    
    // Draw student name
    ctx.fillStyle = '#073045';
    ctx.font = 'bold 56px "Poppins"';
    ctx.textAlign = 'center';
    ctx.fillText(name, cx, 1050);
    
    // Draw class and marks
    ctx.fillStyle = '#0d6efd';
    ctx.font = 'bold 36px "Poppins"';
    ctx.fillText(`Class: ${cls} | Marks: ${mark}`, cx, 1120);
    
    // Draw rank text
    ctx.fillStyle = rank === 'First' ? '#d4af37' : '#6c757d';
    ctx.font = 'italic 32px "Poppins"';
    const rankText = rank === 'First' ? 'CLASS TOPPER' : 'SECOND PLACE IN CLASS';
    ctx.fillText(rankText, cx, 1180);
    
    return canvas;
  } catch(error) {
    console.error("Error rendering certificate:", error);
    throw new Error("Failed to load certificate background");
  }
}

// Draw placeholder photo - LARGER
function drawPlaceholderPhoto(ctx, cx, cy, r, name) {
  ctx.fillStyle = '#eef9ff';
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#0d6efd';
  ctx.font = 'bold 34px "Poppins"';
  ctx.textAlign = 'center';
  ctx.fillText('STUDENT', cx, cy - 15);
  ctx.font = '28px "Poppins"';
  ctx.fillText('PHOTO', cx, cy + 35);
}

// Preview certificate
async function previewCertificate(name, cls, mark, rank, photo) {
  try {
    showLoading();
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    hideLoading();
    
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = previewCanvas.getContext('2d');
    
    // Set canvas size for preview
    previewCanvas.width = 800;
    previewCanvas.height = 1067;
    
    // Draw scaled certificate
    ctx.drawImage(canvas, 0, 0, 1200, 1600, 0, 0, 800, 1067);
    
    // Show preview
    document.getElementById('certificatePreview').style.display = 'block';
    
    // Add download buttons to preview
    setTimeout(() => {
      const existingButtons = document.querySelector('.preview-buttons');
      if (existingButtons) existingButtons.remove();
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'preview-buttons';
      
      buttonContainer.innerHTML = `
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'png')" 
                style="background:#ffd700; color:#000;">
          <i class="fas fa-download"></i> Download PNG
        </button>
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'pdf')" 
                style="background:#0d6efd; color:white;">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      `;
      
      document.getElementById('certificatePreview').appendChild(buttonContainer);
    }, 100);
    
  } catch(error) {
    hideLoading();
    console.error("Error previewing certificate:", error);
    showNotification("Error previewing certificate. Please try again.", 'error');
  }
}

// Close certificate preview
function closeCertificatePreview() {
  document.getElementById('certificatePreview').style.display = 'none';
  const buttons = document.querySelector('.preview-buttons');
  if (buttons) buttons.remove();
}

// Download certificate
async function downloadCertificate(name, cls, mark, rank, photo, type) {
  try {
    showLoading();
    
    // Play sound
    const sound = document.getElementById("certSound"); 
    sound.currentTime = 0; 
    sound.play().catch(e => console.log("Audio play failed:", e));
    
    // Render certificate
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    const img = canvas.toDataURL("image/png");
    
    // Confetti celebration
    confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 },
      colors: rank === 'First' ? ['#ffd700', '#0d6efd', '#fff'] : ['#6c757d', '#0d6efd', '#fff']
    });
    
    // Update certificate count
    certCount++;
    localStorage.setItem('certCount', certCount);
    updateCertCount();
    
    // Generate output based on type
    const fileName = `Noorussalam_Class${cls}_${rank.replace(' ', '_')}_${name.replace(/\s+/g, '_')}`;
    
    if(type === "png") {
      const a = document.createElement("a"); 
      a.href = img; 
      a.download = `${fileName}.png`; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification(`PNG certificate for ${name} downloaded!`, 'success');
    } else if(type === "pdf") {
      const { jsPDF } = window.jspdf; 
      const pdf = new jsPDF({orientation: "portrait", unit: "px", format: [1200, 1600]});
      pdf.addImage(img, "PNG", 0, 0, 1200, 1600); 
      pdf.save(`${fileName}.pdf`);
      showNotification(`PDF certificate for ${name} downloaded!`, 'success');
    }
    
    hideLoading();
    
  } catch(error) {
    hideLoading();
    console.error("Error generating certificate:", error);
    showNotification("Error generating certificate. Please try again.", 'error');
  }
}

// Clear all uploaded photos
function clearAllPhotos() {
  if(confirm("Are you sure you want to clear all uploaded photos? This action cannot be undone.")) {
    classesData.forEach((cls, classIndex) => {
      cls.toppers.forEach((topper, topperIndex) => {
        localStorage.removeItem(`topperPhoto_${classIndex}_${topperIndex}`);
        uploadedPhotos[classIndex][topperIndex] = null;
        
        const img = document.querySelector(`#file-${classIndex}-${topperIndex}`)?.closest('.photo-frame')?.querySelector('img');
        if(img) img.src = placeholderDataURL();
      });
    });
    showNotification('All photos cleared successfully!', 'success');
  }
}

// Close modal when clicking outside the image
document.getElementById('previewModal').addEventListener('click', function(e) {
  if(e.target === this) closePreview();
});

document.getElementById('certificatePreview').addEventListener('click', function(e) {
  if(e.target === this) closeCertificatePreview();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if(e.key === 'Escape') {
    closePreview();
    closeCertificatePreview();
  }
});

// Initialize when page loads
window.addEventListener('load', function() {
  // Test if background image loads
  const testImg = new Image();
  testImg.onload = function() {
    console.log('Certificate background loaded successfully');
  };
  testImg.onerror = function() {
    showNotification('Note: Using fallback certificate design', 'info');
  };
  testImg.src = CERT_BG;
});
</script>
</body>
</html>
