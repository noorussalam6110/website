<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title> Class Toppers | Noorussalam Madrasa</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --primary: #1e3a8a;
  --secondary: #fbbf24;
  --accent: #059669;
  --light: #f0f9ff;
  --dark: #0f172a;
  --white: #ffffff;
  --gray: #64748b;
  --gold: #d4af37;
  --silver: #c0c0c0;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --gradient-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
  --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  --gradient-accent: linear-gradient(135deg, #059669 0%, #10b981 100%);
  --gradient-gold: linear-gradient(135deg, #fbbf24, #d4af37, #f59e0b);
  --gradient-silver: linear-gradient(135deg, #c0c0c0, #94a3b8, #64748b);
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}

body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  color: var(--dark);
  min-height: 100vh;
  padding: 15px;
  position: relative;
  overflow-x: hidden;
  font-size: 14px;
}

.wrap {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
}

/* Header Section */
.header {
  text-align: center;
  margin-bottom: 30px;
  padding: 30px 25px;
  background: var(--white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
}

.header-content {
  position: relative;
  z-index: 2;
}

.header h1 {
  font-family: "Poppins", sans-serif;
  font-size: 32px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 8px 0;
}

.subtitle {
  font-size: 16px;
  color: var(--primary);
  font-weight: 500;
  margin: 8px 0;
}

.tagline {
  display: inline-block;
  padding: 10px 24px;
  background: var(--gradient-secondary);
  color: var(--dark);
  font-weight: 600;
  border-radius: 50px;
  margin-top: 12px;
  box-shadow: var(--shadow-sm);
  border: 2px solid rgba(255, 255, 255, 0.3);
  font-size: 14px;
}

/* Selection Section */
.selection-container {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.selection-container::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.selection-header {
  text-align: center;
  margin-bottom: 25px;
}

.selection-header h3 {
  font-family: "Poppins", sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.selection-header p {
  color: var(--gray);
  font-size: 14px;
}

.selection-box {
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-width: 600px;
  margin: 0 auto;
}

.select-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.select-group label {
  font-weight: 600;
  color: var(--primary);
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.select-group label i {
  color: var(--secondary);
}

.select-group select {
  padding: 15px 18px;
  border: 2px solid #e2e8f0;
  border-radius: var(--radius);
  font-size: 15px;
  font-weight: 500;
  color: var(--dark);
  background: var(--white);
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
}

.select-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
}

.select-group select option {
  padding: 12px;
  font-size: 14px;
}

.action-buttons {
  display: flex;
  gap: 15px;
  margin-top: 25px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  padding: 15px 30px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-md);
}

.action-btn.primary {
  background: var(--gradient-primary);
  color: var(--white);
}

.action-btn.secondary {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  color: var(--white);
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Result Display */
.result-display {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow-lg);
  display: none;
  position: relative;
  overflow: hidden;
}

.result-display::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-accent);
}

.result-header {
  text-align: center;
  margin-bottom: 25px;
}

.result-header h3 {
  font-family: "Poppins", sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
}

.student-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}

.info-card {
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%);
  border-radius: var(--radius-lg);
  padding: 25px;
  border-left: 4px solid var(--primary);
  box-shadow: var(--shadow-md);
}

.info-card h4 {
  font-size: 18px;
  color: var(--primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px dashed rgba(30, 58, 138, 0.1);
}

.info-item:last-child {
  border-bottom: none;
}

.info-label {
  font-weight: 600;
  color: var(--gray);
  font-size: 14px;
}

.info-value {
  font-weight: 700;
  color: var(--primary);
  font-size: 15px;
}

.photo-section {
  text-align: center;
  margin: 30px 0;
}

.photo-container {
  width: 300px;
  height: 300px;
  margin: 0 auto 25px;
  border-radius: 50%;
  overflow: hidden;
  border: 5px solid var(--white);
  box-shadow: var(--shadow-lg);
  background: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: center;
}

#studentPhoto {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upload-btn {
  padding: 12px 30px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-md);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.upload-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.upload-btn i {
  font-size: 16px;
}

.preview-btn {
  padding: 16px 40px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 400px;
  margin: 30px auto 0;
  background: var(--gradient-accent);
  color: var(--white);
  box-shadow: var(--shadow-lg);
}

.preview-btn:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

/* Footer */
.footer {
  text-align: center;
  color: var(--gray);
  margin-top: 40px;
  padding: 30px 25px;
  background: var(--white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  border-top: 4px solid var(--primary);
}

.footer h3 {
  font-family: "Poppins", sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 15px;
}

.footer p {
  margin: 8px 0;
  font-size: 14px;
  line-height: 1.6;
}

.heart {
  color: #ef4444;
  animation: heartbeat 1.5s infinite;
  display: inline-block;
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* Loading Overlay */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.95);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: var(--white);
  backdrop-filter: blur(10px);
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  border-top-color: var(--secondary);
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#loadingText {
  font-size: 16px;
  font-weight: 500;
  letter-spacing: 0.8px;
}

/* Certificate Preview Modal */
#certificatePreview {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.98);
  z-index: 10000;
  overflow: auto;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.certificate-canvas {
  background: #ffffff;
  width: 850px;
  max-width: 95%;
  margin: 30px auto;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
}

.close-preview {
  position: fixed;
  top: 25px;
  right: 35px;
  font-size: 36px;
  color: var(--white);
  cursor: pointer;
  background: rgba(255, 255, 255, 0.1);
  width: 55px;
  height: 55px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(5px);
  border: 2px solid rgba(255, 255, 255, 0.2);
  z-index: 10001;
}

.close-preview:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg) scale(1.1);
}

/* Preview buttons */
.preview-buttons {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10001;
  flex-wrap: wrap;
  justify-content: center;
  padding: 15px;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(10px);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.preview-buttons button {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 14px;
  box-shadow: var(--shadow-lg);
  min-width: 180px;
  justify-content: center;
}

.preview-buttons button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

.preview-buttons button:first-child {
  background: var(--gradient-secondary);
  color: #1e293b;
}

.preview-buttons button:last-child {
  background: var(--gradient-primary);
  color: var(--white);
}

/* Success Animation */
.success-animation {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10003;
  display: none;
}

.success-checkmark {
  width: 70px;
  height: 70px;
  margin: 0 auto;
  border-radius: 50%;
  display: block;
  stroke-width: 2;
  stroke: var(--white);
  stroke-miterlimit: 10;
  box-shadow: inset 0px 0px 0px var(--success);
  animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  background: var(--gradient-accent);
}

.checkmark__circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: var(--white);
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% { stroke-dashoffset: 0; }
}

@keyframes scale {
  0%, 100% { transform: none; }
  50% { transform: scale3d(1.1, 1.1, 1); }
}

@keyframes fill {
  100% { box-shadow: inset 0px 0px 0px 100px var(--success); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .wrap {
    padding: 10px;
  }
  
  .header {
    padding: 25px 20px;
    margin-bottom: 25px;
  }
  
  .header h1 {
    font-size: 28px;
  }
  
  .selection-container, .result-display {
    padding: 25px 20px;
    margin: 25px 0;
  }
  
  .action-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .action-btn {
    width: 100%;
    justify-content: center;
  }
  
  .photo-container {
    width: 250px;
    height: 250px;
  }
  
  .preview-buttons {
    width: 90%;
    flex-direction: column;
    align-items: center;
  }
  
  .preview-buttons button {
    width: 100%;
    max-width: 300px;
  }
}

@media (max-width: 480px) {
  .header h1 {
    font-size: 24px;
  }
  
  .selection-header h3, .result-header h3 {
    font-size: 20px;
  }
  
  .photo-container {
    width: 200px;
    height: 200px;
  }
  
  .preview-buttons {
    bottom: 20px;
    padding: 10px;
  }
  
  .preview-buttons button {
    padding: 12px 20px;
    font-size: 13px;
  }
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(30, 58, 138, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--gradient-primary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gradient-secondary);
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Header Section -->
  <header class="header">
    <div class="header-content">
      <h1>NOORUSSALAM MADRASA</h1>
      <p class="subtitle">Annual Examination Results 2025-26</p>
      <p class="tagline">Select Class Topper to Generate Poster</p>
    </div>
  </header>
  
  <!-- Selection Section -->
  <div class="selection-container">
    <div class="selection-header">
      <h3>Select Class & Topper</h3>
      <p>Choose a class and student to generate achievement poster</p>
    </div>
    
    <div class="selection-box">
      <div class="select-group">
        <label for="classSelect"><i class="fas fa-graduation-cap"></i> Select Class</label>
        <select id="classSelect" onchange="updateStudentList()">
          <option value="">-- Select Class --</option>
          <option value="1">Class 1</option>
          <option value="2">Class 2</option>
          <option value="3">Class 3</option>
          <option value="4">Class 4</option>
          <option value="5">Class 5</option>
          <option value="6">Class 6</option>
          <option value="7">Class 7</option>
          <option value="8">Class 8</option>
          <option value="9">Class 9</option>
          <option value="10">Class 10</option>
        </select>
      </div>
      
      <div class="select-group">
        <label for="studentSelect"><i class="fas fa-user-graduate"></i> Select Topper</label>
        <select id="studentSelect" disabled>
          <option value="">-- First select a class --</option>
        </select>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn primary" onclick="showSelectedTopper()">
          <i class="fas fa-eye"></i> View Selected Topper
        </button>
        <button class="action-btn secondary" onclick="clearSelection()">
          <i class="fas fa-times"></i> Clear Selection
        </button>
      </div>
    </div>
  </div>
  
  <!-- Result Display -->
  <div class="result-display" id="resultDisplay">
    <div class="result-header">
      <h3>Selected Topper Details</h3>
      <p>Upload photo and generate poster</p>
    </div>
    
    <div class="student-info">
      <div class="info-card">
        <h4><i class="fas fa-user-circle"></i> Student Information</h4>
        <div class="info-item">
          <span class="info-label">Name:</span>
          <span class="info-value" id="displayName">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Class:</span>
          <span class="info-value" id="displayClass">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Rank:</span>
          <span class="info-value" id="displayRank">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Marks:</span>
          <span class="info-value" id="displayMarks">-</span>
        </div>
      </div>
      
      <div class="info-card">
        <h4><i class="fas fa-certificate"></i> Poster Information</h4>
        <div class="info-item">
          <span class="info-label">Academic Year:</span>
          <span class="info-value">2025-2026</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status:</span>
          <span class="info-value" id="displayStatus">Ready to Generate</span>
        </div>
      </div>
    </div>
    
    <div class="photo-section">
      <div class="photo-container">
        <img id="studentPhoto" src="" alt="Student Photo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"300\" height=\"300\" viewBox=\"0 0 300 300\"><rect width=\"300\" height=\"300\" fill=\"%23f0f9ff\"/><circle cx=\"150\" cy=\"120\" r=\"60\" fill=\"%23e2e8f0\"/><text x=\"150\" y=\"220\" font-family=\"Arial\" font-size=\"20\" text-anchor=\"middle\" fill=\"%23475569\">Upload Photo</text></svg>'">
      </div>
      <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
      <button class="upload-btn" onclick="document.getElementById('photoUpload').click()">
        <i class="fas fa-cloud-upload-alt"></i> Upload Student Photo
      </button>
    </div>
    
    <button class="preview-btn" onclick="previewCertificate()">
      <i class="fas fa-certificate"></i> Preview & Generate Poster
    </button>
  </div>
  
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <h3>Noorussalam Madrasa</h3>
      <p>Kambippalam-Kerala Estate â€¢ Academic Year 2025-2026</p>
      <p>Designed with <i class="fas fa-heart heart"></i> By Suhail Kerala</p>
      <p style="margin-top: 15px; font-size: 12px; color: #94a3b8;">Â© 2025-2026 All Rights Reserved</p>
    </div>
  </footer>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p id="loadingText">Generating High-Quality Certificate...</p>
</div>

<!-- Certificate Preview Modal -->
<div id="certificatePreview">
  <div class="close-preview" onclick="closeCertificatePreview()">Ã—</div>
  <canvas id="previewCanvas" class="certificate-canvas"></canvas>
</div>

<!-- Success Animation -->
<div class="success-animation" id="successAnimation">
  <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
  </svg>
</div>

<!-- Sound -->
<audio id="certSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>

<script>
// Certificate background image URL
const CERT_BG = "https://i.postimg.cc/vBJs8jT4/topper.jpg";

// Class data with two toppers per class (First and Second)
const classesData = {
  "1": [
    { name: "AZIM FAIZAN M", mark: "291 / 300", rank: "First" },
    { name: "AYISHA ZAHRA P", mark: "278 / 300", rank: "Second" }
  ],
  "2": [
    { name: "Muhammed Shahid", mark: "493 / 500", rank: "First" },
    { name: "Ashmil T", mark: "490 / 500", rank: "Second" }
  ],
  "3": [
    { name: "Muhammed Hadi K", mark: "487 / 500", rank: "First" },
    { name: "Danish T", mark: "485 / 500", rank: "Second" }
  ],
  "4": [
    { name: "Faris P", mark: "489 / 500", rank: "First" },
    { name: "Rifaee P", mark: "486 / 500", rank: "Second" }
  ],
  "5": [
    { name: "Shamil N", mark: "491 / 500", rank: "First" },
    { name: "Nida Mol", mark: "488 / 500", rank: "Second" }
  ],
  "6": [
    { name: "Hana M", mark: "480 / 500", rank: "First" },
    { name: "Riya T", mark: "478 / 500", rank: "Second" }
  ],
  "7": [
    { name: "Riyas M", mark: "485 / 500", rank: "First" },
    { name: "Riya Mol", mark: "482 / 500", rank: "Second" }
  ],
  "8": [
    { name: "Zainab K", mark: "492 / 500", rank: "First" },
    { name: "Muhsin P", mark: "489 / 500", rank: "Second" }
  ],
  "9": [
    { name: "Thaj T", mark: "488 / 500", rank: "First" },
    { name: "Sinan P", mark: "485 / 500", rank: "Second" }
  ],
  "10": [
    { name: "Saniya F", mark: "495 / 500", rank: "First" },
    { name: "Asna K", mark: "492 / 500", rank: "Second" }
  ]
};

// Store selected student data
let selectedStudent = null;
let uploadedPhoto = null;

// Update student list based on selected class
function updateStudentList() {
  const classSelect = document.getElementById('classSelect');
  const studentSelect = document.getElementById('studentSelect');
  const selectedClass = classSelect.value;
  
  studentSelect.innerHTML = '<option value="">-- Select Topper --</option>';
  studentSelect.disabled = !selectedClass;
  
  if (selectedClass && classesData[selectedClass]) {
    classesData[selectedClass].forEach((student, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${student.name} - ${student.rank} (${student.mark})`;
      studentSelect.appendChild(option);
    });
  }
}

// Show selected topper details
function showSelectedTopper() {
  const classSelect = document.getElementById('classSelect');
  const studentSelect = document.getElementById('studentSelect');
  
  if (!classSelect.value || !studentSelect.value) {
    alert('Please select both class and topper!');
    return;
  }
  
  const selectedClass = classSelect.value;
  const studentIndex = parseInt(studentSelect.value);
  
  if (classesData[selectedClass] && classesData[selectedClass][studentIndex]) {
    selectedStudent = {
      ...classesData[selectedClass][studentIndex],
      class: selectedClass
    };
    
    // Update display
    document.getElementById('displayName').textContent = selectedStudent.name;
    document.getElementById('displayClass').textContent = `Class ${selectedStudent.class}`;
    document.getElementById('displayRank').textContent = selectedStudent.rank;
    document.getElementById('displayMarks').textContent = selectedStudent.mark;
    
    // Check for saved photo
    const savedPhoto = localStorage.getItem(`photo_${selectedClass}_${studentIndex}`);
    if (savedPhoto) {
      document.getElementById('studentPhoto').src = savedPhoto;
      uploadedPhoto = savedPhoto;
      document.getElementById('displayStatus').textContent = 'Photo Uploaded';
      document.getElementById('displayStatus').style.color = '#059669';
    } else {
      document.getElementById('studentPhoto').src = '';
      uploadedPhoto = null;
      document.getElementById('displayStatus').textContent = 'Photo Not Uploaded';
      document.getElementById('displayStatus').style.color = '#ef4444';
    }
    
    // Show result display with animation
    const resultDisplay = document.getElementById('resultDisplay');
    resultDisplay.style.display = 'block';
    resultDisplay.style.opacity = '0';
    resultDisplay.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      resultDisplay.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
      resultDisplay.style.opacity = '1';
      resultDisplay.style.transform = 'translateY(0)';
    }, 100);
    
    // Scroll to result display
    resultDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Show notification
    showNotification(`Selected: ${selectedStudent.name} - Class ${selectedStudent.class}`, 'success');
  }
}

// Clear selection
function clearSelection() {
  document.getElementById('classSelect').value = '';
  document.getElementById('studentSelect').innerHTML = '<option value="">-- First select a class --</option>';
  document.getElementById('studentSelect').disabled = true;
  document.getElementById('resultDisplay').style.display = 'none';
  selectedStudent = null;
  uploadedPhoto = null;
  
  showNotification('Selection cleared!', 'info');
}

// Handle photo upload
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validate file
  const maxSize = 10 * 1024 * 1024; // 10MB
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  
  if (!allowedTypes.includes(file.type)) {
    showNotification('Please upload JPG, PNG, GIF, or WebP images only.', 'error');
    return;
  }
  
  if (file.size > maxSize) {
    showNotification('Image size should be less than 10MB.', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedPhoto = e.target.result;
    document.getElementById('studentPhoto').src = uploadedPhoto;
    document.getElementById('displayStatus').textContent = 'Photo Uploaded';
    document.getElementById('displayStatus').style.color = '#059669';
    
    // Save to localStorage
    const classSelect = document.getElementById('classSelect');
    const studentSelect = document.getElementById('studentSelect');
    if (classSelect.value && studentSelect.value) {
      localStorage.setItem(`photo_${classSelect.value}_${studentSelect.value}`, uploadedPhoto);
    }
    
    showNotification('Photo uploaded successfully! ðŸŽ‰', 'success');
    showSuccessAnimation();
  };
  
  reader.readAsDataURL(file);
}

// Show notification
function showNotification(message, type = 'info') {
  const icon = {
    success: 'check-circle',
    error: 'exclamation-circle',
    info: 'info-circle',
    warning: 'exclamation-triangle'
  }[type];
  
  const color = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  }[type];
  
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 25px;
    right: 25px;
    background: ${color};
    color: white;
    padding: 18px 22px;
    border-radius: 14px;
    font-weight: 500;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 13px;
  `;
  notification.innerHTML = `
    <div style="font-size: 20px;">
      <i class="fas fa-${icon}"></i>
    </div>
    <div>
      <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
      <div>${message}</div>
    </div>
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 10);
  
  setTimeout(() => {
    notification.style.transform = 'translateX(150%)';
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

// Show success animation
function showSuccessAnimation() {
  const animation = document.getElementById('successAnimation');
  animation.style.display = 'block';
  setTimeout(() => {
    animation.style.display = 'none';
  }, 2000);
}

// Show loading
function showLoading(text = 'Generating High-Quality Certificate...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loading').style.display = 'flex';
}

// Hide loading
function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// Load image helper
function loadImage(src) { 
  return new Promise((resolve, reject) => { 
    const img = new Image(); 
    img.crossOrigin = "anonymous"; 
    img.onload = () => resolve(img); 
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`)); 
    img.src = src; 
  }); 
}

// Render certificate canvas
async function renderCertificateCanvas(name, cls, mark, rank, photo) {
  const w = 2400, h = 3200;
  const canvas = document.createElement("canvas"); 
  canvas.width = w; 
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  
  try {
    const bg = await loadImage(CERT_BG); 
    ctx.drawImage(bg, 0, 0, w, h);
    
    const cx = w/2, cy = 1600, r = 400;
    
    if(photo) {
      try {
        const img = await loadImage(photo);
        ctx.save(); 
        ctx.beginPath(); 
        ctx.arc(cx, cy, r, 0, Math.PI * 2); 
        ctx.clip();
        
        const imgRatio = img.width / img.height;
        const circleRatio = (r * 2) / (r * 2);
        
        let drawWidth, drawHeight, drawX, drawY;
        
        if (imgRatio > circleRatio) {
          drawHeight = r * 2;
          drawWidth = img.width * (drawHeight / img.height);
          drawX = cx - drawWidth / 2;
          drawY = cy - drawHeight / 2;
        } else {
          drawWidth = r * 2;
          drawHeight = img.height * (drawWidth / img.width);
          drawX = cx - drawWidth / 2;
          drawY = cy - drawHeight / 2;
        }
        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 5;
        
        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
        ctx.restore();
        ctx.shadowBlur = 0;
        ctx.shadowColor = 'transparent';
        
      } catch(e) {
        console.error("Error loading student photo:", e);
        drawPlaceholderPhoto(ctx, cx, cy, r, rank);
      }
    } else {
      drawPlaceholderPhoto(ctx, cx, cy, r, rank);
    }
    
    // Add text
    ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 4;
    
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 112px "Poppins"';
    ctx.textAlign = 'center';
    ctx.fillText(name, cx, 2160);
    
    ctx.fillStyle = '#1e3a8a';
    ctx.font = 'bold 72px "Poppins"';
    ctx.fillText(`Class: ${cls} | Marks: ${mark}`, cx, 2300);
    
    const rankColor = rank === 'First' ? '#d4af37' : '#64748b';
    ctx.fillStyle = rankColor;
    ctx.font = 'bold 76px "Poppins"';
    const rankText = rank === 'First' ? 'Class Topper' : 'Second Place in Class';
    ctx.fillText(rankText, cx, 2420);
    
    ctx.shadowBlur = 0;
    ctx.shadowColor = 'transparent';
    
    return canvas;
  } catch(error) {
    console.error("Error rendering certificate:", error);
    throw new Error("Failed to load certificate background");
  }
}

// Draw placeholder photo
function drawPlaceholderPhoto(ctx, cx, cy, r, rank) {
  const solidColor = rank === 'First' ? '#fffbeb' : '#f8fafc';
  
  ctx.fillStyle = solidColor;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = rank === 'First' ? '#d4af37' : '#64748b';
  ctx.font = 'bold 48px "Font Awesome 6 Free"';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ðŸ‘¨â€ðŸŽ“', cx, cy);
}

// Preview certificate
async function previewCertificate() {
  if (!selectedStudent) {
    showNotification('Please select a student first!', 'error');
    return;
  }
  
  try {
    showLoading();
    const canvas = await renderCertificateCanvas(
      selectedStudent.name,
      selectedStudent.class,
      selectedStudent.mark,
      selectedStudent.rank,
      uploadedPhoto
    );
    
    hideLoading();
    
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = previewCanvas.getContext('2d');
    
    previewCanvas.width = 1600;
    previewCanvas.height = 2134;
    
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    
    ctx.drawImage(canvas, 0, 0, 2400, 3200, 0, 0, 1600, 2134);
    
    document.getElementById('certificatePreview').style.display = 'block';
    
    setTimeout(() => {
      const existingButtons = document.querySelector('.preview-buttons');
      if (existingButtons) existingButtons.remove();
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'preview-buttons';
      
      buttonContainer.innerHTML = `
        <button onclick="downloadCertificate('png')">
          <i class="fas fa-download"></i> Download PNG
        </button>
        <button onclick="downloadCertificate('pdf')">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      `;
      
      document.getElementById('certificatePreview').appendChild(buttonContainer);
    }, 100);
    
  } catch(error) {
    hideLoading();
    console.error("Error previewing certificate:", error);
    showNotification("Error previewing certificate. Please try again.", 'error');
  }
}

// Close certificate preview
function closeCertificatePreview() {
  document.getElementById('certificatePreview').style.display = 'none';
  const buttons = document.querySelector('.preview-buttons');
  if (buttons) buttons.remove();
}

// Download certificate
async function downloadCertificate(type) {
  if (!selectedStudent) return;
  
  try {
    showLoading(type === 'png' ? 'Generating PNG...' : 'Generating PDF...');
    
    const sound = document.getElementById("certSound"); 
    sound.currentTime = 0; 
    sound.play().catch(e => console.log("Audio play failed:", e));
    
    const canvas = await renderCertificateCanvas(
      selectedStudent.name,
      selectedStudent.class,
      selectedStudent.mark,
      selectedStudent.rank,
      uploadedPhoto
    );
    
    const finalCanvas = document.createElement("canvas");
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    const finalCtx = finalCanvas.getContext('2d');
    
    finalCtx.imageSmoothingEnabled = true;
    finalCtx.imageSmoothingQuality = 'high';
    
    finalCtx.fillStyle = '#ffffff';
    finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    finalCtx.drawImage(canvas, 0, 0);
    
    const img = finalCanvas.toDataURL("image/png", 1.0);
    
    // Confetti
    confetti({
      particleCount: 200,
      spread: 150,
      origin: { y: 0.6 },
      colors: selectedStudent.rank === 'First' ? ['#fbbf24', '#f59e0b', '#d97706', '#ffffff'] : ['#c0c0c0', '#94a3b8', '#64748b', '#ffffff']
    });
    
    const fileName = `Noorussalam_Class${selectedStudent.class}_${selectedStudent.rank.replace(' ', '_')}_${selectedStudent.name.replace(/\s+/g, '_')}`;
    
    if(type === "png") {
      const a = document.createElement("a"); 
      a.href = img; 
      a.download = `${fileName}.png`; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification(`ðŸŽ‰ Certificate for ${selectedStudent.name} downloaded!`, 'success');
    } else if(type === "pdf") {
      const { jsPDF } = window.jspdf; 
      const pdf = new jsPDF({
        orientation: "portrait", 
        unit: "px", 
        format: [2400, 3200]
      });
      
      pdf.addImage(img, "PNG", 0, 0, 2400, 3200); 
      pdf.save(`${fileName}.pdf`);
      showNotification(`ðŸ“„ PDF certificate for ${selectedStudent.name} downloaded!`, 'success');
    }
    
    hideLoading();
    showSuccessAnimation();
    
  } catch(error) {
    hideLoading();
    console.error("Error generating certificate:", error);
    showNotification("Error generating certificate. Please try again.", 'error');
  }
}

// Close modal when clicking outside
document.getElementById('certificatePreview').addEventListener('click', function(e) {
  if(e.target === this) closeCertificatePreview();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if(e.key === 'Escape') {
    closeCertificatePreview();
  }
});

// Initialize when page loads
window.addEventListener('load', function() {
  // Focus on class select
  setTimeout(() => {
    document.getElementById('classSelect').focus();
  }, 500);
  
  // Show welcome message
  setTimeout(() => {
    showNotification('Welcome! Select a class and topper to begin.', 'info');
  }, 1000);
});
</script>
</body>
</html>
