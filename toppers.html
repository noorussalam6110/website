<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Class Topper Certificate Generator â€” Noorussalam Madrasa</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f4ff 50%, #f0f9ff 100%);
  color: #073045;
  padding: 20px;
  min-height: 100vh;
}

.wrap {
  max-width: 1400px;
  margin: 0 auto;
}

/* Header Section */
header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 20px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,249,255,0.95) 100%);
  border-radius: 25px;
  box-shadow: 0 15px 35px rgba(2, 6, 23, 0.08);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(13, 110, 253, 0.1);
}

header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, #0d6efd, #ffd700, #10b981);
}

.logo-container {
  margin-bottom: 20px;
}

.logo {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #0d6efd, #0b5ed7);
  color: white;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  font-size: 32px;
  margin-bottom: 15px;
  box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3);
}

header h1 {
  color: #073045;
  margin: 10px 0 5px;
  font-size: 38px;
  font-weight: 800;
  background: linear-gradient(90deg, #0d6efd 0%, #ffd700 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 0.5px;
}

.subtitle {
  color: #0b3b50;
  font-size: 18px;
  margin: 0 0 15px;
  font-weight: 500;
  opacity: 0.9;
}

.tagline {
  color: #0d6efd;
  font-size: 16px;
  margin: 0;
  font-weight: 600;
  padding: 10px 20px;
  background: rgba(13, 110, 253, 0.08);
  border-radius: 30px;
  display: inline-block;
}

/* Stats Section */
.stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 25px 0 30px;
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
  padding: 15px 25px;
  background: white;
  border-radius: 15px;
  min-width: 140px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(13, 110, 253, 0.1);
}

.stat-number {
  font-size: 32px;
  font-weight: 800;
  color: #0d6efd;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  color: #073045;
  opacity: 0.8;
}

/* Instructions */
.instructions {
  background: rgba(255, 215, 0, 0.08);
  border-radius: 18px;
  padding: 20px 25px;
  margin: 25px auto 30px;
  max-width: 900px;
  border-left: 5px solid #ffd700;
  display: flex;
  align-items: flex-start;
  gap: 20px;
}

.instructions-icon {
  font-size: 24px;
  color: #ffd700;
  background: rgba(255, 215, 0, 0.15);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.instructions-content h3 {
  margin: 0 0 10px;
  color: #073045;
  font-size: 18px;
}

.instructions-list {
  margin: 0;
  padding: 0;
  list-style: none;
}

.instructions-list li {
  margin: 8px 0;
  color: #0a3b45;
  display: flex;
  align-items: center;
  gap: 10px;
}

.instructions-list i {
  color: #0d6efd;
  font-size: 14px;
}

/* Search Section */
.search-section {
  background: rgba(13, 110, 253, 0.05);
  border-radius: 20px;
  padding: 25px;
  margin: 30px auto;
  max-width: 900px;
  border: 2px solid rgba(13, 110, 253, 0.1);
  box-shadow: 0 8px 25px rgba(13, 110, 253, 0.1);
}

.search-section h3 {
  text-align: center;
  margin: 0 0 20px;
  color: #073045;
  font-size: 22px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.search-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.search-row {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
  align-items: center;
}

#classSearch {
  flex: 1;
  min-width: 250px;
  max-width: 400px;
  padding: 14px 20px;
  border: 2px solid rgba(13, 110, 253, 0.3);
  border-radius: 15px;
  font-size: 16px;
  font-weight: 500;
  background: white;
  color: #073045;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

#classSearch:focus {
  outline: none;
  border-color: #0d6efd;
  box-shadow: 0 4px 20px rgba(13, 110, 253, 0.2);
}

#classSearch::placeholder {
  color: #6c757d;
  opacity: 0.7;
}

.search-btn {
  padding: 14px 30px;
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  color: white;
  border: none;
  border-radius: 15px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 6px 20px rgba(13, 110, 253, 0.25);
}

.search-btn:hover {
  background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(13, 110, 253, 0.35);
}

.clear-search-btn {
  padding: 14px 25px;
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
  border: none;
  border-radius: 15px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 6px 20px rgba(108, 117, 125, 0.25);
}

.clear-search-btn:hover {
  background: linear-gradient(135deg, #495057 0%, #343a40 100%);
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(108, 117, 125, 0.35);
}

.class-filter-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

.class-filter-btn {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.9);
  border: 2px solid rgba(13, 110, 253, 0.2);
  border-radius: 12px;
  color: #0d6efd;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.class-filter-btn:hover {
  background: rgba(13, 110, 253, 0.1);
  transform: translateY(-2px);
  border-color: #0d6efd;
}

.class-filter-btn.active {
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  color: white;
  border-color: #0d6efd;
}

.search-results-info {
  text-align: center;
  margin-top: 15px;
  padding: 12px 20px;
  background: rgba(255, 215, 0, 0.1);
  border-radius: 12px;
  font-weight: 600;
  color: #073045;
  border: 2px solid rgba(255, 215, 0, 0.2);
  display: none;
}

/* Border Style Controls */
.border-controls {
  background: rgba(147, 51, 234, 0.05);
  border-radius: 20px;
  padding: 20px;
  margin: 20px auto;
  max-width: 900px;
  border: 2px solid rgba(147, 51, 234, 0.1);
  box-shadow: 0 8px 25px rgba(147, 51, 234, 0.1);
}

.border-controls h3 {
  text-align: center;
  margin: 0 0 15px;
  color: #073045;
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.border-options {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
}

.border-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  min-width: 150px;
}

.border-option label {
  font-weight: 600;
  color: #073045;
  font-size: 14px;
}

.border-slider {
  width: 100%;
  height: 8px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, #0d6efd, #9333ea);
  border-radius: 4px;
  outline: none;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.border-slider:hover {
  opacity: 1;
}

.border-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #0d6efd;
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.border-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #0d6efd;
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.border-value {
  font-weight: 700;
  color: #0d6efd;
  font-size: 16px;
  min-width: 40px;
  text-align: center;
  background: rgba(13, 110, 253, 0.1);
  padding: 4px 10px;
  border-radius: 20px;
}

/* Classes Section */
.classes-title {
  text-align: center;
  margin: 40px 0 25px;
  font-size: 28px;
  font-weight: 700;
  color: #073045;
  position: relative;
  display: inline-block;
  left: 50%;
  transform: translateX(-50%);
  padding: 0 20px;
}

.classes-title::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 20px;
  right: 20px;
  height: 3px;
  background: linear-gradient(90deg, #0d6efd, #ffd700);
  border-radius: 3px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 25px;
  margin-bottom: 50px;
}

.class-card {
  background: white;
  border-radius: 20px;
  padding: 25px;
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
  border: 2px solid rgba(13, 110, 253, 0.1);
  position: relative;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  overflow: hidden;
}

.class-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 40px rgba(2, 6, 23, 0.12);
  border-color: rgba(13, 110, 253, 0.3);
}

.class-card.hidden {
  display: none;
}

.class-header {
  text-align: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid rgba(255, 215, 0, 0.3);
}

.class-header h3 {
  margin: 0;
  font-size: 22px;
  color: #0d6efd;
  font-weight: 700;
}

/* Topper Cards */
.topper-card {
  background: #f8fbff;
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(13, 110, 253, 0.1);
  position: relative;
}

.topper-card:last-child {
  margin-bottom: 0;
}

.topper-card.first {
  border-left: 5px solid #ffd700;
  /* Removed gradient, using solid color */
  background: #f8fbff;
}

.topper-card.second {
  border-left: 5px solid #6c757d;
  /* Removed gradient, using solid color */
  background: #f8fbff;
}

.rank-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 18px;
  color: white;
  z-index: 2;
}

.rank-badge.first {
  background: #ffd700;
  color: #000;
  box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
  border: 2px solid white;
}

.rank-badge.second {
  background: #6c757d;
  box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
  border: 2px solid white;
}

/* INCREASED PHOTO SIZE WITH STYLISH BORDER */
.photo-container {
  width: 160px; /* Increased from 140px */
  height: 160px; /* Increased from 140px */
  margin: 0 auto 15px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.photo-frame {
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Stylish Border Effect */
.photo-border {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(45deg, 
    #0d6efd 0%, 
    #0b5ed7 25%, 
    #0a58ca 50%, 
    #0952c3 75%, 
    #084bb5 100%);
  padding: 6px;
  z-index: 1;
  box-shadow: 
    0 8px 25px rgba(13, 110, 253, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo-border.first {
  background: #ffd700; /* Solid color instead of gradient */
  box-shadow: 
    0 8px 25px rgba(255, 215, 0, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo-border.second {
  background: #6c757d; /* Solid color instead of gradient */
  box-shadow: 
    0 8px 25px rgba(108, 117, 125, 0.3),
    inset 0 0 20px rgba(255, 255, 255, 0.4);
}

.photo {
  width: calc(100% - 12px);
  height: calc(100% - 12px);
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  z-index: 2;
  background: #f6fbff;
  box-shadow: 
    inset 0 0 10px rgba(0, 0, 0, 0.1),
    0 0 0 3px white;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Inner decorative circle */
.photo::before {
  content: "";
  position: absolute;
  top: -3px;
  left: -3px;
  right: -3px;
  bottom: -3px;
  border-radius: 50%;
  background: linear-gradient(45deg, 
    transparent 0%, 
    rgba(255, 255, 255, 0.6) 50%, 
    transparent 100%);
  z-index: -1;
  opacity: 0.3;
}

.upload-btn {
  display: block;
  margin: 15px auto 15px; /* Increased margin */
  padding: 10px 20px; /* Increased padding */
  background: #0d6efd;
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 15px rgba(13, 110, 253, 0.25);
  position: relative;
  overflow: hidden;
}

.upload-btn:hover {
  background: #0b5ed7;
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(13, 110, 253, 0.4);
}

.upload-btn::after {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent 30%,
    rgba(255, 255, 255, 0.1) 50%,
    transparent 70%
  );
  transform: rotate(45deg);
  transition: all 0.5s ease;
  opacity: 0;
}

.upload-btn:hover::after {
  opacity: 1;
  transform: rotate(45deg) translate(10%, 10%);
}

.student-name {
  text-align: center;
  font-weight: 700;
  margin: 15px 0 8px; /* Increased margin */
  font-size: 22px; /* Larger font */
  color: #073045;
  position: relative;
  padding-bottom: 8px;
}

.student-name::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, #0d6efd, #ffd700);
  border-radius: 1px;
}

.student-meta {
  text-align: center;
  color: #0a3b45;
  font-weight: 600;
  margin-top: 8px;
  font-size: 16px; /* Larger font */
  padding: 10px 18px; /* Increased padding */
  background: rgba(13, 110, 253, 0.05);
  border-radius: 25px;
  display: inline-block;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid rgba(13, 110, 253, 0.1);
}

.rank-label {
  text-align: center;
  color: #0d6efd;
  font-weight: 700;
  margin-top: 8px;
  font-size: 16px; /* Larger font */
  text-transform: uppercase;
  letter-spacing: 0.8px;
  position: relative;
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  background: rgba(13, 110, 253, 0.08);
}

.rank-label.first {
  color: #d4af37;
  background: rgba(255, 215, 0, 0.08);
}

.rank-label.second {
  color: #6c757d;
  background: rgba(108, 117, 125, 0.08);
}

/* ONLY PREVIEW BUTTON - REMOVED PDF AND PRINT BUTTONS */
.btns {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.btn {
  padding: 14px 40px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 16px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-width: 200px;
  position: relative;
  overflow: hidden;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.btn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  transition: left 0.6s ease;
}

.btn:hover::after {
  left: 100%;
}

.btn-preview {
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  color: #fff;
  border: 1px solid rgba(13, 110, 253, 0.3);
  box-shadow: 0 6px 20px rgba(13, 110, 253, 0.25);
}

.btn-preview:hover {
  box-shadow: 0 10px 30px rgba(13, 110, 253, 0.4);
}

/* Footer */
footer {
  text-align: center;
  color: #345;
  margin-top: 40px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 20px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
}

footer p {
  margin: 8px 0;
}

.cert-count {
  font-weight: 700;
  color: #0d6efd;
  font-size: 18px;
}

/* Modal */
#previewModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(5px);
}

#previewModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
}

#previewModal .close {
  position: absolute;
  top: 25px;
  right: 35px;
  font-size: 32px;
  color: #fff;
  cursor: pointer;
  font-weight: 700;
  background: rgba(0, 0, 0, 0.5);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

#previewModal .close:hover {
  background: rgba(255, 0, 0, 0.7);
  transform: rotate(90deg);
}

/* Clear All Button */
.clear-all-container {
  text-align: center;
  margin: 20px 0 40px;
}

#clearAllBtn {
  padding: 14px 30px;
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: 600;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

#clearAllBtn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
}

#clearAllBtn::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  transition: left 0.5s ease;
}

#clearAllBtn:hover::after {
  left: 100%;
}

/* Responsive */
@media(max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .stats {
    gap: 15px;
  }
  
  .stat-item {
    min-width: 120px;
    padding: 12px 20px;
  }
  
  header h1 {
    font-size: 30px;
  }
  
  .photo-container {
    width: 140px;
    height: 140px;
  }
  
  .btn {
    min-width: 180px;
    padding: 12px 30px;
  }
  
  .search-row {
    flex-direction: column;
  }
  
  #classSearch {
    width: 100%;
    max-width: 100%;
  }
  
  .search-btn, .clear-search-btn {
    width: 100%;
    justify-content: center;
  }
  
  .class-filter-buttons {
    gap: 8px;
  }
  
  .class-filter-btn {
    padding: 8px 16px;
    font-size: 14px;
  }
  
  .border-options {
    flex-direction: column;
    align-items: center;
  }
  
  .border-option {
    width: 100%;
    max-width: 300px;
  }
}

@media(max-width: 480px) {
  .photo-container {
    width: 130px;
    height: 130px;
  }
  
  .btn {
    min-width: 160px;
    padding: 12px 25px;
    font-size: 15px;
  }
}

/* Certificate Preview */
#certificatePreview {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  overflow: auto;
  padding: 20px;
}

.certificate-canvas {
  background: white;
  width: 800px;
  max-width: 90%;
  margin: 30px auto;
  border-radius: 10px;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.3);
  position: relative;
}

.close-preview {
  position: fixed;
  top: 20px;
  right: 30px;
  font-size: 36px;
  color: white;
  cursor: pointer;
  background: rgba(0, 0, 0, 0.5);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.close-preview:hover {
  background: rgba(255, 0, 0, 0.7);
  transform: rotate(90deg);
}

/* Preview buttons - Now only Download PNG and Download PDF */
.preview-buttons {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10001;
  flex-wrap: wrap;
  justify-content: center;
}

.preview-buttons button {
  padding: 12px 25px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-size: 14px;
}

.preview-buttons button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

/* Loading Animation */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10002;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: white;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #0d6efd;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Header Section -->
  <header>
    <div class="logo-container">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <h1>NOORUSSALAM MADRASA</h1>
      <p class="subtitle">Annual Examination Results - Academic Year 2025-2026</p>
      <p class="tagline">Celebrating Academic Excellence & Achievement</p>
    </div>
    
    <!-- Stats Section -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number">10</div>
        <div class="stat-label">Classes</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">20</div>
        <div class="stat-label">Top Students</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">100%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="certCount">0</div>
        <div class="stat-label">Certificates Generated</div>
      </div>
    </div>
    
    <!-- Instructions -->
    <div class="instructions">
      <div class="instructions-icon">
        <i class="fas fa-lightbulb"></i>
      </div>
      <div class="instructions-content">
        <h3>How to Generate Photo Poster</h3>
        <ul class="instructions-list">
          <li><i class="fas fa-camera"></i> Upload high-quality photos for best results</li>
          <li><i class="fas fa-palette"></i> Adjust photo border thickness and style</li>
          <li><i class="fas fa-search"></i> Use search to find specific classes quickly</li>
          <li><i class="fas fa-eye"></i> Preview the Photo Poster before downloading</li>
        </ul>
      </div>
    </div>
  </header>
  
  <!-- Search Section -->
  <div class="search-section">
    <h3><i class="fas fa-search"></i> Search Classes</h3>
    <div class="search-container">
      <div class="search-row">
        <input type="text" id="classSearch" placeholder="Enter class number (1-10) or student name..." autocomplete="off">
        <button class="search-btn" onclick="searchClasses()">
          <i class="fas fa-search"></i> Search
        </button>
        <button class="clear-search-btn" onclick="clearSearch()">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
      
      <div class="class-filter-buttons" id="classFilterButtons">
        <!-- Class filter buttons will be generated by JavaScript -->
      </div>
      
      <div class="search-results-info" id="searchResultsInfo">
        <!-- Search results info will be shown here -->
      </div>
    </div>
  </div>
  
  <!-- Border Style Controls -->
  <div class="border-controls">
    <h3><i class="fas fa-palette"></i> Customize Photo Border Style</h3>
    <div class="border-options">
      <div class="border-option">
        <label for="borderThickness">Border Thickness</label>
        <input type="range" id="borderThickness" class="border-slider" min="5" max="30" value="30" step="1">
        <span class="border-value" id="borderThicknessValue">30px</span>
      </div>
      <div class="border-option">
        <label for="borderOpacity">Border Opacity</label>
        <input type="range" id="borderOpacity" class="border-slider" min="0.1" max="1" value="1" step="0.1">
        <span class="border-value" id="borderOpacityValue">1</span>
      </div>
    </div>
  </div>
  
  <!-- Classes Section -->
  <h2 class="classes-title">Class Toppers & Second Place</h2>
  
  <div id="grid" class="grid"></div>
  
  <!-- Clear All Button -->
  <div class="clear-all-container">
    <button id="clearAllBtn" onclick="clearAllPhotos()">
      <i class="fas fa-trash-alt"></i> Clear All Uploaded Photos
    </button>
  </div>
  
  <!-- Footer -->
  <footer>
    <p>Â© 2025-2026 Noorussalam Madrasa â€” Kambippalam-Kerala Estate</p>
    <p>Certificates generated: <span class="cert-count" id="certCountFooter">0</span></p>
    <p>Designed with <i class="fas fa-heart" style="color:#dc3545;"></i> for celebrating student achievements</p>
  </footer>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p>Generating Certificate...</p>
</div>

<!-- Certificate Preview Modal -->
<div id="certificatePreview">
  <div class="close-preview" onclick="closeCertificatePreview()">Ã—</div>
  <canvas id="previewCanvas" class="certificate-canvas"></canvas>
</div>

<!-- Photo Preview Modal -->
<div id="previewModal">
  <span class="close" onclick="closePreview()">Ã—</span>
  <img id="previewImage" src="" alt="Photo Preview">
</div>

<!-- Sound -->
<audio id="certSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>

<script>
// Certificate background image URL - ADDED SOFT RIBBONS IN BACKGROUND
const CERT_BG = "https://i.ibb.co/JRqqvrm0/TOPPER.jpg";

// Class data with two toppers per class (First and Second)
const classesData = [
  { 
    class: "1", 
    toppers: [
      { name: "Suhail P", mark: "498 / 500", rank: "First" },
      { name: "Minhaj P", mark: "495 / 500", rank: "Second" }
    ]
  },
  { 
    class: "2", 
    toppers: [
      { name: "Muhammed Shahid", mark: "493 / 500", rank: "First" },
      { name: "Ashmil T", mark: "490 / 500", rank: "Second" }
    ]
  },
  { 
    class: "3", 
    toppers: [
      { name: "Muhammed Hadi K", mark: "487 / 500", rank: "First" },
      { name: "Danish T", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "4", 
    toppers: [
      { name: "Faris P", mark: "489 / 500", rank: "First" },
      { name: "Rifaee P", mark: "486 / 500", rank: "Second" }
    ]
  },
  { 
    class: "5", 
    toppers: [
      { name: "Shamil N", mark: "491 / 500", rank: "First" },
      { name: "Nida Mol", mark: "488 / 500", rank: "Second" }
    ]
  },
  { 
    class: "6", 
    toppers: [
      { name: "Hana M", mark: "480 / 500", rank: "First" },
      { name: "Riya T", mark: "478 / 500", rank: "Second" }
    ]
  },
  { 
    class: "7", 
    toppers: [
      { name: "Riyas M", mark: "485 / 500", rank: "First" },
      { name: "Riya Mol", mark: "482 / 500", rank: "Second" }
    ]
  },
  { 
    class: "8", 
    toppers: [
      { name: "Zainab K", mark: "492 / 500", rank: "First" },
      { name: "Muhsin P", mark: "489 / 500", rank: "Second" }
    ]
  },
  { 
    class: "9", 
    toppers: [
      { name: "Thaj T", mark: "488 / 500", rank: "First" },
      { name: "Sinan P", mark: "485 / 500", rank: "Second" }
    ]
  },
  { 
    class: "10", 
    toppers: [
      { name: "Saniya F", mark: "495 / 500", rank: "First" },
      { name: "Asna K", mark: "492 / 500", rank: "Second" }
    ]
  }
];

// Initialize uploaded photos array from localStorage
const uploadedPhotos = {};
classesData.forEach((cls, classIndex) => {
  uploadedPhotos[classIndex] = [];
  cls.toppers.forEach((topper, topperIndex) => {
    const saved = localStorage.getItem(`topperPhoto_${classIndex}_${topperIndex}`);
    uploadedPhotos[classIndex][topperIndex] = saved || null;
  });
});

// Track certificate generation count
let certCount = parseInt(localStorage.getItem('certCount') || '0');
updateCertCount();

// Track active search
let activeSearch = '';

// Border settings - UPDATED TO 30px and 1 opacity
let borderThickness = 30; // pixels - UPDATED
let borderOpacity = 1; // 0 to 1 - UPDATED

// Helper functions
function escapeHtml(s){ 
  return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

function placeholderDataURL(){ 
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#0d6efd;stop-opacity:1" />
        <stop offset="50%" style="stop-color:#0b5ed7;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#084298;stop-opacity:1" />
      </linearGradient>
      <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#eef9ff;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#cfeeff;stop-opacity:1" />
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#grad2)"/>
    <circle cx="250" cy="200" r="135" fill="url(#grad1)" opacity="0.1"/>
    <circle cx="250" cy="200" r="120" fill="#cfeeff"/>
    <text x="250" y="200" text-anchor="middle" dy=".3em" font-family="Arial" font-size="32" fill="#0d6efd" font-weight="bold">Student</text>
    <text x="250" y="250" text-anchor="middle" dy=".3em" font-family="Arial" font-size="24" fill="#073045" font-weight="bold">Photo</text>
    <text x="250" y="400" text-anchor="middle" dy=".3em" font-family="Arial" font-size="18" fill="#0d6efd">Click "Upload Photo"</text>
    <text x="250" y="430" text-anchor="middle" dy=".3em" font-family="Arial" font-size="18" fill="#073045">to add student image</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function updateCertCount() {
  document.getElementById('certCount').textContent = certCount;
  document.getElementById('certCountFooter').textContent = certCount;
}

// Initialize border controls
function initializeBorderControls() {
  const thicknessSlider = document.getElementById('borderThickness');
  const opacitySlider = document.getElementById('borderOpacity');
  const thicknessValue = document.getElementById('borderThicknessValue');
  const opacityValue = document.getElementById('borderOpacityValue');
  
  // Set initial values - UPDATED TO 30px and 1 opacity
  thicknessSlider.value = borderThickness;
  opacitySlider.value = borderOpacity;
  thicknessValue.textContent = borderThickness + 'px';
  opacityValue.textContent = borderOpacity;
  
  // Add event listeners
  thicknessSlider.addEventListener('input', function() {
    borderThickness = parseInt(this.value);
    thicknessValue.textContent = borderThickness + 'px';
  });
  
  opacitySlider.addEventListener('input', function() {
    borderOpacity = parseFloat(this.value);
    opacityValue.textContent = borderOpacity;
  });
}

// Show notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#dc3545' : '#0d6efd'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 10);
  
  setTimeout(() => {
    notification.style.transform = 'translateX(150%)';
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

// Create class filter buttons
function createClassFilterButtons() {
  const container = document.getElementById('classFilterButtons');
  container.innerHTML = '';
  
  // Add "All Classes" button
  const allButton = document.createElement('button');
  allButton.className = 'class-filter-btn active';
  allButton.innerHTML = '<i class="fas fa-layer-group"></i> All Classes';
  allButton.onclick = () => filterByClass('all');
  container.appendChild(allButton);
  
  // Add buttons for each class
  classesData.forEach(cls => {
    const button = document.createElement('button');
    button.className = 'class-filter-btn';
    button.innerHTML = `<i class="fas fa-graduation-cap"></i> Class ${cls.class}`;
    button.onclick = () => filterByClass(cls.class);
    container.appendChild(button);
  });
}

// Filter classes by class number
function filterByClass(classNumber) {
  activeSearch = classNumber === 'all' ? '' : classNumber;
  
  // Update active button
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Find and activate the clicked button
  const buttons = document.querySelectorAll('.class-filter-btn');
  if (classNumber === 'all') {
    buttons[0].classList.add('active');
  } else {
    buttons[classNumber].classList.add('active');
  }
  
  // Update search input
  document.getElementById('classSearch').value = classNumber === 'all' ? '' : classNumber;
  
  // Apply filter
  applySearchFilter();
}

// Search classes
function searchClasses() {
  const searchTerm = document.getElementById('classSearch').value.trim().toLowerCase();
  
  if (!searchTerm) {
    clearSearch();
    return;
  }
  
  activeSearch = searchTerm;
  applySearchFilter();
  
  // Update filter buttons
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // If searching by class number, activate that button
  if (/^[1-9]|10$/.test(searchTerm)) {
    const buttons = document.querySelectorAll('.class-filter-btn');
    const classNum = parseInt(searchTerm);
    if (classNum >= 1 && classNum <= 10) {
      buttons[classNum].classList.add('active');
    }
  }
}

// Apply search filter
function applySearchFilter() {
  const searchTerm = activeSearch.toLowerCase();
  const classCards = document.querySelectorAll('.class-card');
  let visibleCount = 0;
  
  classCards.forEach(card => {
    const classNumber = card.querySelector('.class-header h3').textContent.replace('Class ', '');
    const studentNames = Array.from(card.querySelectorAll('.student-name')).map(el => el.textContent.toLowerCase());
    
    let shouldShow = false;
    
    if (!searchTerm) {
      // Show all if no search term
      shouldShow = true;
    } else if (/^[1-9]|10$/.test(searchTerm)) {
      // Search by class number
      shouldShow = classNumber === searchTerm;
    } else {
      // Search by student name (partial match)
      shouldShow = studentNames.some(name => name.includes(searchTerm));
    }
    
    if (shouldShow) {
      card.classList.remove('hidden');
      visibleCount++;
    } else {
      card.classList.add('hidden');
    }
  });
  
  // Update search results info
  const resultsInfo = document.getElementById('searchResultsInfo');
  if (searchTerm) {
    if (visibleCount === 0) {
      resultsInfo.innerHTML = `<i class="fas fa-info-circle"></i> No classes or students found for "${searchTerm}"`;
      resultsInfo.style.background = 'rgba(220, 53, 69, 0.1)';
      resultsInfo.style.borderColor = 'rgba(220, 53, 69, 0.2)';
    } else {
      resultsInfo.innerHTML = `<i class="fas fa-check-circle"></i> Showing ${visibleCount} class${visibleCount !== 1 ? 'es' : ''} for "${searchTerm}"`;
      resultsInfo.style.background = 'rgba(40, 167, 69, 0.1)';
      resultsInfo.style.borderColor = 'rgba(40, 167, 69, 0.2)';
    }
    resultsInfo.style.display = 'block';
  } else {
    resultsInfo.style.display = 'none';
  }
  
  // Scroll to first visible card
  if (visibleCount > 0) {
    const firstVisible = document.querySelector('.class-card:not(.hidden)');
    if (firstVisible) {
      firstVisible.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
}

// Clear search
function clearSearch() {
  document.getElementById('classSearch').value = '';
  activeSearch = '';
  
  // Reset all filter buttons
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Activate "All Classes" button
  document.querySelectorAll('.class-filter-btn')[0].classList.add('active');
  
  // Hide results info
  document.getElementById('searchResultsInfo').style.display = 'none';
  
  // Show all cards
  document.querySelectorAll('.class-card').forEach(card => {
    card.classList.remove('hidden');
  });
  
  // Focus back on search input
  document.getElementById('classSearch').focus();
}

// Load class cards
const grid = document.getElementById('grid');
function loadClassCards() {
  grid.innerHTML = '';
  
  classesData.forEach((cls, classIndex) => {
    const card = document.createElement('div');
    card.className = 'class-card';
    
    let toppersHTML = '';
    cls.toppers.forEach((topper, topperIndex) => {
      const photoURL = uploadedPhotos[classIndex][topperIndex] || placeholderDataURL();
      const isFirst = topper.rank === 'First';
      
      toppersHTML += `
        <div class="topper-card ${isFirst ? 'first' : 'second'}">
          <div class="rank-badge ${isFirst ? 'first' : 'second'}">
            ${isFirst ? '1st' : '2nd'}
          </div>
          <div class="photo-container">
            <div class="photo-frame">
              <div class="photo-border ${isFirst ? 'first' : 'second'}"></div>
              <div class="photo">
                <img src="${photoURL}" alt="${escapeHtml(topper.name)}" 
                     onclick="previewPhoto('${photoURL.replace(/'/g, "\\'")}')">
              </div>
            </div>
          </div>
          <button class="upload-btn" onclick="document.getElementById('file-${classIndex}-${topperIndex}').click()">
            <i class="fas fa-upload"></i> Upload Photo
          </button>
          <input type="file" id="file-${classIndex}-${topperIndex}" accept="image/*" style="display:none" 
                 onchange="handlePhotoUpload(this, ${classIndex}, ${topperIndex})">
          <div class="student-name">${escapeHtml(topper.name)}</div>
          <div class="rank-label ${isFirst ? 'first' : 'second'}">${topper.rank} Place in Class</div>
          <div class="student-meta">Marks: ${escapeHtml(topper.mark)}</div>
          <div class="btns">
            <button class="btn btn-preview" onclick="previewCertificate('${topper.name}','${cls.class}','${topper.mark}', '${topper.rank}', uploadedPhotos[${classIndex}][${topperIndex}] || '${photoURL}')">
              <i class="fas fa-eye"></i> Preview Certificate
            </button>
          </div>
        </div>
      `;
    });
    
    card.innerHTML = `
      <div class="class-header">
        <h3>Class ${escapeHtml(cls.class)}</h3>
      </div>
      ${toppersHTML}
    `;
    
    grid.appendChild(card);
  });
}

// Handle photo upload
function handlePhotoUpload(input, classIndex, topperIndex) {
  const file = input.files[0]; 
  if(!file) return;
  
  // Check file size (max 10MB for larger photos)
  if(file.size > 10 * 1024 * 1024) {
    showNotification('File too large! Please choose an image under 10MB.', 'error');
    return;
  }
  
  // Check file type
  if(!file.type.match('image.*')) {
    showNotification('Please select an image file (JPG, PNG, etc.)', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedPhotos[classIndex][topperIndex] = e.target.result;
    localStorage.setItem(`topperPhoto_${classIndex}_${topperIndex}`, e.target.result);
    
    // Update the photo in the card
    const img = input.closest('.photo-frame').querySelector('img');
    if(img) img.src = e.target.result;
    
    showNotification('Photo uploaded successfully!', 'success');
  };
  
  reader.onerror = function() {
    showNotification('Error uploading photo. Please try again.', 'error');
  };
  
  reader.readAsDataURL(file);
}

// Preview photo in modal
function previewPhoto(src) {
  if(src.includes('Student</text>')) return;
  document.getElementById('previewImage').src = src;
  document.getElementById('previewModal').style.display = 'flex';
}

// Close photo preview modal
function closePreview() {
  document.getElementById('previewModal').style.display = 'none';
}

// Show loading
function showLoading() {
  document.getElementById('loading').style.display = 'flex';
}

// Hide loading
function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// Load image helper
function loadImage(src) { 
  return new Promise((resolve, reject) => { 
    const img = new Image(); 
    img.crossOrigin = "anonymous"; 
    img.onload = () => resolve(img); 
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`)); 
    img.src = src; 
  }); 
}

// Create beautiful gradient border for circular photo - UPDATED FOR 30px BORDER
function createBeautifulGradientBorder(ctx, cx, cy, r, rank, thickness = 30, opacity = 1) {
  // Create solid color based on rank
  let borderColor;
  
  if (rank === 'First') {
    // Solid gold for First rank
    borderColor = `rgba(255, 215, 0, ${opacity})`;
  } else {
    // Solid silver for Second rank
    borderColor = `rgba(192, 192, 192, ${opacity})`;
  }
  
  // Draw outer glow effect
  const glow = ctx.createRadialGradient(cx, cy, r + thickness/2, cx, cy, r + thickness*2);
  if (rank === 'First') {
    glow.addColorStop(0, `rgba(255, 215, 0, ${opacity * 0.3})`);
    glow.addColorStop(0.5, `rgba(255, 215, 0, ${opacity * 0.1})`);
    glow.addColorStop(1, 'transparent');
  } else {
    glow.addColorStop(0, `rgba(192, 192, 192, ${opacity * 0.3})`);
    glow.addColorStop(0.5, `rgba(192, 192, 192, ${opacity * 0.1})`);
    glow.addColorStop(1, 'transparent');
  }
  
  ctx.beginPath();
  ctx.arc(cx, cy, r + thickness*2, 0, Math.PI * 2);
  ctx.fillStyle = glow;
  ctx.fill();
  
  // Draw main border with SOLID COLOR (removed gradient)
  ctx.beginPath();
  ctx.arc(cx, cy, r + thickness/2, 0, Math.PI * 2);
  ctx.lineWidth = thickness;
  ctx.strokeStyle = borderColor; // Solid color instead of gradient
  ctx.stroke();
  
  // Draw inner white border
  ctx.beginPath();
  ctx.arc(cx, cy, r + thickness/4, 0, Math.PI * 2);
  ctx.lineWidth = thickness/3;
  ctx.strokeStyle = `rgba(255, 255, 255, ${opacity})`;
  ctx.stroke();
  
  // Draw decorative pattern (dotted line)
  ctx.beginPath();
  ctx.setLineDash([12, 6]); // Increased for thicker border
  ctx.arc(cx, cy, r + thickness/2, 0, Math.PI * 2);
  ctx.lineWidth = thickness/5;
  ctx.strokeStyle = rank === 'First' ? `rgba(255, 153, 0, ${opacity * 0.5})` : `rgba(136, 136, 136, ${opacity * 0.5})`;
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Add small decorative elements based on rank - REMOVED STARS AND TROPHY ICONS
  const decorativeCount = rank === 'First' ? 8 : 6;
  for (let i = 0; i < decorativeCount; i++) {
    const angle = (i * Math.PI * 2) / decorativeCount;
    const x = cx + (r + thickness) * Math.cos(angle);
    const y = cy + (r + thickness) * Math.sin(angle);
    
    ctx.beginPath();
    // Simple dots instead of stars/trophy icons
    ctx.arc(x, y, 6, 0, Math.PI * 2);
    ctx.fillStyle = borderColor;
    ctx.fill();
  }
}

// Function to draw soft ribbon patterns in background
function drawSoftRibbons(ctx, w, h) {
  // Save context state
  ctx.save();
  
  // Set transparency for soft ribbons
  ctx.globalAlpha = 0.03;
  
  // Draw ribbon-like patterns
  const ribbonColors = ['#0d6efd', '#ffd700', '#10b981', '#9333ea'];
  
  // Draw multiple ribbons
  for (let i = 0; i < 8; i++) {
    const color = ribbonColors[i % ribbonColors.length];
    const y = (h / 8) * i + 100;
    const ribbonWidth = 600;
    
    ctx.fillStyle = color;
    
    // Create ribbon shape
    ctx.beginPath();
    ctx.moveTo(-100, y);
    ctx.bezierCurveTo(
      w/4, y - 50,
      w/2, y + 50,
      w + 100, y
    );
    ctx.bezierCurveTo(
      w/2, y + 150,
      w/4, y + 50,
      -100, y + 100
    );
    ctx.closePath();
    ctx.fill();
  }
  
  // Restore context state
  ctx.restore();
}

// Render certificate canvas with beautiful gradient border
async function renderCertificateCanvas(name, cls, mark, rank, photo) {
  const w = 1200, h = 1600;
  const canvas = document.createElement("canvas"); 
  canvas.width = w; 
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  
  try {
    // Draw background from your image URL
    const bg = await loadImage(CERT_BG); 
    ctx.drawImage(bg, 0, 0, w, h);
    
    // Add soft ribbon patterns to background
    drawSoftRibbons(ctx, w, h);
    
    // Add student photo with beautiful gradient border
    const cx = w/2, cy = 800, r = 200;
    
    // Create beautiful gradient border
    createBeautifulGradientBorder(ctx, cx, cy, r, rank, borderThickness, borderOpacity);
    
    // Draw the photo if available
    if(photo && !photo.includes('Student</text>')) {
      try {
        const img = await loadImage(photo);
        ctx.save(); 
        ctx.beginPath(); 
        ctx.arc(cx, cy, r, 0, Math.PI * 2); 
        ctx.clip();
        
        const scale = Math.max(r * 2 / img.width, r * 2 / img.height);
        const x = cx - (img.width * scale) / 2;
        const y = cy - (img.height * scale) / 2;
        
        // Add shadow to photo
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 5;
        
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        ctx.restore();
        
        // Reset shadow
        ctx.shadowBlur = 0;
        ctx.shadowColor = 'transparent';
        
      } catch(e) {
        console.error("Error loading student photo:", e);
        drawPlaceholderPhoto(ctx, cx, cy, r, name, rank);
      }
    } else {
      drawPlaceholderPhoto(ctx, cx, cy, r, name, rank);
    }
    
    // Draw student name LOWER and with shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 4;
    
    ctx.fillStyle = '#073045';
    ctx.font = 'bold 56px "Poppins"';
    ctx.textAlign = 'center';
    // MOVED NAME DOWN FROM 1050 TO 1080
    ctx.fillText(name, cx, 1080);
    
    // Draw class and marks
    ctx.fillStyle = '#0d6efd';
    ctx.font = 'bold 36px "Poppins"';
    // MOVED MARKS DOWN FROM 1120 TO 1150
    ctx.fillText(`Class: ${cls} | Marks: ${mark}`, cx, 1150);
    
    // Draw rank text with NORMAL font (removed italic) and special styling
    const rankColor = rank === 'First' ? '#d4af37' : '#6c757d';
    
    ctx.fillStyle = rankColor;
    // CHANGED: Removed 'italic' from font style, made it normal
    ctx.font = 'bold 38px "Poppins"';
    
    // UPDATED: Removed star and trophy icons from rank text
    const rankText = rank === 'First' ? 'CLASS TOPPER' : 'second place in class'; // Changed to lowercase
    // MOVED RANK TEXT DOWN FROM 1180 TO 1210
    ctx.fillText(rankText, cx, 1210);
    
    // Add decorative underline
    ctx.beginPath();
    ctx.moveTo(cx - 200, 1220);
    ctx.lineTo(cx + 200, 1220);
    ctx.lineWidth = 3;
    ctx.strokeStyle = rankColor;
    ctx.setLineDash([10, 5]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Reset shadow
    ctx.shadowBlur = 0;
    ctx.shadowColor = 'transparent';
    
    return canvas;
  } catch(error) {
    console.error("Error rendering certificate:", error);
    throw new Error("Failed to load certificate background");
  }
}

// Draw placeholder photo with gradient border
function drawPlaceholderPhoto(ctx, cx, cy, r, name, rank) {
  // Draw gradient border for placeholder
  createBeautifulGradientBorder(ctx, cx, cy, r, rank, borderThickness, borderOpacity);
  
  // Draw placeholder background
  const solidColor = rank === 'First' ? '#fff8e1' : '#f8f9fa';
  
  ctx.fillStyle = solidColor;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  
  // Add decorative icon
  ctx.fillStyle = rank === 'First' ? '#d4af37' : '#6c757d';
  ctx.font = 'bold 48px "Font Awesome 6 Free"';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ðŸ‘¨â€ðŸŽ“', cx, cy);
}

// Preview certificate
async function previewCertificate(name, cls, mark, rank, photo) {
  try {
    showLoading();
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    hideLoading();
    
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = previewCanvas.getContext('2d');
    
    // Set canvas size for preview
    previewCanvas.width = 800;
    previewCanvas.height = 1067;
    
    // Draw scaled certificate
    ctx.drawImage(canvas, 0, 0, 1200, 1600, 0, 0, 800, 1067);
    
    // Show preview
    document.getElementById('certificatePreview').style.display = 'block';
    
    // Add download buttons to preview
    setTimeout(() => {
      const existingButtons = document.querySelector('.preview-buttons');
      if (existingButtons) existingButtons.remove();
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'preview-buttons';
      
      buttonContainer.innerHTML = `
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'png')" 
                style="background:linear-gradient(135deg, #ffd700, #ffcc00); color:#000; border: 2px solid #ffd700;">
          <i class="fas fa-download"></i> Download PNG
        </button>
        <button onclick="downloadCertificate('${name}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'pdf')" 
                style="background:linear-gradient(135deg, #0d6efd, #0b5ed7); color:white; border: 2px solid #0d6efd;">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      `;
      
      document.getElementById('certificatePreview').appendChild(buttonContainer);
    }, 100);
    
  } catch(error) {
    hideLoading();
    console.error("Error previewing certificate:", error);
    showNotification("Error previewing certificate. Please try again.", 'error');
  }
}

// Close certificate preview
function closeCertificatePreview() {
  document.getElementById('certificatePreview').style.display = 'none';
  const buttons = document.querySelector('.preview-buttons');
  if (buttons) buttons.remove();
}

// Download certificate
async function downloadCertificate(name, cls, mark, rank, photo, type) {
  try {
    showLoading();
    
    // Play sound
    const sound = document.getElementById("certSound"); 
    sound.currentTime = 0; 
    sound.play().catch(e => console.log("Audio play failed:", e));
    
    // Render certificate
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    const img = canvas.toDataURL("image/png");
    
    // Confetti celebration
    confetti({
      particleCount: 150,
      spread: 100,
      origin: { y: 0.6 },
      colors: rank === 'First' ? ['#ffd700', '#ffcc00', '#fff8e1', '#ffffff'] : ['#c0c0c0', '#6c757d', '#f8f9fa', '#ffffff']
    });
    
    // Update certificate count
    certCount++;
    localStorage.setItem('certCount', certCount);
    updateCertCount();
    
    // Generate output based on type
    const fileName = `Noorussalam_Class${cls}_${rank.replace(' ', '_')}_${name.replace(/\s+/g, '_')}`;
    
    if(type === "png") {
      const a = document.createElement("a"); 
      a.href = img; 
      a.download = `${fileName}.png`; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification(`PNG certificate for ${name} downloaded! ðŸŽ‰`, 'success');
    } else if(type === "pdf") {
      const { jsPDF } = window.jspdf; 
      const pdf = new jsPDF({orientation: "portrait", unit: "px", format: [1200, 1600]});
      pdf.addImage(img, "PNG", 0, 0, 1200, 1600); 
      pdf.save(`${fileName}.pdf`);
      showNotification(`PDF certificate for ${name} downloaded! ðŸŽ‰`, 'success');
    }
    
    hideLoading();
    
  } catch(error) {
    hideLoading();
    console.error("Error generating certificate:", error);
    showNotification("Error generating certificate. Please try again.", 'error');
  }
}

// Clear all uploaded photos
function clearAllPhotos() {
  if(confirm("Are you sure you want to clear all uploaded photos? This action cannot be undone.")) {
    classesData.forEach((cls, classIndex) => {
      cls.toppers.forEach((topper, topperIndex) => {
        localStorage.removeItem(`topperPhoto_${classIndex}_${topperIndex}`);
        uploadedPhotos[classIndex][topperIndex] = null;
        
        const img = document.querySelector(`#file-${classIndex}-${topperIndex}`)?.closest('.photo-frame')?.querySelector('img');
        if(img) img.src = placeholderDataURL();
      });
    });
    showNotification('All photos cleared successfully!', 'success');
  }
}

// Close modal when clicking outside the image
document.getElementById('previewModal').addEventListener('click', function(e) {
  if(e.target === this) closePreview();
});

document.getElementById('certificatePreview').addEventListener('click', function(e) {
  if(e.target === this) closeCertificatePreview();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if(e.key === 'Escape') {
    closePreview();
    closeCertificatePreview();
  } else if (e.key === 'Enter' && document.getElementById('classSearch').matches(':focus')) {
    e.preventDefault();
    searchClasses();
  }
});

// Initialize when page loads
window.addEventListener('load', function() {
  // Test if background image loads
  const testImg = new Image();
  testImg.onload = function() {
    console.log('Certificate background loaded successfully');
  };
  testImg.onerror = function() {
    showNotification('Note: Using fallback certificate design', 'info');
  };
  testImg.src = CERT_BG;
  
  // Load class cards
  loadClassCards();
  
  // Create class filter buttons
  createClassFilterButtons();
  
  // Initialize border controls
  initializeBorderControls();
  
  // Focus on search input
  document.getElementById('classSearch').focus();
});
</script>
</body>
</html>
