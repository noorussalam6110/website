<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Toppers - Noorussalam Madrasa</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
  --accent:#0d6efd;
  --gold:#ffd700;
  --card-radius:18px;
  --max-width:1100px;
  --bg1:#dff6ff;
  --bg2:#b4dbff;
}
html,body{height:100%}
body {
  margin:0;
  font-family: "Poppins", sans-serif;
  background: linear-gradient(120deg,var(--bg1),var(--bg2));
  background-size:300% 300%;
  animation: bgMove 12s infinite ease-in-out;
  color:#102a43;
  padding:18px;
}
@keyframes bgMove {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.wrapper{max-width:var(--max-width);margin:0 auto 60px;}
header{text-align:center;margin-bottom:18px;}
header h1{margin:8px 0;font-size:28px;color:var(--accent);letter-spacing:1px;}
header p{margin:0;color:#083344;opacity:0.9;}

.section-title{text-align:center;font-size:20px;margin:28px 0 12px;color:var(--accent);font-weight:700;}
.grid { display:grid; grid-template-columns:repeat(2,1fr); gap:20px; align-items:stretch; }
@media (max-width:800px){ .grid{grid-template-columns:1fr} }

.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
  border-radius:var(--card-radius);
  padding:20px;
  box-shadow:0 12px 28px rgba(2,6,23,0.08);
  position:relative; overflow:hidden;
  border:3px solid rgba(255,215,0,0.7);
  transition:transform .22s ease, box-shadow .22s ease;
}
.card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(2,6,23,0.14); }

/* shine overlay */
.card::after{
  content:"";
  position:absolute; top:-130%; left:-100%; width:250%; height:350%; transform:rotate(22deg);
  background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%);
  animation: shineMove 5s linear infinite; pointer-events:none;
}
@keyframes shineMove{0%{transform:translateX(-140%) rotate(22deg)}30%{transform:translateX(140%) rotate(22deg)}100%{transform:translateX(140%) rotate(22deg)}}

.medal{
  width:68px; height:68px; border-radius:50%; background:var(--gold);
  display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:22px;
  box-shadow:0 6px 18px rgba(255,215,0,0.5); margin:0 auto 10px;
}
.photo{ width:110px; height:110px; border-radius:50%; overflow:hidden; margin:8px auto; border:4px solid var(--accent); box-shadow:0 6px 18px rgba(13,110,253,0.18); }
.photo img{width:100%;height:100%;object-fit:cover;display:block}
.name{ font-size:18px; font-weight:700; color:#043a54; text-align:center; margin-top:6px; }
.meta{text-align:center;color:#1f3f5b;font-weight:600;margin-top:6px}
.btns{ margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
.btn{ padding:10px 12px; border-radius:10px; cursor:pointer; border:none; font-weight:700; }
.btn-download{ background:var(--gold); color:#000 }
.btn-print{ background:var(--accent); color:#fff }

footer{ margin-top:32px; text-align:center; color:#01303f; opacity:0.9; }

.top-container{ display:flex; gap:14px; align-items:center; justify-content:center; flex-direction:column; margin-bottom:8px; }

/* small screens nicety */
@media (max-width:520px){
  .btns{flex-direction:column}
  .card{padding:16px}
}
</style>
</head>
<body>
  <div class="wrapper">
    <header>
      <h1>NOORUSSALAM MADRASA ‚Äî TOPPERS</h1>
      <p>Auto-load from Google Sheet ‚Ä¢ Certificates in English + Arabic ‚Ä¢ Signature & date auto</p>
    </header>

    <div class="top-container">
      <div class="section-title">üèÜ Class Toppers ‚Äî Marks (First Rank only)</div>
      <div class="muted">Data loads automatically from your Google Sheet (RANK = 1)</div>
    </div>

    <div id="marksGrid" class="grid" aria-live="polite"></div>

    <div class="top-container" style="margin-top:28px">
      <div class="section-title">üìñ Class Toppers ‚Äî Hajar / Hifz (First Rank only)</div>
      <div class="muted">Hajar/Hifz rows (SECTION column = HAJAR or HIFZ)</div>
    </div>

    <div id="hajarGrid" class="grid" aria-live="polite"></div>

    <footer>¬© Noorussalam Madrasa ‚Äî Auto certificates include Arabic & English ‚Ä¢ Auto date ‚Ä¢ Principal signature</footer>
  </div>

  <!-- In-browser "medal" sound (short tone) -->
  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playMedalSound(){
      try{
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(880, audioCtx.currentTime);
        g.gain.setValueAtTime(0, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.12, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.45);
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + 0.5);
      }catch(e){}
    }
  </script>

  <!-- Certificate generator uses local uploaded files:
       - CERTIFICATR.jpg       (certificate background)
       - WhatsApp Image 2025-11-26 at 11.41.41 AM.jpeg   (principal signature image)
       Make sure both are placed in same folder as this HTML file.
  -->
  <script>
  // paths (local files you uploaded)
  const CERT_BG_SRC = "CERTIFICATR.jpg";
  const SIG_SRC = "WhatsApp Image 2025-11-26 at 11.41.41 AM.jpeg";

  // Confetti helper
  function launchConfetti(){
    confetti({ particleCount: 150, spread: 90, startVelocity: 60, origin:{ y:0.6 } });
    setTimeout(()=>confetti({ particleCount: 120, spread: 70, startVelocity: 45, origin:{ y:0.6 } }), 320);
  }

  // generate certificate: draws background, text (eng+arabic), optional photo, signature, date
  // name, rank, classname, photoURL (optional), mode: "download" or "print"
  function generateCertificate(name, rank, classname, photoURL, mode="download"){
    const width = 1920, height = 1280;
    const canvas = document.createElement("canvas");
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext("2d");

    const bg = new Image();
    const sig = new Image();
    bg.src = CERT_BG_SRC;
    sig.src = SIG_SRC;

    bg.onload = () => {
      ctx.drawImage(bg, 0, 0, width, height);

      // draw photo circle left if provided
      const drawAfterPhoto = () => {
        // Titles (English + Arabic)
        ctx.textAlign = "center";
        ctx.fillStyle = "#000";

        ctx.font = "bold 72px Poppins";
        ctx.fillText("Certificate of Excellence", width/2, 300);

        ctx.font = "bold 64px Amiri, serif";
        ctx.fillText("ÿ¥ŸáÿßÿØÿ© ÿßŸÑÿ™ŸÅŸàŸÇ", width/2, 360);

        // Student Name (English)
        ctx.font = "bold 82px Poppins";
        ctx.fillText(name, width/2, 520);

        // Student Name (Arabic) ‚Äî repeat name (you can change to Arabic transliteration)
        ctx.font = "bold 70px Amiri, serif";
        ctx.fillText(name, width/2, 600);

        // Class & Rank (both languages)
        ctx.font = "40px Poppins";
        ctx.fillText(`Class: ${classname}   |   Rank: ${rank}`, width/2, 700);

        ctx.font = "36px Amiri, serif";
        ctx.fillText(`ÿßŸÑÿµŸÅ: ${classname}   |   ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®: ${rank}`, width/2, 760);

        // Auto date bottom-left
        const today = new Date();
        const opts = { year:'numeric', month:'long', day:'numeric' };
        const dateStr = today.toLocaleDateString('en-GB', opts);
        ctx.textAlign = "left";
        ctx.font = "28px Poppins";
        ctx.fillText(dateStr, 180, height - 160);

        // draw signature bottom-right when ready
        const drawSignatureAndFinish = () => {
          // signature size and position (tweak these numbers if needed)
          const sigW = 380, sigH = 140;
          ctx.drawImage(sig, width - 550, height - 330, sigW, sigH);

          // finalize: download or print
          const dataURL = canvas.toDataURL("image/png");
          if(mode === "download"){
            const a = document.createElement("a");
            a.href = dataURL; a.download = `${name}-certificate.png`; a.click();
            launchConfetti();
          } else if(mode === "print"){
            const w = window.open("");
            w.document.write(`<img src="${dataURL}" style="width:100%;height:auto;">`);
            setTimeout(()=>w.print(),500);
          }
        };

        if(sig.complete){
          drawSignatureAndFinish();
        } else {
          sig.onload = drawSignatureAndFinish;
          sig.onerror = drawSignatureAndFinish;
        }
      };

      if(photoURL){
        const photo = new Image();
        photo.crossOrigin = "anonymous";
        photo.src = photoURL;
        photo.onload = () => {
          // draw circular photo at a left position (tweak coords as needed)
          const px = 300, py = 470, pr = 150;
          ctx.save();
          ctx.beginPath();
          ctx.arc(px+pr/2, py+pr/2, pr/2, 0, Math.PI*2);
          ctx.closePath();
          ctx.clip();
          ctx.drawImage(photo, px, py, pr, pr);
          ctx.restore();
          drawAfterPhoto();
        };
        photo.onerror = () => {
          drawAfterPhoto();
        };
      } else {
        drawAfterPhoto();
      }
    };

    bg.onerror = () => {
      alert("Certificate background failed to load. Make sure CERTIFICATR.jpg is in the same folder as this HTML.");
    };
  }

  function downloadCertificate(name, rank, classname, photoURL){
    generateCertificate(name, rank, classname, photoURL, "download");
  }
  function printCertificate(name, rank, classname, photoURL){
    generateCertificate(name, rank, classname, photoURL, "print");
  }
  </script>

  <!-- ======= Auto-load toppers from Google Sheet (opensheet.elk.sh) =======
       Instructions:
       1) Publish your Google Sheet (File ‚Üí Share ‚Üí Publish to web)
       2) Replace YOUR_SHEET_ID below with your sheet id.
       3) Ensure your sheet header row contains EXACT column names:
          CLASS | NAME | MARK | PHOTO | RANK | SECTION
       4) SECTION should be "MARK" for marks toppers or "HAJAR"/"HIFZ" for hajar section.
  -->
  <script>
    // EDIT THIS: put your sheet ID and sheet name (tab)
    const sheetID = "YOUR_SHEET_ID"; // <-- REPLACE this
    const sheetTab = "Sheet1";       // <-- change if your tab name is different

    const sheetURL = `https://opensheet.elk.sh/${sheetID}/${sheetTab}`;

    // Simple helper functions
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function jsLiteral(s){ if(s===undefined||s===null) return "''"; return "'" + String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n') + "'"; }

    // placeholders while loading
    document.getElementById("marksGrid").innerHTML = '<div style="grid-column:1/-1;padding:18px;background:#ffffffcc;border-radius:12px;">Loading toppers‚Ä¶</div>';

    fetch(sheetURL).then(r=>{
      if(!r.ok) throw new Error("Failed to fetch sheet. Check sheet ID and that you published the sheet.");
      return r.json();
    }).then(rows=>{
      // clear placeholders
      document.getElementById("marksGrid").innerHTML = "";
      document.getElementById("hajarGrid").innerHTML = "";

      // rows is array of row objects (keys from header)
      // filter to RANK==1 (accepted forms: "1", "1st", "First")
      const firstRank = rows.filter(r => {
        const rankVal = (r.RANK || r.rank || r.Rank || "").toString().trim().toLowerCase();
        return rankVal === "1" || rankVal === "1st" || rankVal.startsWith("1");
      });

      if(firstRank.length === 0){
        document.getElementById("marksGrid").innerHTML = '<div style="grid-column:1/-1;padding:18px;background:#fff7;border-radius:12px;">No Rank=1 rows found. Make sure your sheet has RANK column and value "1".</div>';
        return;
      }

      firstRank.forEach(r => {
        const CLASS = r.CLASS || r.class || r.Class || "";
        const NAME = r.NAME || r.name || "";
        const MARK = r.MARK || r.mark || r.Score || "";
        const PHOTO = r.PHOTO || r.photo || "";
        const SECTION = (r.SECTION || r.section || "").toString().trim().toUpperCase();

        // build card
        const card = document.createElement("div");
        card.className = "card";
        const safeName = escapeHtml(NAME || "‚Äî");
        const safeClass = escapeHtml(CLASS || "");
        const safeMark = escapeHtml(MARK || "");

        // Photo fallback to small inline SVG if PHOTO missing
        const photoURL = PHOTO || placeholderDataURL();

        card.innerHTML = `
          <div class="medal">1</div>
          <div class="photo"><img src="${photoURL}" alt="${safeName}"></div>
          <div class="name">${safeName}</div>
          <div class="meta">Class ${safeClass} ${safeMark ? " ‚Ä¢ " + safeMark : ""}</div>
          <div class="btns">
            <button class="btn btn-download" onclick="playMedalSound(); downloadCertificate(${jsLiteral(NAME)}, ${jsLiteral('1st Rank')}, ${jsLiteral('Class ' + CLASS)}, ${jsLiteral(photoURL)})">
              <i class="fa fa-download"></i>&nbsp;Download
            </button>
            <button class="btn btn-print" onclick="playMedalSound(); printCertificate(${jsLiteral(NAME)}, ${jsLiteral('1st Rank')}, ${jsLiteral('Class ' + CLASS)}, ${jsLiteral(photoURL)})">
              <i class="fa fa-print"></i>&nbsp;Print
            </button>
          </div>
        `;

        if(SECTION === "HAJAR" || SECTION === "HIFZ"){
          document.getElementById("hajarGrid").appendChild(card);
        } else {
          document.getElementById("marksGrid").appendChild(card);
        }
      });

    }).catch(err=>{
      console.error(err);
      document.getElementById("marksGrid").innerHTML = `<div style="grid-column:1/-1;padding:18px;background:#fff7;border-radius:12px;">Error loading sheet: ${escapeHtml(err.message)}<br><small>Make sure you published the sheet and the sheet ID is correct.</small></div>`;
    });

    // small SVG placeholder
    function placeholderDataURL(){
      const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220"><rect width="100%" height="100%" fill="#eef9ff"/><circle cx="110" cy="84" r="48" fill="#cfeeff"/><rect x="30" y="150" width="160" height="30" rx="15" fill="#cfeeff"/></svg>');
      return 'data:image/svg+xml;utf8,' + svg;
    }
  </script>

  <!-- Instructions: Replace YOUR_SHEET_ID above with your actual Google Sheet ID. -->
  <!-- Example: https://opensheet.elk.sh/1cxKIqAfXttNjB6QLw8xkjPrzLaQm6MtgXB6oXHLdPzA/Sheet1 -->

</body>
</html>
