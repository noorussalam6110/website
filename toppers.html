<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Class Toppers | Noorussalam Madrasa</title>

<link href="https://fonts.googleapis.com/css2?family=Anek+Tamil:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --primary: #1a237e;
  --secondary: #ffd700;
  --accent: #1976d2;
  --accent-alt: #4caf50;
  --danger: #e53935;
  --light: #f5f7ff;
  --dark: #0d1b36;
  --white: #ffffff;
  --gray: #5d6c89;
  --gold: #d4af37;
  --silver: #a8b2c1;
  
  --gradient-primary: linear-gradient(135deg, #1a237e 0%, #283593 100%);
  --gradient-secondary: linear-gradient(135deg, #ffd700 0%, #ffca28 100%);
  --gradient-accent: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  --gradient-danger: linear-gradient(135deg, #e53935 0%, #c62828 100%);
  --gradient-gold: linear-gradient(135deg, #ffd700, #d4af37, #ffb300);
  --gradient-silver: linear-gradient(135deg, #e0e0e0, #b0bec5, #90a4ae);
  
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.15);
  
  --radius: 10px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
  font-family: "Anek Tamil", sans-serif;
  background: linear-gradient(135deg, #f0f5ff 0%, #e8f0ff 100%);
  color: var(--dark);
  min-height: 100vh;
  padding: 15px;
  position: relative;
  overflow-x: hidden;
  font-size: 14px;
}

.wrap {
  max-width: 1300px;
  margin: 0 auto;
  position: relative;
}

/* Admin Header */
.admin-header {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
}

.admin-btn {
  padding: 10px 20px;
  background: var(--gradient-danger);
  color: var(--white);
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  gap: 8px;
}

.admin-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Login Modal */
.login-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(13, 27, 54, 0.95);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.login-container {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  width: 100%;
  max-width: 400px;
  padding: 40px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  border: 1px solid rgba(255, 255, 255, 0.8);
  position: relative;
}

.close-login {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 24px;
  color: var(--gray);
  cursor: pointer;
  transition: var(--transition);
}

.close-login:hover {
  color: var(--danger);
  transform: rotate(90deg);
}

.login-header {
  text-align: center;
  margin-bottom: 30px;
}

.login-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 10px;
}

.login-header p {
  color: var(--gray);
  font-size: 14px;
}

.login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  color: var(--primary);
  font-size: 14px;
}

.form-group input {
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
  background: var(--white);
  transition: var(--transition);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

.login-btn {
  padding: 14px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.login-error {
  color: var(--danger);
  font-size: 13px;
  text-align: center;
  margin-top: 10px;
  display: none;
}

/* Header Section */
.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 25px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.8);
}

.header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
}

.logo-container {
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.logo-icon {
  width: 80px;
  height: 80px;
  background: var(--gradient-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 34px;
  color: var(--white);
  box-shadow: var(--shadow-lg);
  border: 3px solid var(--white);
}

.header h1 {
  font-size: 32px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 8px 0;
}

.subtitle {
  font-size: 16px;
  color: var(--primary);
  font-weight: 500;
  margin: 8px 0;
}

.tagline {
  display: inline-block;
  padding: 10px 24px;
  background: var(--gradient-secondary);
  color: var(--dark);
  font-weight: 600;
  border-radius: 50px;
  margin-top: 12px;
  box-shadow: var(--shadow-sm);
}

/* Stats Section */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin: 30px 0;
}

.stat-card {
  background: var(--white);
  padding: 20px 15px;
  border-radius: var(--radius-lg);
  text-align: center;
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(255, 255, 255, 0.8);
  transition: var(--transition);
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.stat-number {
  font-size: 34px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: var(--gray);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

/* Admin Panel */
.admin-panel {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow-lg);
  display: none; /* Hidden by default */
}

.admin-panel.active {
  display: block;
}

.admin-panel h3 {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 20px;
  text-align: center;
}

/* Admin Tabs */
.admin-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 25px;
  background: rgba(26, 35, 126, 0.05);
  padding: 5px;
  border-radius: var(--radius);
}

.admin-tab {
  flex: 1;
  padding: 12px;
  border: none;
  background: transparent;
  color: var(--gray);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.admin-tab.active {
  background: var(--white);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Excel Upload Tab */
.upload-controls {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 20px;
}

.file-input-wrapper {
  flex: 1;
  min-width: 300px;
  max-width: 500px;
}

#excelFile {
  width: 100%;
  padding: 15px;
  border: 2px dashed var(--primary);
  border-radius: var(--radius);
  background: rgba(26, 35, 126, 0.05);
  cursor: pointer;
}

.upload-excel-btn {
  padding: 15px 30px;
  background: var(--gradient-accent);
  color: var(--white);
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
}

.upload-excel-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.sample-link {
  text-align: center;
  margin-top: 15px;
}

.sample-link a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
}

.sample-link a:hover {
  text-decoration: underline;
}

/* Google Sheets Tab */
.sheet-config {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 25px;
}

.config-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.config-group label {
  font-weight: 600;
  color: var(--primary);
  font-size: 14px;
}

.config-group input {
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
  background: var(--white);
  transition: var(--transition);
}

.config-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

.help-text {
  font-size: 12px;
  color: var(--gray);
  margin-top: 4px;
}

.sheet-controls {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 20px;
}

.sheet-btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow-md);
}

.sheet-btn.primary {
  background: var(--gradient-primary);
  color: var(--white);
}

.sheet-btn.secondary {
  background: var(--gradient-accent);
  color: var(--white);
}

.sheet-btn.warning {
  background: var(--gradient-secondary);
  color: var(--dark);
}

.sheet-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.sheet-status {
  text-align: center;
  margin-top: 20px;
  padding: 12px;
  border-radius: var(--radius);
  font-weight: 600;
  display: none;
}

.sheet-status.success {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.05) 100%);
  color: #2e7d32;
  border: 2px solid rgba(76, 175, 80, 0.2);
}

.sheet-status.error {
  background: linear-gradient(135deg, rgba(229, 57, 53, 0.1) 0%, rgba(198, 40, 40, 0.05) 100%);
  color: #c62828;
  border: 2px solid rgba(229, 57, 53, 0.2);
}

/* Search Section */
.search-container {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.search-container::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.search-header {
  text-align: center;
  margin-bottom: 25px;
}

.search-header h3 {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.search-box {
  display: flex;
  gap: 12px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.search-input-wrapper {
  flex: 1;
  min-width: 280px;
  max-width: 450px;
  position: relative;
}

.search-input-wrapper i {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
  font-size: 16px;
}

#classSearch {
  width: 100%;
  padding: 15px 18px 15px 45px;
  border: 2px solid #e2e8f0;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
  background: var(--white);
  transition: var(--transition);
}

#classSearch:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

.search-btn, .clear-search-btn {
  padding: 15px 30px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow-md);
}

.search-btn {
  background: var(--gradient-primary);
  color: var(--white);
}

.clear-search-btn {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  color: var(--white);
}

.search-btn:hover, .clear-search-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.class-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 15px;
}

.class-filter-btn {
  padding: 10px 20px;
  background: var(--white);
  border: 2px solid #e2e8f0;
  border-radius: 50px;
  color: var(--primary);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.class-filter-btn:hover {
  background: rgba(26, 35, 126, 0.05);
  border-color: var(--primary);
}

.class-filter-btn.active {
  background: var(--gradient-primary);
  color: var(--white);
  border-color: var(--primary);
}

.search-results-info {
  text-align: center;
  margin-top: 15px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 202, 40, 0.05) 100%);
  border-radius: var(--radius);
  font-weight: 600;
  color: var(--primary);
  border: 2px solid rgba(255, 215, 0, 0.2);
  display: none;
  font-size: 13px;
}

/* Classes Section */
.classes-header {
  text-align: center;
  margin: 40px 0 30px;
}

.classes-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 12px;
}

.classes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.class-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  border-radius: var(--radius-xl);
  padding: 25px;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.class-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-xl);
}

.class-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.class-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px dashed rgba(26, 35, 126, 0.1);
}

.class-header h3 {
  font-size: 20px;
  color: var(--primary);
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* Topper Cards */
.topper-card {
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

.topper-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.topper-card.first {
  border-left: 4px solid var(--gold);
  background: linear-gradient(135deg, rgba(255, 251, 235, 0.9) 0%, rgba(254, 243, 199, 0.9) 100%);
}

.topper-card.second {
  border-left: 4px solid var(--silver);
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.9) 100%);
}

.rank-badge {
  position: absolute;
  top: -12px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  color: var(--white);
  z-index: 2;
  box-shadow: var(--shadow-md);
  border: 3px solid var(--white);
}

.rank-badge.first {
  background: var(--gradient-gold);
  color: #92400e;
}

.rank-badge.second {
  background: var(--gradient-silver);
}

.photo-display {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 15px;
}

.upload-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 10px auto 15px;
  padding: 10px 24px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-md);
  width: 100%;
  max-width: 200px;
}

.upload-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.student-name {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  margin: 10px 0 8px;
  padding: 0 10px;
}

.rank-label {
  text-align: center;
  font-weight: 700;
  margin: 8px 0;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 6px 18px;
  border-radius: 50px;
  display: inline-block;
  box-shadow: var(--shadow-sm);
}

.rank-label.first {
  background: var(--gradient-gold);
  color: #92400e;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.rank-label.second {
  background: var(--gradient-silver);
  color: #1e293b;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.student-meta {
  text-align: center;
  color: var(--accent);
  font-weight: 600;
  margin: 10px 0;
  font-size: 14px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(25, 118, 210, 0.1) 0%, rgba(33, 150, 243, 0.05) 100%);
  border-radius: 50px;
  display: inline-block;
  border: 1px solid rgba(25, 118, 210, 0.2);
}

.action-buttons {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.preview-btn {
  padding: 12px 24px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  background: var(--gradient-primary);
  color: var(--white);
  box-shadow: var(--shadow-md);
}

.preview-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Footer */
.footer {
  text-align: center;
  color: var(--gray);
  margin-top: 40px;
  padding: 30px 25px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  border-top: 4px solid var(--primary);
}

.cert-count {
  font-weight: 800;
  color: var(--primary);
  font-size: 20px;
  display: inline-block;
  margin: 0 4px;
}

/* Loading Overlay */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(13, 27, 54, 0.95);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: var(--white);
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  border-top-color: var(--secondary);
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Certificate Preview Modal */
#certificatePreview {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.98);
  z-index: 10000;
  overflow: auto;
  padding: 20px;
}

.certificate-canvas {
  background: var(--white);
  width: 850px;
  max-width: 95%;
  margin: 30px auto;
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
}

.close-preview {
  position: fixed;
  top: 25px;
  right: 35px;
  font-size: 36px;
  color: var(--white);
  cursor: pointer;
  background: rgba(255, 255, 255, 0.1);
  width: 55px;
  height: 55px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.close-preview:hover {
  background: rgba(239, 68, 68, 0.9);
  transform: rotate(90deg) scale(1.1);
}

.preview-buttons {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10001;
  flex-wrap: wrap;
  justify-content: center;
  padding: 15px;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(10px);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.preview-buttons button {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
  font-size: 14px;
  box-shadow: var(--shadow-lg);
  min-width: 180px;
  justify-content: center;
}

.preview-buttons button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-xl);
}

/* Responsive Design */
@media (max-width: 768px) {
  .classes-grid {
    grid-template-columns: 1fr;
  }
  
  .search-box {
    flex-direction: column;
  }
  
  .search-input-wrapper {
    min-width: 100%;
  }
  
  .admin-header {
    position: static;
    text-align: center;
    margin-bottom: 20px;
  }
  
  .upload-controls,
  .sheet-controls {
    flex-direction: column;
  }
  
  .file-input-wrapper,
  .upload-excel-btn,
  .sheet-btn {
    width: 100%;
  }
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>

<!-- Admin Login Button -->
<div class="admin-header">
  <button class="admin-btn" onclick="openLoginModal()">
    <i class="fas fa-lock"></i> Admin Login
  </button>
</div>

<!-- Login Modal -->
<div class="login-modal" id="loginModal">
  <div class="login-container">
    <span class="close-login" onclick="closeLoginModal()">&times;</span>
    
    <div class="login-header">
      <h2>Admin Login</h2>
      <p>Access the admin panel to manage student data</p>
    </div>
    
    <form class="login-form" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="adminUsername">Username</label>
        <input type="text" id="adminUsername" placeholder="Enter username" required>
      </div>
      
      <div class="form-group">
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter password" required>
      </div>
      
      <button type="submit" class="login-btn">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="login-error" id="loginError">
        Invalid username or password
      </div>
    </form>
  </div>
</div>

<div class="wrap">
  <!-- Header Section -->
  <header class="header">
    <div class="header-content">
      <div class="logo-container">
        <div class="logo-icon">
          <i class="fas fa-award"></i>
        </div>
        <div>
          <h1>NOORUSSALAM MADRASA</h1>
          <p class="subtitle">Annual Examination Results 2025-26</p>
          <p class="tagline">Celebrating Excellence</p>
        </div>
      </div>
      
      <!-- Stats Section -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="classCount">0</div>
          <div class="stat-label">Classes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="studentCount">0</div>
          <div class="stat-label">Top Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">100%</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="certCount">0</div>
          <div class="stat-label">Certificates Generated</div>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Admin Panel (Hidden by default) -->
  <div class="admin-panel" id="adminPanel">
    <h3>Admin Panel - Manage Student Data</h3>
    
    <!-- Admin Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('excel')">
        <i class="fas fa-file-excel"></i> Excel Upload
      </button>
      <button class="admin-tab" onclick="switchTab('google')">
        <i class="fab fa-google"></i> Google Sheets
      </button>
    </div>
    
    <!-- Excel Upload Tab -->
    <div id="excel-tab" class="tab-content active">
      <div class="upload-controls">
        <div class="file-input-wrapper">
          <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="file-input">
        </div>
        <button class="upload-excel-btn" onclick="uploadExcel()">
          <i class="fas fa-upload"></i> Upload Excel File
        </button>
      </div>
      
      <div class="sample-link">
        <a href="#" onclick="downloadSampleTemplate()">
          <i class="fas fa-download"></i> Download Sample Template
        </a>
      </div>
    </div>
    
    <!-- Google Sheets Tab -->
    <div id="google-tab" class="tab-content">
      <div class="sheet-config">
        <div class="config-group">
          <label for="sheetId">Google Sheet ID:</label>
          <input type="text" id="sheetId" placeholder="Enter Google Sheet ID">
          <div class="help-text">
            Example: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms
            <br>
            <a href="https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit" target="_blank">View Sample Sheet</a>
          </div>
        </div>
        
        <div class="config-group">
          <label for="sheetName">Sheet Name:</label>
          <input type="text" id="sheetName" value="Students" placeholder="Enter sheet name">
          <div class="help-text">Name of the sheet/tab in your Google Sheet (default: Students)</div>
        </div>
        
        <div class="config-group">
          <label for="apiKey">API Key (Optional):</label>
          <input type="password" id="apiKey" placeholder="Enter your Google API Key">
          <div class="help-text">
            Get API key from <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a>
            <br>Using default key for demo. For production, use your own key.
          </div>
        </div>
      </div>
      
      <div class="sheet-controls">
        <button class="sheet-btn primary" onclick="loadFromGoogleSheets()">
          <i class="fas fa-sync-alt"></i> Load from Google Sheets
        </button>
        <button class="sheet-btn secondary" onclick="saveToGoogleSheets()">
          <i class="fas fa-save"></i> Save to Google Sheets
        </button>
        <button class="sheet-btn warning" onclick="showSheetInstructions()">
          <i class="fas fa-info-circle"></i> How to Setup
        </button>
      </div>
      
      <div class="sheet-status" id="sheetStatus"></div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="logoutAdmin()" style="padding: 10px 20px; background: var(--gradient-danger); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">
          <i class="fas fa-sign-out-alt"></i> Logout Admin
        </button>
      </div>
    </div>
  </div>
  
  <!-- Search Section -->
  <div class="search-container">
    <div class="search-header">
      <h3>Find Students & Classes</h3>
      <p>Search by class number or student name to filter results</p>
    </div>
    
    <div class="search-box">
      <div class="search-input-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="classSearch" placeholder="Type class number or student name..." autocomplete="off">
      </div>
      <button class="search-btn" onclick="searchClasses()">
        <i class="fas fa-search"></i> Search
      </button>
      <button class="clear-search-btn" onclick="clearSearch()">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
    
    <div class="class-filters" id="classFilterButtons">
      <!-- Class filter buttons will be generated by JavaScript -->
    </div>
    
    <div class="search-results-info" id="searchResultsInfo"></div>
  </div>
  
  <!-- Classes Section -->
  <div class="classes-header">
    <h2>Class Toppers & Achievers</h2>
    <p>Select a class to view top performers and generate certificates</p>
  </div>
  
  <div id="grid" class="classes-grid"></div>
  
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <h3>Noorussalam Madrasa</h3>
      <p>Kambippalam-Kerala Estate ‚Ä¢ Academic Year 2025-2026</p>
      <p>Certificates Generated: <span class="cert-count" id="certCountFooter">0</span></p>
      <p>Designed with <i class="fas fa-heart" style="color: #ff5252;"></i> By Suhail Kerala</p>
      <p style="margin-top: 15px; font-size: 12px; color: #94a3b8;">¬© 2025-2026 All Rights Reserved</p>
    </div>
  </footer>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p id="loadingText">Loading...</p>
</div>

<!-- Certificate Preview Modal -->
<div id="certificatePreview">
  <div class="close-preview" onclick="closeCertificatePreview()">√ó</div>
  <canvas id="previewCanvas" class="certificate-canvas"></canvas>
</div>

<script>
// Configuration
const CERT_BG = "NSM TOPPER copy (1).webp";

// Default Google API Key (for demo purposes)
const DEFAULT_API_KEY = 'AIzaSyC_bXq3OSCvzwlE2-kjqwEaPG1Wf4wT0MY';

// Admin credentials
const ADMIN_CREDENTIALS = {
  username: "admin",
  password: "noorussalam@2025" // Change this in production
};

// Global variables
let classesData = [];
let uploadedPhotos = {};
let certCount = parseInt(localStorage.getItem('certCount') || '0');
let activeSearch = '';
let isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';

// Initialize when page loads
window.addEventListener('load', function() {
  updateCertCount();
  
  // Check admin login status
  if (isAdminLoggedIn) {
    showAdminPanel();
  }
  
  // Load saved Google Sheet configuration
  loadSheetConfig();
  
  // Load data from localStorage first
  loadFromLocalStorage();
  
  // Add event listener for Excel file upload
  document.getElementById('excelFile').addEventListener('change', handleFileSelect);
});

// Admin Functions
function openLoginModal() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('adminUsername').focus();
}

function closeLoginModal() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('adminUsername').value = '';
  document.getElementById('adminPassword').value = '';
}

function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('adminUsername').value.trim();
  const password = document.getElementById('adminPassword').value.trim();
  
  if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
    // Successful login
    isAdminLoggedIn = true;
    localStorage.setItem('isAdminLoggedIn', 'true');
    
    showNotification('Admin login successful!', 'success');
    closeLoginModal();
    showAdminPanel();
  } else {
    // Failed login
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
}

function showAdminPanel() {
  document.getElementById('adminPanel').classList.add('active');
  document.querySelector('.admin-btn').innerHTML = '<i class="fas fa-user-cog"></i> Admin Panel';
  document.querySelector('.admin-btn').onclick = function() {
    document.getElementById('adminPanel').classList.toggle('active');
  };
}

function logoutAdmin() {
  isAdminLoggedIn = false;
  localStorage.removeItem('isAdminLoggedIn');
  
  document.getElementById('adminPanel').classList.remove('active');
  document.querySelector('.admin-btn').innerHTML = '<i class="fas fa-lock"></i> Admin Login';
  document.querySelector('.admin-btn').onclick = openLoginModal;
  
  showNotification('Logged out successfully', 'success');
}

// Tab Switching
function switchTab(tabName) {
  // Remove active class from all tabs
  document.querySelectorAll('.admin-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Activate selected tab
  document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
}

// Google Sheets Configuration
function loadSheetConfig() {
  const savedSheetId = localStorage.getItem('googleSheetId');
  const savedSheetName = localStorage.getItem('googleSheetName');
  const savedApiKey = localStorage.getItem('googleApiKey');
  
  if (savedSheetId) document.getElementById('sheetId').value = savedSheetId;
  if (savedSheetName) document.getElementById('sheetName').value = savedSheetName || 'Students';
  if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
}

function saveSheetConfig() {
  const sheetId = document.getElementById('sheetId').value.trim();
  const sheetName = document.getElementById('sheetName').value.trim() || 'Students';
  const apiKey = document.getElementById('apiKey').value.trim();
  
  if (sheetId) {
    localStorage.setItem('googleSheetId', sheetId);
    localStorage.setItem('googleSheetName', sheetName);
    if (apiKey) {
      localStorage.setItem('googleApiKey', apiKey);
    }
    showNotification('Google Sheets configuration saved', 'success');
  }
}

// Load from Google Sheets
async function loadFromGoogleSheets() {
  if (!isAdminLoggedIn) {
    showNotification('Please login as admin first', 'warning');
    openLoginModal();
    return;
  }
  
  const sheetId = document.getElementById('sheetId').value.trim();
  const sheetName = document.getElementById('sheetName').value.trim() || 'Students';
  const apiKey = document.getElementById('apiKey').value.trim() || DEFAULT_API_KEY;
  
  if (!sheetId) {
    showNotification('Please enter Google Sheet ID', 'error');
    return;
  }
  
  saveSheetConfig();
  showLoading('Loading data from Google Sheets...');
  
  try {
    // Using Google Sheets API v4
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.values || data.values.length === 0) {
      throw new Error('No data found in the sheet. Please check sheet name.');
    }
    
    processGoogleSheetsData(data.values);
    showStatus('Data loaded from Google Sheets successfully!', 'success');
    showNotification('Data loaded from Google Sheets', 'success');
    
  } catch (error) {
    console.error('Error loading from Google Sheets:', error);
    showStatus(`Error: ${error.message}. Check Sheet ID and API Key.`, 'error');
    showNotification('Failed to load from Google Sheets', 'error');
    
  } finally {
    hideLoading();
  }
}

// Save to Google Sheets
async function saveToGoogleSheets() {
  if (!isAdminLoggedIn) {
    showNotification('Please login as admin first', 'warning');
    openLoginModal();
    return;
  }
  
  const sheetId = document.getElementById('sheetId').value.trim();
  const sheetName = document.getElementById('sheetName').value.trim() || 'Students';
  const apiKey = document.getElementById('apiKey').value.trim() || DEFAULT_API_KEY;
  
  if (!sheetId) {
    showNotification('Please enter Google Sheet ID', 'error');
    return;
  }
  
  if (classesData.length === 0) {
    showNotification('No student data to save', 'warning');
    return;
  }
  
  saveSheetConfig();
  showLoading('Saving data to Google Sheets...');
  
  try {
    // Convert classesData to Google Sheets format
    const headers = ['Class', 'Name', 'Marks', 'Rank'];
    const values = [];
    
    classesData.forEach(cls => {
      cls.toppers.forEach(topper => {
        values.push([
          cls.class,
          topper.name,
          topper.mark,
          topper.rank
        ]);
      });
    });
    
    // Add headers
    const data = [headers, ...values];
    
    // Using Google Sheets API v4 to update
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?valueInputOption=RAW&key=${apiKey}`;
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        values: data
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
    }
    
    showStatus('Data saved to Google Sheets successfully!', 'success');
    showNotification('Data saved to Google Sheets', 'success');
    
  } catch (error) {
    console.error('Error saving to Google Sheets:', error);
    showStatus(`Error: ${error.message}`, 'error');
    showNotification('Failed to save to Google Sheets', 'error');
    
  } finally {
    hideLoading();
  }
}

// Process Google Sheets data
function processGoogleSheetsData(rows) {
  if (!rows || rows.length < 2) return;
  
  const headers = rows[0];
  const data = rows.slice(1);
  
  // Find column indices (case-insensitive)
  const classIndex = headers.findIndex(h => 
    h && h.toString().toLowerCase().includes('class')
  );
  const nameIndex = headers.findIndex(h => 
    h && h.toString().toLowerCase().includes('name')
  );
  const marksIndex = headers.findIndex(h => 
    h && h.toString().toLowerCase().includes('mark')
  );
  const rankIndex = headers.findIndex(h => 
    h && h.toString().toLowerCase().includes('rank')
  );
  
  const classesMap = {};
  
  data.forEach(row => {
    const className = classIndex >= 0 ? (row[classIndex] || '').toString().trim() : '';
    const studentName = nameIndex >= 0 ? (row[nameIndex] || '').toString().trim() : '';
    const marks = marksIndex >= 0 ? (row[marksIndex] || 'N/A').toString().trim() : 'N/A';
    const rank = rankIndex >= 0 ? (row[rankIndex] || 'First').toString().trim() : 'First';
    
    if (!className || !studentName) return;
    
    if (!classesMap[className]) {
      classesMap[className] = [];
    }
    
    classesMap[className].push({
      name: studentName,
      mark: marks,
      rank: rank
    });
  });
  
  // Convert to classesData format
  classesData = Object.keys(classesMap).map(className => ({
    class: className,
    toppers: classesMap[className].sort((a, b) => {
      const rankOrder = { 'First': 1, 'Second': 2, 'Third': 3 };
      return (rankOrder[a.rank] || 4) - (rankOrder[b.rank] || 4);
    })
  })).sort((a, b) => {
    // Sort by class number
    const aNum = parseInt(a.class);
    const bNum = parseInt(b.class);
    return (isNaN(aNum) || isNaN(bNum)) ? a.class.localeCompare(b.class) : aNum - bNum;
  });
  
  // Save to local storage as backup
  localStorage.setItem('classesData', JSON.stringify(classesData));
  
  initializeUploadedPhotos();
  updateStats();
  loadClassCards();
  createClassFilterButtons();
}

// Show sheet instructions
function showSheetInstructions() {
  const instructions = `
    <h4>üìù How to Setup Google Sheets:</h4>
    <div style="text-align: left; margin: 15px 0; font-size: 13px; line-height: 1.6;">
      <p><strong>Step 1:</strong> Create a Google Sheet with these columns:</p>
      <ul>
        <li><strong>A1:</strong> Class (e.g., 1, 2, 3)</li>
        <li><strong>B1:</strong> Name (e.g., Suhail P)</li>
        <li><strong>C1:</strong> Marks (e.g., 498/500)</li>
        <li><strong>D1:</strong> Rank (e.g., First, Second)</li>
      </ul>
      
      <p><strong>Step 2:</strong> Share your sheet:</p>
      <ul>
        <li>Click <strong>Share</strong> button</li>
        <li>Set to <strong>"Anyone with the link can view"</strong></li>
        <li>Copy the <strong>Share link</strong></li>
      </ul>
      
      <p><strong>Step 3:</strong> Get Sheet ID from URL:</p>
      <ul>
        <li>URL format: <code>https://docs.google.com/spreadsheets/d/<strong>YOUR_SHEET_ID</strong>/edit</code></li>
        <li>Copy the part between <strong>/d/</strong> and <strong>/edit</strong></li>
      </ul>
      
      <p><strong>Step 4:</strong> Enter Sheet ID above and click <strong>"Load from Google Sheets"</strong></p>
      
      <hr style="margin: 15px 0;">
      
      <p><strong>üìå Tips:</strong></p>
      <ul>
        <li>Use <strong>"Save to Google Sheets"</strong> to update data</li>
        <li>Use <strong>"Load from Google Sheets"</strong> to get latest data</li>
        <li>Student photos are stored locally on each computer</li>
      </ul>
    </div>
    
    <button onclick="createSampleSheet()" style="margin-top: 10px; padding: 10px 20px; background: var(--gradient-primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">
      <i class="fas fa-magic"></i> Create Sample Sheet
    </button>
  `;
  
  showStatus(instructions, 'success');
}

// Create sample sheet function
function createSampleSheet() {
  classesData = [
    { 
      class: "1", 
      toppers: [
        { name: "Suhail P", mark: "498 / 500", rank: "First" },
        { name: "Minhaj P", mark: "495 / 500", rank: "Second" }
      ]
    },
    { 
      class: "2", 
      toppers: [
        { name: "Muhammed Shahid", mark: "493 / 500", rank: "First" },
        { name: "Ashmil T", mark: "490 / 500", rank: "Second" }
      ]
    },
    { 
      class: "3", 
      toppers: [
        { name: "Muhammed Hadi K", mark: "487 / 500", rank: "First" },
        { name: "Danish T", mark: "485 / 500", rank: "Second" }
      ]
    }
  ];
  
  saveToLocalStorage();
  initializeUploadedPhotos();
  updateStats();
  loadClassCards();
  createClassFilterButtons();
  
  showNotification('Sample data created. Click "Save to Google Sheets" to upload.', 'success');
}

// Show status message
function showStatus(message, type) {
  const status = document.getElementById('sheetStatus');
  status.innerHTML = message;
  status.className = `sheet-status ${type}`;
  status.style.display = 'block';
  
  // Auto-hide after 10 seconds for success messages
  if (type === 'success') {
    setTimeout(() => {
      status.style.display = 'none';
    }, 10000);
  }
}

// Excel Upload Functions
function handleFileSelect(event) {
  if (!isAdminLoggedIn) {
    showNotification('Please login as admin first', 'warning');
    openLoginModal();
    return;
  }
  
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.name.match(/\.(xlsx|xls|csv)$/)) {
    showNotification('Please upload Excel or CSV file only', 'error');
    return;
  }
  
  readExcelFile(file);
}

function readExcelFile(file) {
  showLoading('Processing Excel file...');
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      processSheetData(jsonData);
      showNotification('Student data uploaded successfully!', 'success');
      
    } catch (error) {
      console.error('Error reading Excel file:', error);
      showNotification('Error reading Excel file. Please check the format.', 'error');
    } finally {
      hideLoading();
      // Clear file input
      document.getElementById('excelFile').value = '';
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showNotification('Error reading file', 'error');
    document.getElementById('excelFile').value = '';
  };
  
  reader.readAsArrayBuffer(file);
}

function uploadExcel() {
  if (!isAdminLoggedIn) {
    showNotification('Please login as admin first', 'warning');
    openLoginModal();
    return;
  }
  
  const fileInput = document.getElementById('excelFile');
  if (!fileInput.files[0]) {
    showNotification('Please select an Excel file first', 'warning');
    return;
  }
  
  handleFileSelect({ target: { files: fileInput.files } });
}

function downloadSampleTemplate() {
  const sampleData = [
    ['Class', 'Name', 'Marks', 'Rank'],
    ['1', 'Suhail P', '498/500', 'First'],
    ['1', 'Minhaj P', '495/500', 'Second'],
    ['2', 'Muhammed Shahid', '493/500', 'First'],
    ['2', 'Ashmil T', '490/500', 'Second'],
    ['3', 'Muhammed Hadi K', '487/500', 'First'],
    ['3', 'Danish T', '485/500', 'Second']
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(sampleData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Students');
  
  XLSX.writeFile(wb, 'Noorussalam_Student_Template.xlsx');
  showNotification('Sample template downloaded', 'success');
}

// Data Management Functions
function loadFromLocalStorage() {
  const savedData = localStorage.getItem('classesData');
  if (savedData) {
    classesData = JSON.parse(savedData);
    initializeUploadedPhotos();
    updateStats();
    loadClassCards();
    createClassFilterButtons();
  } else {
    // Load sample data if nothing saved
    createSampleSheet();
  }
}

function saveToLocalStorage() {
  localStorage.setItem('classesData', JSON.stringify(classesData));
}

function initializeUploadedPhotos() {
  uploadedPhotos = {};
  classesData.forEach((cls, classIndex) => {
    uploadedPhotos[classIndex] = [];
    cls.toppers.forEach((topper, topperIndex) => {
      const saved = localStorage.getItem(`topperPhoto_${classIndex}_${topperIndex}`);
      uploadedPhotos[classIndex][topperIndex] = saved || null;
    });
  });
}

function updateStats() {
  const classCount = classesData.length;
  const studentCount = classesData.reduce((total, cls) => total + cls.toppers.length, 0);
  
  document.getElementById('classCount').textContent = classCount;
  document.getElementById('studentCount').textContent = studentCount;
}

function updateCertCount() {
  document.getElementById('certCount').textContent = certCount;
  document.getElementById('certCountFooter').textContent = certCount;
}

// Helper Functions
function showLoading(text = 'Loading...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showNotification(message, type = 'info') {
  const icon = {
    success: 'check-circle',
    error: 'exclamation-circle',
    info: 'info-circle',
    warning: 'exclamation-triangle'
  }[type];
  
  const color = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  }[type];
  
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 25px;
    right: 25px;
    background: ${color};
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-weight: 500;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 350px;
    font-size: 14px;
  `;
  
  notification.innerHTML = `
    <i class="fas fa-${icon}" style="font-size: 18px;"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 10);
  
  setTimeout(() => {
    notification.style.transform = 'translateX(150%)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Load class cards
const grid = document.getElementById('grid');
function loadClassCards() {
  grid.innerHTML = '';
  
  if (classesData.length === 0) {
    grid.innerHTML = `
      <div style="text-align: center; padding: 40px; grid-column: 1/-1;">
        <i class="fas fa-database" style="font-size: 48px; color: #64748b; margin-bottom: 20px;"></i>
        <h3 style="color: #64748b; margin-bottom: 10px;">No Student Data Available</h3>
        <p style="color: #94a3b8;">Login as admin to upload Excel or configure Google Sheets</p>
      </div>
    `;
    return;
  }
  
  classesData.forEach((cls, classIndex) => {
    const card = document.createElement('div');
    card.className = 'class-card';
    
    let toppersHTML = '';
    cls.toppers.forEach((topper, topperIndex) => {
      const isFirst = topper.rank === 'First';
      
      toppersHTML += `
        <div class="topper-card ${isFirst ? 'first' : 'second'}">
          <div class="rank-badge ${isFirst ? 'first' : 'second'}">
            ${isFirst ? '1st' : '2nd'}
          </div>
          <div class="photo-display">
            <button class="upload-btn" onclick="document.getElementById('file-${classIndex}-${topperIndex}').click()">
              <i class="fas fa-cloud-upload-alt"></i> Upload Photo
            </button>
            <input type="file" id="file-${classIndex}-${topperIndex}" accept="image/*" style="display:none" 
                   onchange="handlePhotoUpload(this, ${classIndex}, ${topperIndex})">
          </div>
          <div class="student-name">${escapeHtml(topper.name)}</div>
          <div class="rank-label ${isFirst ? 'first' : 'second'}">${topper.rank} Place in Class</div>
          <div class="student-meta">Marks: ${escapeHtml(topper.mark)}</div>
          <div class="action-buttons">
            <button class="preview-btn" onclick="previewCertificate('${topper.name}','${cls.class}','${topper.mark}', '${topper.rank}', uploadedPhotos[${classIndex}][${topperIndex}] || placeholderDataURL())">
              <i class="fas fa-certificate"></i> Preview Certificate
            </button>
          </div>
        </div>
      `;
    });
    
    card.innerHTML = `
      <div class="class-header">
        <h3><span class="class-icon">üéì</span> Class ${escapeHtml(cls.class)}</h3>
      </div>
      ${toppersHTML}
    `;
    
    grid.appendChild(card);
  });
}

function escapeHtml(s){ 
  return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

function placeholderDataURL(){ 
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
    <defs>
      <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#f0f9ff"/>
        <stop offset="100%" stop-color="#e0f2fe"/>
      </linearGradient>
    </defs>
    <rect width="500" height="500" fill="url(#bg)" rx="250"/>
    <circle cx="250" cy="200" r="100" fill="#f8fafc" stroke="#283593" stroke-width="2"/>
    <g fill="#1a237e" font-family="Arial" text-anchor="middle">
      <text x="250" y="190" font-size="28" font-weight="bold">Student</text>
      <text x="250" y="230" font-size="22" font-weight="bold">Photo</text>
    </g>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

// Handle photo upload
async function handlePhotoUpload(input, classIndex, topperIndex) {
  const file = input.files[0]; 
  if(!file) return;
  
  if(!validatePhoto(file)) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      uploadedPhotos[classIndex][topperIndex] = e.target.result;
      localStorage.setItem(`topperPhoto_${classIndex}_${topperIndex}`, e.target.result);
      
      showNotification('Student photo uploaded successfully!', 'success');
      
    } catch(error) {
      console.error('Error uploading image:', error);
      showNotification('Error uploading photo.', 'error');
    }
  };
  
  reader.readAsDataURL(file);
}

function validatePhoto(file) {
  const maxSize = 10 * 1024 * 1024;
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  
  if (!allowedTypes.includes(file.type)) {
    showNotification('Please upload JPG, PNG, GIF, or WebP images only.', 'error');
    return false;
  }
  
  if (file.size > maxSize) {
    showNotification('Image size should be less than 10MB.', 'error');
    return false;
  }
  
  return true;
}

// Create class filter buttons
function createClassFilterButtons() {
  const container = document.getElementById('classFilterButtons');
  container.innerHTML = '';
  
  const allButton = document.createElement('button');
  allButton.className = 'class-filter-btn active';
  allButton.innerHTML = '<i class="fas fa-layer-group"></i> All Classes';
  allButton.onclick = () => filterByClass('all');
  container.appendChild(allButton);
  
  classesData.forEach((cls, index) => {
    const button = document.createElement('button');
    button.className = 'class-filter-btn';
    button.innerHTML = `<i class="fas fa-graduation-cap"></i> Class ${cls.class}`;
    button.onclick = () => filterByClass(cls.class);
    container.appendChild(button);
  });
}

// Filter functions
function filterByClass(classNumber) {
  activeSearch = classNumber === 'all' ? '' : classNumber;
  
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const buttons = Array.from(document.querySelectorAll('.class-filter-btn'));
  if (classNumber === 'all') {
    buttons[0].classList.add('active');
  } else {
    const buttonIndex = classesData.findIndex(cls => cls.class === classNumber) + 1;
    if (buttonIndex > 0 && buttonIndex < buttons.length) {
      buttons[buttonIndex].classList.add('active');
    }
  }
  
  document.getElementById('classSearch').value = classNumber === 'all' ? '' : classNumber;
  applySearchFilter();
}

function searchClasses() {
  const searchTerm = document.getElementById('classSearch').value.trim().toLowerCase();
  
  if (!searchTerm) {
    clearSearch();
    return;
  }
  
  activeSearch = searchTerm;
  applySearchFilter();
  
  document.querySelectorAll('.class-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (/^\d+$/.test(searchTerm)) {
    const buttons = Array.from(document.querySelectorAll('.class-filter-btn'));
    const classNum = parseInt(searchTerm);
    const buttonIndex = classesData.findIndex(cls => parseInt(cls.class) === classNum) + 1;
    if (buttonIndex > 0) {
      buttons[buttonIndex].classList.add('active');
    }
  }
}

function applySearchFilter() {
  const searchTerm = activeSearch.toLowerCase();
  const classCards = document.querySelectorAll('.class-card');
  let visibleCount = 0;
  
  classCards.forEach(card => {
    const classNumber = card.querySelector('.class-header h3').textContent.replace('Class ', '').replace('üéì', '').trim();
    const studentNames = Array.from(card.querySelectorAll('.student-name')).map(el => el.textContent.toLowerCase());
    
    let shouldShow = false;
    
    if (!searchTerm) {
      shouldShow = true;
    } else if (/^\d+$/.test(searchTerm)) {
      shouldShow = classNumber === searchTerm;
    } else {
      shouldShow = studentNames.some(name => name.includes(searchTerm));
    }
    
    if (shouldShow) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  const resultsInfo = document.getElementById('searchResultsInfo');
  if (searchTerm) {
    if (visibleCount === 0) {
      resultsInfo.innerHTML = `<i class="fas fa-info-circle"></i> No results found for "${searchTerm}"`;
      resultsInfo.style.display = 'block';
    } else {
      resultsInfo.innerHTML = `<i class="fas fa-check-circle"></i> Showing ${visibleCount} result(s) for "${searchTerm}"`;
      resultsInfo.style.display = 'block';
    }
  } else {
    resultsInfo.style.display = 'none';
  }
}

function clearSearch() {
  document.getElementById('classSearch').value = '';
  activeSearch = '';
  document.getElementById('searchResultsInfo').style.display = 'none';
  document.querySelectorAll('.class-card').forEach(card => {
    card.style.display = 'block';
  });
  document.querySelectorAll('.class-filter-btn')[0].classList.add('active');
}

// Certificate functions
async function loadImage(src) { 
  return new Promise((resolve, reject) => { 
    const img = new Image(); 
    img.crossOrigin = "anonymous"; 
    img.onload = () => resolve(img); 
    img.onerror = () => reject(new Error(`Failed to load image: ${src}`)); 
    img.src = src; 
  }); 
}

async function renderCertificateCanvas(name, cls, mark, rank, photo) {
  const w = 1200, h = 1600;
  const canvas = document.createElement("canvas"); 
  canvas.width = w; 
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  
  try {
    const bg = await loadImage(CERT_BG); 
    ctx.drawImage(bg, 0, 0, w, h);
    
    const cx = w/2, cy = 800, r = 200;
    
    if(photo && !photo.includes('Student</text>')) {
      try {
        const img = await loadImage(photo);
        ctx.save(); 
        ctx.beginPath(); 
        ctx.arc(cx, cy, r, 0, Math.PI * 2); 
        ctx.clip();
        
        const scale = Math.max(r * 2 / img.width, r * 2 / img.height);
        const x = cx - (img.width * scale) / 2;
        const y = cy - (img.height * scale) / 2;
        
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        ctx.restore();
        
      } catch(e) {
        console.error("Error loading student photo:", e);
        drawPlaceholderPhoto(ctx, cx, cy, r, rank);
      }
    } else {
      drawPlaceholderPhoto(ctx, cx, cy, r, rank);
    }
    
    ctx.fillStyle = '#0d1b36';
    ctx.font = 'bold 56px "Anek Tamil"';
    ctx.textAlign = 'center';
    ctx.fillText(name, cx, 1080);
    
    ctx.fillStyle = '#1a237e';
    ctx.font = 'bold 36px "Anek Tamil"';
    ctx.fillText(`Class: ${cls} | Marks: ${mark}`, cx, 1150);
    
    const rankColor = rank === 'First' ? '#d4af37' : '#64748b';
    ctx.fillStyle = rankColor;
    ctx.font = 'bold 38px "Anek Tamil"';
    const rankText = rank === 'First' ? 'Class Topper' : 'Second Place in Class';
    ctx.fillText(rankText, cx, 1210);
    
    return canvas;
  } catch(error) {
    console.error("Error rendering certificate:", error);
    throw new Error("Failed to load certificate background");
  }
}

function drawPlaceholderPhoto(ctx, cx, cy, r, rank) {
  const solidColor = rank === 'First' ? '#fffbeb' : '#f8fafc';
  
  ctx.fillStyle = solidColor;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = rank === 'First' ? '#d4af37' : '#64748b';
  ctx.font = 'bold 48px "Font Awesome 6 Free"';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('üë®‚Äçüéì', cx, cy);
}

async function previewCertificate(name, cls, mark, rank, photo) {
  try {
    showLoading('Generating certificate...');
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    hideLoading();
    
    const previewCanvas = document.getElementById('previewCanvas');
    const ctx = previewCanvas.getContext('2d');
    
    previewCanvas.width = 800;
    previewCanvas.height = 1067;
    
    ctx.drawImage(canvas, 0, 0, 1200, 1600, 0, 0, 800, 1067);
    
    document.getElementById('certificatePreview').style.display = 'block';
    
    setTimeout(() => {
      const existingButtons = document.querySelector('.preview-buttons');
      if (existingButtons) existingButtons.remove();
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'preview-buttons';
      
      buttonContainer.innerHTML = `
        <button onclick="downloadCertificate('${name.replace(/'/g, "\\'")}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'png')">
          <i class="fas fa-download"></i> Download PNG
        </button>
        <button onclick="downloadCertificate('${name.replace(/'/g, "\\'")}','${cls}','${mark}','${rank}','${photo.replace(/'/g, "\\'")}', 'pdf')">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      `;
      
      document.getElementById('certificatePreview').appendChild(buttonContainer);
    }, 100);
    
  } catch(error) {
    hideLoading();
    showNotification("Error generating certificate.", 'error');
  }
}

function closeCertificatePreview() {
  document.getElementById('certificatePreview').style.display = 'none';
  const buttons = document.querySelector('.preview-buttons');
  if (buttons) buttons.remove();
}

async function downloadCertificate(name, cls, mark, rank, photo, type) {
  try {
    showLoading('Generating certificate...');
    
    const canvas = await renderCertificateCanvas(name, cls, mark, rank, photo);
    const img = canvas.toDataURL("image/png");
    
    confetti({
      particleCount: 150,
      spread: 100,
      origin: { y: 0.6 }
    });
    
    certCount++;
    localStorage.setItem('certCount', certCount);
    updateCertCount();
    
    const fileName = `Noorussalam_Class${cls}_${rank.replace(' ', '_')}_${name.replace(/\s+/g, '_')}`;
    
    if(type === "png") {
      const a = document.createElement("a"); 
      a.href = img; 
      a.download = `${fileName}.png`; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification(`Certificate for ${name} downloaded!`, 'success');
    } else if(type === "pdf") {
      const { jsPDF } = window.jspdf; 
      const pdf = new jsPDF({orientation: "portrait", unit: "px", format: [1200, 1600]});
      pdf.addImage(img, "PNG", 0, 0, 1200, 1600); 
      pdf.save(`${fileName}.pdf`);
      showNotification(`PDF certificate for ${name} downloaded!`, 'success');
    }
    
    hideLoading();
    
  } catch(error) {
    hideLoading();
    showNotification("Error downloading certificate.", 'error');
  }
}

// Close login modal when clicking outside
document.getElementById('loginModal').addEventListener('click', function(e) {
  if(e.target === this) closeLoginModal();
});

// Enter key to submit login form
document.getElementById('adminPassword').addEventListener('keypress', function(e) {
  if(e.key === 'Enter') {
    handleLogin(e);
  }
});
</script>
</body>
</html>
