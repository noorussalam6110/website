<!DOCTYPE html>
<html lang="ml">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noorussalam Madrasa - Result System</title>
    <style>
        /* Reset and Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header h2 { font-size: 20px; opacity: 0.9; }
        
        /* Main Content */
        .main-content { padding: 30px; }
        
        /* Info Box */
        .info-box {
            background: #f0f9ff;
            border-left: 5px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        /* Timer */
        .timer {
            background: #fff3e0;
            border: 2px dashed #ff9800;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        #countdown {
            font-size: 32px;
            font-weight: bold;
            color: #ff5722;
            margin: 10px 0;
        }
        
        /* Form */
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            color: #333;
        }
        select, input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn:active { transform: translateY(0); }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        /* Error/Success Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error { background: #ffebee; color: #c62828; border-left: 5px solid #f44336; }
        .success { background: #e8f5e9; color: #2e7d32; border-left: 5px solid #4CAF50; }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 14px;
        }
        
        /* Hidden class */
        .hidden { display: none !important; }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container { margin: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="homePage">
            <div class="header">
                <h1 id="institutionName">Noorussalam Madrasa</h1>
                <h2 id="examName">Annual Examination Result</h2>
            </div>
            
            <div class="main-content">
                <div class="info-box">
                    <h3 style="color: #2196F3; margin-bottom: 10px;">‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ</h3>
                    <p><strong>Academic Year:</strong> <span id="academicYear">2024-2025</span></p>
                    <p><strong>Exam Date:</strong> <span id="examDate">March 2024</span></p>
                    <p><strong>Result Publish:</strong> <span id="publishInfo">Loading...</span></p>
                </div>
                
                <div class="timer">
                    <h3 style="color: #ff9800;">Result Publishing Countdown</h3>
                    <div id="countdown">Loading...</div>
                    <p id="timerStatus" style="color: #666;">Result will be published soon</p>
                </div>
                
                <div id="message" class="message"></div>
                
                <div class="form-group">
                    <label for="class">Class (‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç):</label>
                    <select id="class" required>
                        <option value="">Select Class</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="roll">Roll Number (‡¥±‡µã‡µæ ‡¥®‡¥Æ‡µç‡¥™‡µº):</label>
                    <input type="text" id="roll" 
                           placeholder="Enter your roll number" 
                           required
                           autocomplete="off">
                </div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading result...</p>
                </div>
                
                <button id="getResultBtn" class="btn">
                    Get Result (‡¥´‡¥≤‡¥Ç ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï)
                </button>
            </div>
            
            <div class="footer">
                <p>&copy; 2024 Noorussalam Madrasa. All rights reserved.</p>
                <p>Developed with ‚ù§Ô∏è for Noorussalam Madrasa</p>
            </div>
        </div>
        
        <!-- Result Page -->
        <div id="resultPage" class="hidden">
            <div class="header" style="background: linear-gradient(to right, #2196F3, #1976D2);">
                <h1 id="resultInstitutionName">Noorussalam Madrasa</h1>
                <h2 id="resultExamName">Result Slip</h2>
            </div>
            
            <div class="main-content">
                <div class="info-box" style="background: #fff3e0; border-left-color: #ff9800;">
                    <h3 style="color: #ff9800; margin-bottom: 15px;">Student Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Class:</strong> <span id="studentClass">-</span>
                        </div>
                        <div>
                            <strong>Roll No:</strong> <span id="studentRoll">-</span>
                        </div>
                        <div>
                            <strong>Name:</strong> <span id="studentName">-</span>
                        </div>
                        <div>
                            <strong>Date:</strong> <span id="resultDate">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="performanceSummary" style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">Performance Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="color: #666;">Subjects</div>
                            <div id="totalSubjects" style="font-size: 28px; font-weight: bold; color: #2196F3;">0</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="color: #666;">Total Marks</div>
                            <div id="totalMarks" style="font-size: 28px; font-weight: bold; color: #2196F3;">0</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="color: #666;">Percentage</div>
                            <div id="percentage" style="font-size: 28px; font-weight: bold; color: #2196F3;">0%</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="color: #666;">Grade</div>
                            <div id="overallGrade" style="font-size: 28px; font-weight: bold; color: #4CAF50;">-</div>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin: 25px 0;">
                        <thead>
                            <tr style="background: #4CAF50; color: white;">
                                <th style="padding: 12px; text-align: left;">Subject</th>
                                <th style="padding: 12px; text-align: center;">Max</th>
                                <th style="padding: 12px; text-align: center;">Obtained</th>
                                <th style="padding: 12px; text-align: center;">Grade</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div style="background: #fce4ec; padding: 20px; border-radius: 10px; margin: 25px 0;">
                    <h3 style="color: #e91e63; margin-bottom: 10px;">Remarks</h3>
                    <p id="remarksText" style="color: #333;">-</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button onclick="goBack()" class="btn" style="background: #666;">
                        ‚Üê Back to Home
                    </button>
                    <button onclick="printResult()" class="btn" style="background: #ff9800;">
                        üñ®Ô∏è Print Result
                    </button>
                </div>
            </div>
            
            <div class="footer">
                <p>This is a computer-generated result. Verify with official records.</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            config: null,
            sheetData: null,
            studentData: null
        };
        
        // Initialize app
        async function initApp() {
            try {
                // Show loading initially
                showLoading(true);
                
                // Load configuration
                await loadConfig();
                
                // Load sheet data
                await loadSheetData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Start countdown timer
                startCountdown();
                
                // Hide loading
                showLoading(false);
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showMessage('Failed to initialize application. Please refresh the page.', 'error');
                showLoading(false);
            }
        }
        
        // Load configuration
        async function loadConfig() {
            try {
                const config = await google.script.run
                    .withFailureHandler(handleError)
                    .getAppConfig();
                
                appState.config = config;
                
                // Update UI
                document.getElementById('institutionName').textContent = config.institution || 'Noorussalam Madrasa';
                document.getElementById('examName').textContent = config.exam || 'Annual Examination';
                document.getElementById('resultInstitutionName').textContent = config.institution || 'Noorussalam Madrasa';
                document.getElementById('resultExamName').textContent = config.exam || 'Annual Examination';
                
                // Populate class dropdown
                const classSelect = document.getElementById('class');
                classSelect.innerHTML = '<option value="">Select Class</option>';
                
                if (config.classes && config.classes.length > 0) {
                    config.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                throw new Error('Failed to load configuration: ' + error);
            }
        }
        
        // Load sheet data
        async function loadSheetData() {
            try {
                const data = await google.script.run
                    .withFailureHandler(handleError)
                    .getSheetData();
                
                appState.sheetData = data;
                
                // Update UI
                document.getElementById('academicYear').textContent = data.academicYear || '2024-2025';
                document.getElementById('examDate').textContent = data.examDate || 'Not specified';
                
                const publishInfo = data.publishDate ? 
                    `${data.publishDate} at ${data.publishTime}` : 
                    'Not scheduled';
                document.getElementById('publishInfo').textContent = publishInfo;
                
            } catch (error) {
                throw new Error('Failed to load sheet data: ' + error);
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Get result button
            document.getElementById('getResultBtn').addEventListener('click', getResult);
            
            // Enter key in roll number field
            document.getElementById('roll').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getResult();
                }
            });
            
            // Auto-uppercase roll number
            document.getElementById('roll').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        }
        
        // Get student result
        async function getResult() {
            const className = document.getElementById('class').value;
            const rollNo = document.getElementById('roll').value.trim();
            
            // Validation
            if (!className) {
                showMessage('Please select a class.', 'error');
                return;
            }
            
            if (!rollNo) {
                showMessage('Please enter roll number.', 'error');
                return;
            }
            
            // Show loading
            showLoading(true);
            
            try {
                const result = await google.script.run
                    .withFailureHandler(handleError)
                    .getStudentResult(className, rollNo);
                
                showLoading(false);
                
                if (result.success) {
                    appState.studentData = result;
                    showResultPage();
                } else {
                    showMessage(result.message || 'Result not found.', 'error');
                }
                
            } catch (error) {
                showLoading(false);
                showMessage('Failed to fetch result. Please try again.', 'error');
                console.error('Result fetch error:', error);
            }
        }
        
        // Show result page
        function showResultPage() {
            if (!appState.studentData) return;
            
            const student = appState.studentData.data;
            const subjects = appState.studentData.subjects;
            
            // Update student info
            document.getElementById('studentClass').textContent = student.className;
            document.getElementById('studentRoll').textContent = student.rollNo;
            document.getElementById('studentName').textContent = student.name || 'Not available';
            document.getElementById('resultDate').textContent = new Date().toLocaleDateString('en-IN');
            
            // Calculate summary
            let totalMarks = 0;
            let totalMaxMarks = 0;
            let subjectCount = 0;
            
            // Clear table
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';
            
            // Populate table and calculate totals
            subjects.forEach(subject => {
                if (!subject.name || subject.name.trim() === '') return;
                
                const marks = parseFloat(subject.marks) || 0;
                const maxMarks = parseFloat(subject.maxMarks) || 100;
                const grade = calculateGrade(marks, maxMarks);
                
                totalMarks += marks;
                totalMaxMarks += maxMarks;
                subjectCount++;
                
                // Create table row
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${subject.name}</div>
                        <div style="font-size: 12px; color: #666;">${subject.code}</div>
                    </td>
                    <td style="padding: 12px; text-align: center;">${maxMarks}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold;">
                        ${marks}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="display: inline-block; padding: 4px 12px; border-radius: 20px; 
                              background: ${grade.color}; color: white; font-weight: bold;">
                            ${grade.letter}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update summary
            const percentage = totalMaxMarks > 0 ? ((totalMarks / totalMaxMarks) * 100).toFixed(2) : 0;
            const overallGrade = calculateGrade(totalMarks, totalMaxMarks);
            
            document.getElementById('totalSubjects').textContent = subjectCount;
            document.getElementById('totalMarks').textContent = `${totalMarks}/${totalMaxMarks}`;
            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('overallGrade').textContent = overallGrade.letter;
            document.getElementById('overallGrade').style.color = overallGrade.color;
            
            // Update remarks
            updateRemarks(percentage, totalMarks, totalMaxMarks);
            
            // Show result page
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('resultPage').classList.remove('hidden');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        // Calculate grade
        function calculateGrade(marks, maxMarks) {
            const percentage = (marks / maxMarks) * 100;
            
            if (percentage >= 90) return { letter: 'A+', color: '#4CAF50' };
            if (percentage >= 80) return { letter: 'A', color: '#4CAF50' };
            if (percentage >= 70) return { letter: 'B+', color: '#2196F3' };
            if (percentage >= 60) return { letter: 'B', color: '#2196F3' };
            if (percentage >= 50) return { letter: 'C+', color: '#FF9800' };
            if (percentage >= 40) return { letter: 'C', color: '#FF9800' };
            if (percentage >= 35) return { letter: 'D', color: '#FF5722' };
            return { letter: 'F', color: '#F44336' };
        }
        
        // Update remarks
        function updateRemarks(percentage, obtained, total) {
            let remarks = '';
            
            if (percentage >= 90) {
                remarks = `Excellent performance! You scored ${percentage}% with ${obtained}/${total} marks. Outstanding work!`;
            } else if (percentage >= 75) {
                remarks = `Very good performance! You scored ${percentage}% with ${obtained}/${total} marks. Keep it up!`;
            } else if (percentage >= 60) {
                remarks = `Good performance. You scored ${percentage}% with ${obtained}/${total} marks. There's room for improvement.`;
            } else if (percentage >= 40) {
                remarks = `Satisfactory performance. You scored ${percentage}% with ${obtained}/${total} marks. Need to work harder.`;
            } else {
                remarks = `Needs improvement. You scored ${percentage}% with ${obtained}/${total} marks. Please focus more on studies.`;
            }
            
            document.getElementById('remarksText').textContent = remarks;
        }
        
        // Go back to home
        function goBack() {
            document.getElementById('resultPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('message').classList.add('hidden');
            window.scrollTo(0, 0);
        }
        
        // Print result
        function printResult() {
            window.print();
        }
        
        // Start countdown timer
        async function startCountdown() {
            try {
                const publishTime = await google.script.run
                    .withFailureHandler(() => Date.now() + 86400000) // Default: tomorrow
                    .getPublishDateTime();
                
                function updateTimer() {
                    const now = Date.now();
                    const distance = publishTime - now;
                    
                    if (distance < 0) {
                        document.getElementById('countdown').textContent = "PUBLISHED!";
                        document.getElementById('timerStatus').textContent = "Results are now available";
                        return;
                    }
                    
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    document.getElementById('countdown').textContent = 
                        `${days}d ${hours}h ${minutes}m ${seconds}s`;
                    
                    document.getElementById('timerStatus').textContent = 
                        distance > 86400000 ? "Result publishing soon" : "Result will be published today";
                    
                    setTimeout(updateTimer, 1000);
                }
                
                updateTimer();
                
            } catch (error) {
                console.error('Countdown error:', error);
                document.getElementById('countdown').textContent = "Time not available";
            }
        }
        
        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Show message
        function showMessage(message, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = message;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }
        
        // Handle errors
        function handleError(error) {
            console.error('Script error:', error);
            throw error;
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
