<!DOCTYPE html>
<html lang="ml">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noorussalam Madrasa - Result System</title>
    <style>
        /* Common Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Malayalam Sangam MN', sans-serif;
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            transition: background 0.3s;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #4CAF50;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Home Page Styles */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4CAF50;
        }
        
        .header h1 {
            color: #2E7D32;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header h2 {
            color: #388E3C;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .info-box {
            background: #E8F5E9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 5px solid #4CAF50;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2E7D32;
            font-size: 16px;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .submit-btn {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .timer-container {
            background: #FFF3E0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed #FF9800;
        }
        
        /* Result Page Styles */
        .student-info {
            background: #FFF3E0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #FF9800;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .result-table th {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 16px;
        }
        
        .result-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .summary {
            background: #E3F2FD;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Home Page Template -->
    <div id="homePage" class="container">
        <div class="header">
            <h1 id="institutionName">Loading...</h1>
            <h2 id="examName">Loading...</h2>
            <p id="institutionAddress">Loading...</p>
            <p id="institutionContact">Loading...</p>
        </div>
        
        <div class="info-box">
            <h3>‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ:</h3>
            <p><strong id="academicYearLabel">Academic Year:</strong> <span id="academicYearValue">Loading...</span></p>
            <p><strong id="examDateLabel">Exam Date:</strong> <span id="examDateValue">Loading...</span></p>
        </div>
        
        <div class="timer-container">
            <h3>Result Publishing Countdown</h3>
            <div id="countdown">Loading...</div>
            <p id="timerStatus">Result will be published soon</p>
        </div>
        
        <div class="form-container">
            <div id="errorMessage" class="hidden" style="background: #FFEBEE; color: #C62828; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <div class="form-group">
                <label for="class">Class (‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç):</label>
                <select id="class" required>
                    <option value="">Select Class (‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="roll">Roll Number (‡¥±‡µã‡µæ ‡¥®‡¥Æ‡µç‡¥™‡µº):</label>
                <input type="text" id="roll" 
                       placeholder="Enter Roll Number (‡¥±‡µã‡µæ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï)" 
                       required
                       pattern="[A-Za-z0-9]+"
                       title="Only letters and numbers are allowed">
            </div>
            
            <div id="loading" class="hidden" style="text-align: center; margin: 20px 0;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                <p>Loading result...</p>
            </div>
            
            <button id="getResultBtn" class="submit-btn">
                Get Result (‡¥´‡¥≤‡¥Ç ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï)
            </button>
        </div>
        
        <div class="footer" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px;">
            <p>&copy; <span id="currentYear"></span> Noorussalam Madrasa. All rights reserved.</p>
            <p>Developed with ‚ù§Ô∏è for Noorussalam Madrasa</p>
        </div>
    </div>
    
    <!-- Result Page Template -->
    <div id="resultPage" class="container hidden">
        <div class="header">
            <h1 id="resultInstitutionName">Loading...</h1>
            <h2 id="resultExamName">Loading...</h2>
            <p id="resultAcademicYear">Loading...</p>
        </div>
        
        <div class="student-info">
            <h2>Student Result</h2>
            <div class="info-grid">
                <div class="info-item" style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">Class (‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç)</div>
                    <div id="studentClass">-</div>
                </div>
                <div class="info-item" style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">Roll No (‡¥±‡µã‡µæ ‡¥®‡¥Æ‡µç‡¥™‡µº)</div>
                    <div id="studentRoll">-</div>
                </div>
                <div class="info-item" style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">Result Date</div>
                    <div id="resultDate">-</div>
                </div>
            </div>
        </div>
        
        <div class="summary">
            <h2>Performance Summary</h2>
            <div class="summary-grid">
                <div class="summary-item" style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div>Total Subjects</div>
                    <div id="totalSubjects" style="font-size: 24px; font-weight: bold; color: #2196F3; margin: 10px 0;">0</div>
                </div>
                <div class="summary-item" style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div>Total Marks</div>
                    <div id="totalMarks" style="font-size: 24px; font-weight: bold; color: #2196F3; margin: 10px 0;">0</div>
                </div>
                <div class="summary-item" style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div>Percentage</div>
                    <div id="percentage" style="font-size: 24px; font-weight: bold; color: #2196F3; margin: 10px 0;">0%</div>
                </div>
                <div class="summary-item" style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div>Grade</div>
                    <div id="overallGrade" style="font-size: 24px; font-weight: bold; color: #2196F3; margin: 10px 0;">-</div>
                </div>
            </div>
        </div>
        
        <table class="result-table">
            <thead>
                <tr>
                    <th>Subject Code</th>
                    <th>Subject Name</th>
                    <th>Max Marks</th>
                    <th>Obtained</th>
                    <th>Grade</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <!-- Results will be populated dynamically -->
            </tbody>
        </table>
        
        <div id="remarks" style="background: #FCE4EC; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 5px solid #E91E63;">
            <h3 style="color: #C2185B; margin-bottom: 10px;">Remarks & Comments</h3>
            <p id="remarksText">Your detailed performance analysis will appear here.</p>
        </div>
        
        <div class="buttons">
            <button class="btn" onclick="showHomePage()" style="background: #4CAF50; color: white;">
                ‚Üê Back to Home
            </button>
            <button class="btn" onclick="printResult()" style="background: #FF9800; color: white;">
                üñ®Ô∏è Print Result
            </button>
        </div>
        
        <div class="footer" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px;">
            <p>&copy; <span id="resultYear"></span> Noorussalam Madrasa. All rights reserved.</p>
            <p>This is a computer-generated result. Any discrepancy should be reported within 7 days.</p>
        </div>
    </div>

    <script>
        // Global variables
        let appData = {
            config: null,
            sheetData: null,
            subjects: [],
            currentStudent: null
        };
        
        // Initialize application
        async function initializeApp() {
            try {
                // Set current year
                document.getElementById('currentYear').textContent = new Date().getFullYear();
                document.getElementById('resultYear').textContent = new Date().getFullYear();
                
                // Load configuration and data
                await Promise.all([
                    loadConfig(),
                    loadSheetData(),
                    updateCountdown()
                ]);
                
                // Setup form
                setupForm();
                
                // Check URL parameters for direct result access
                checkUrlParams();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize application. Please refresh the page.');
            }
        }
        
        // Load configuration
        async function loadConfig() {
            try {
                const response = await google.script.run
                    .withFailureHandler((error) => {
                        console.error('Config load error:', error);
                        throw error;
                    })
                    .getAppConfig();
                    
                appData.config = response || {};
                updateUIWithConfig();
                
            } catch (error) {
                console.error('Error loading config:', error);
                // Use default values
                appData.config = {
                    institution: 'Noorussalam Madrasa',
                    exam: 'Annual Examination',
                    classes: ['1A', '1B', '1C', '2A', '2B', '2C', '3A', '3B', '3C', '4A', '4B', '4C', 
                             '5A', '5B', '5C', '6A', '6B', '6C', '7A', '7B', '7C', '8A', '8B', '8C',
                             '9A', '9B', '9C', '10A', '10B', '10C', '11A', '11B', '11C', '12A', '12B', '12C']
                };
                updateUIWithConfig();
            }
        }
        
        // Load sheet data
        async function loadSheetData() {
            try {
                const response = await google.script.run
                    .withFailureHandler((error) => {
                        console.error('Sheet data load error:', error);
                        throw error;
                    })
                    .loadDataFromSheet();
                    
                appData.sheetData = response || {};
                updateUIWithSheetData();
                
            } catch (error) {
                console.error('Error loading sheet data:', error);
                appData.sheetData = {};
            }
        }
        
        // Update UI with config data
        function updateUIWithConfig() {
            // Home page
            if (appData.config.institution) {
                document.getElementById('institutionName').textContent = appData.config.institution;
                document.getElementById('resultInstitutionName').textContent = appData.config.institution;
            }
            
            if (appData.config.exam) {
                document.getElementById('examName').textContent = appData.config.exam;
                document.getElementById('resultExamName').textContent = appData.config.exam;
            }
            
            // Populate class dropdown
            const classSelect = document.getElementById('class');
            if (appData.config.classes && appData.config.classes.length > 0) {
                classSelect.innerHTML = '<option value="">Select Class (‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï)</option>';
                appData.config.classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
        }
        
        // Update UI with sheet data
        function updateUIWithSheetData() {
            // Update academic year and exam date
            if (appData.sheetData.academicYear) {
                document.getElementById('academicYearValue').textContent = appData.sheetData.academicYear;
                document.getElementById('resultAcademicYear').textContent = appData.sheetData.academicYear;
            }
            
            if (appData.sheetData.examDate) {
                document.getElementById('examDateValue').textContent = appData.sheetData.examDate;
            }
        }
        
        // Setup form
        function setupForm() {
            const form = document.getElementById('getResultBtn');
            const rollInput = document.getElementById('roll');
            
            form.addEventListener('click', getStudentResult);
            
            // Auto-capitalize roll number
            rollInput.addEventListener('input', function(e) {
                this.value = this.value.toUpperCase();
            });
            
            // Enter key support
            rollInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getStudentResult();
                }
            });
        }
        
        // Get student result
        async function getStudentResult() {
            const className = document.getElementById('class').value;
            const rollNumber = document.getElementById('roll').value.trim().toUpperCase();
            
            if (!className) {
                showError('Please select a class.');
                return;
            }
            
            if (!rollNumber) {
                showError('Please enter roll number.');
                return;
            }
            
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            try {
                const result = await google.script.run
                    .withFailureHandler((error) => {
                        document.getElementById('loading').classList.add('hidden');
                        showError('Failed to fetch result. Please try again.');
                        console.error('Result fetch error:', error);
                    })
                    .getStudentResult(className, rollNumber);
                
                document.getElementById('loading').classList.add('hidden');
                
                if (result.success) {
                    appData.currentStudent = result.data;
                    appData.subjects = result.subjects || [];
                    showResultPage();
                } else {
                    showError(result.message || 'Student not found. Please check the roll number.');
                }
                
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError('An error occurred. Please try again.');
                console.error('Error:', error);
            }
        }
        
        // Show result page
        function showResultPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('resultPage').classList.remove('hidden');
            
            // Update student info
            document.getElementById('studentClass').textContent = appData.currentStudent.className;
            document.getElementById('studentRoll').textContent = appData.currentStudent.rollNo;
            document.getElementById('resultDate').textContent = new Date().toLocaleDateString('ml-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            // Render result table
            renderResultTable();
            
            // Update URL without reloading
            const newUrl = window.location.pathname + `?class=${encodeURIComponent(appData.currentStudent.className)}&roll=${encodeURIComponent(appData.currentStudent.rollNo)}`;
            window.history.pushState({}, '', newUrl);
        }
        
        // Show home page
        function showHomePage() {
            document.getElementById('resultPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            // Clear form
            document.getElementById('roll').value = '';
            
            // Update URL
            window.history.pushState({}, '', window.location.pathname);
        }
        
        // Render result table
        function renderResultTable() {
            const tbody = document.getElementById('resultBody');
            let totalMarks = 0;
            let totalMaxMarks = 0;
            let passedSubjects = 0;
            let subjectCount = 0;
            
            tbody.innerHTML = '';
            
            appData.subjects.forEach((subject, index) => {
                if (!subject.name || subject.name.trim() === '') return;
                
                const marks = parseFloat(subject.marks) || 0;
                const maxMarks = parseInt(subject.maxMarks) || 100;
                const gradeInfo = calculateGrade(marks, maxMarks);
                
                totalMarks += marks;
                totalMaxMarks += maxMarks;
                subjectCount++;
                
                if (gradeInfo.grade !== 'F') {
                    passedSubjects++;
                }
                
                const row = document.createElement('tr');
                row.className = gradeInfo.color;
                row.innerHTML = `
                    <td>${subject.code || `SUB${index + 1}`}</td>
                    <td>${subject.name}</td>
                    <td>${maxMarks}</td>
                    <td><strong>${marks}</strong></td>
                    <td><span style="font-weight: bold; padding: 5px 10px; border-radius: 4px; display: inline-block;">${gradeInfo.grade}</span></td>
                    <td>${subject.remarks || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update summary
            const percentage = totalMaxMarks > 0 ? ((totalMarks / totalMaxMarks) * 100).toFixed(2) : 0;
            const overallGrade = calculateGrade(totalMarks, totalMaxMarks);
            
            document.getElementById('totalSubjects').textContent = subjectCount;
            document.getElementById('totalMarks').textContent = `${totalMarks}/${totalMaxMarks}`;
            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('overallGrade').textContent = overallGrade.grade;
            document.getElementById('overallGrade').style.color = overallGrade.grade === 'F' ? '#C62828' : '#2196F3';
            
            // Update remarks
            updateRemarks(percentage, passedSubjects, subjectCount);
        }
        
        // Calculate grade
        function calculateGrade(marks, maxMarks) {
            const percentage = (marks / maxMarks) * 100;
            
            if (percentage >= 90) return { grade: 'A+', color: 'grade-excellent' };
            if (percentage >= 80) return { grade: 'A', color: 'grade-excellent' };
            if (percentage >= 70) return { grade: 'B+', color: 'grade-good' };
            if (percentage >= 60) return { grade: 'B', color: 'grade-good' };
            if (percentage >= 50) return { grade: 'C+', color: 'grade-good' };
            if (percentage >= 40) return { grade: 'C', color: 'grade-good' };
            if (percentage >= 35) return { grade: 'D', color: 'grade-poor' };
            return { grade: 'F', color: 'grade-poor' };
        }
        
        // Update remarks
        function updateRemarks(percentage, passed, total) {
            const remarks = document.getElementById('remarksText');
            let remark = '';
            
            if (percentage >= 90) {
                remark = `Excellent performance! You've scored ${percentage}% and passed all ${passed}/${total} subjects. Keep up the outstanding work!`;
            } else if (percentage >= 75) {
                remark = `Very good performance! You've scored ${percentage}% and passed ${passed}/${total} subjects. Well done!`;
            } else if (percentage >= 60) {
                remark = `Good performance. You've scored ${percentage}% and passed ${passed}/${total} subjects. Keep improving!`;
            } else if (percentage >= 40) {
                remark = `Satisfactory performance. You've scored ${percentage}% and passed ${passed}/${total} subjects. Room for improvement.`;
            } else {
                remark = `Needs improvement. You've scored ${percentage}% and passed ${passed}/${total} subjects. Please focus more on studies.`;
            }
            
            remarks.textContent = remark;
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Countdown timer
        async function updateCountdown() {
            try {
                const publishTime = await google.script.run
                    .withFailureHandler((error) => {
                        console.error('Countdown error:', error);
                        document.getElementById('countdown').textContent = "Time not available";
                        return Date.now() + 86400000; // Default to 1 day later
                    })
                    .getPublishDateTime();
                
                const now = Date.now();
                const distance = publishTime - now;
                
                if (distance < 0) {
                    document.getElementById('countdown').textContent = "RESULTS PUBLISHED!";
                    document.getElementById('timerStatus').textContent = "Results are now available";
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').textContent = 
                    `${days}d ${hours}h ${minutes}m ${seconds}s`;
                
                document.getElementById('timerStatus').textContent = 
                    distance > 86400000 ? "Result publishing soon" : "Result will be published today";
                
                setTimeout(updateCountdown, 1000);
                
            } catch (error) {
                console.error('Countdown error:', error);
                document.getElementById('countdown').textContent = "Time not available";
            }
        }
        
        // Print result
        function printResult() {
            window.print();
        }
        
        // Check URL parameters
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const className = urlParams.get('class');
            const rollNo = urlParams.get('roll');
            
            if (className && rollNo) {
                document.getElementById('class').value = className;
                document.getElementById('roll').value = rollNo;
                setTimeout(() => getStudentResult(), 1000);
            }
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .grade-excellent {
                background-color: #C8E6C9 !important;
                color: #2E7D32;
            }
            
            .grade-good {
                background-color: #FFF9C4 !important;
                color: #F57F17;
            }
            
            .grade-poor {
                background-color: #FFCDD2 !important;
                color: #C62828;
            }
            
            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
