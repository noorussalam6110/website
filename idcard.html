<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noorussalam Madrasa — ID Card Generator</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Nunito font for a soft premium look -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #0b5ed7;
      --primary-dark: #0849a2;
      --card-w: 328px;  /* ~86mm */
      --card-h: 205px;  /* ~54mm */
      --watermark-url: "/mnt/data/nsm logo.jpeg"; /* your uploaded logo path */
    }

    html,body { height:100%; margin:0; }
    body {
      font-family: "Nunito", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(140deg, var(--primary) 0%, #6fb6ff 60%, #dff1ff 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    /* Form card */
    .id-form {
      width:100%;
      max-width:500px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), #ffffff);
      border-radius:18px;
      padding:28px;
      box-shadow: 0 12px 30px rgba(3,34,63,0.18);
      text-align:center;
    }
    .id-form img { margin-bottom:8px; }
    .id-form h1 { font-size:1.06rem; color:var(--primary); margin:6px 0 6px; letter-spacing:0.6px; }
    .id-form p { color:#475569; margin-bottom:18px; }

    .form-control { height:46px; border-radius:10px; }
    .btn-generate {
      background: linear-gradient(90deg,var(--primary),#167bff);
      color:#fff;
      border:0;
      border-radius:10px;
      height:46px;
      font-weight:700;
      box-shadow: 0 8px 22px rgba(11,94,215,0.24);
    }
    .btn-generate:hover { transform: translateY(-2px); background: var(--primary-dark); }

    small.hint { display:block; margin-top:10px; color:#6b7280; font-size:13px; }

    /* responsive */
    @media (max-width:520px){
      .id-form { padding:20px; }
    }
  </style>
</head>
<body>

  <div class="id-form">
    <img src="https://i.ibb.co/7Jw5TBJg/NSM-LOGO-PNG.png" alt="Noorussalam logo" width="96">
    <h1>NOORUSSALAM MADRASA</h1>
    <p>Enter Class and Roll Number to generate the ID card (opens in a new tab)</p>

    <form id="idForm" class="mt-3">
      <div class="mb-3 text-start">
        <label class="form-label">Class</label>
        <input name="class" class="form-control" placeholder="e.g. 7A or 8" required>
      </div>

      <div class="mb-3 text-start">
        <label class="form-label">Roll Number</label>
        <input name="roll" class="form-control" placeholder="e.g. 12" required inputmode="numeric" pattern="[0-9]*">
      </div>

      <button type="submit" class="btn btn-generate w-100">Generate Digital ID Card</button>
      <small class="hint">Printed size: CR-80 (86 × 54 mm). Use the Print button in the new tab for best results.</small>
    </form>
  </div>

<script>
/* ========= Replace SCRIPT_URL with your deployed Apps Script URL if different ========= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwNp2D-Kg6yGaiGaP5npYiyGXRoGI3eTrf_DdHCXo-4Lo2mw2kLQEBucmNl5VkQs8R/exec";

/* Escape to avoid injection in template */
function escapeHtml(str){
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

document.getElementById('idForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const cls = (fd.get('class') || '').toString().trim();
  const roll = (fd.get('roll') || '').toString().trim();
  if (!cls || !roll) { alert('Please enter class and roll number.'); return; }

  // open blank tab first (avoids popup blocking)
  const win = window.open('', '_blank');
  win.document.write(`<div style="font-family:Nunito,Arial,sans-serif;text-align:center;padding:40px;color:${'#0b5ed7'};"><h3>Loading ID Card...</h3></div>`);

  const url = `${SCRIPT_URL}?class=${encodeURIComponent(cls)}&roll=${encodeURIComponent(roll)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (!data || data.result !== 'success') {
      const msg = data && data.message ? data.message : 'Student not found or server error.';
      win.document.body.innerHTML = `<div style="font-family:Nunito,Arial,sans-serif;padding:40px;text-align:center;color:#b91c1c;"><h3>${escapeHtml(msg)}</h3></div>`;
      return;
    }

    const s = data.student || {};
    s.FullName = s.FullName || 'STUDENT NAME';
    s.UID = s.UID || '';
    s.AdmissionNumber = s.AdmissionNumber || '';
    s.FatherName = s.FatherName || '';
    s.ClassLevel = s.ClassLevel || cls;
    s.RollNumber = s.RollNumber || roll;
    s.Phone = s.Phone || '';
    s.Address = s.Address || '';
    s.PhotoURL = s.PhotoURL || 'https://via.placeholder.com/200';

    // Build new-tab HTML: no QR code, full-card watermark using uploaded path (/mnt/data/nsm logo.jpeg)
    const cardHtml = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${escapeHtml(s.FullName)} — ID Card</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #0b5ed7; --card-w: 328px; --card-h:205px; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #eef4ff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    /* Print only the card - hide controls */
    @media print {
      body * { visibility: hidden; }
      #idcard, #idcard * { visibility: visible; }
      #idcard { position: absolute; left:50%; top:10px; transform: translateX(-50%); }
    }

    /* Real CR-80 card */
    .id-card {
      width: var(--card-w);
      height: var(--card-h);
      border-radius:14px;
      background: linear-gradient(180deg, #ffffff 0%, #f7fbff 100%);
      border: 3px solid var(--primary);
      box-shadow:
        0 12px 30px rgba(2,6,23,0.18),
        inset 0 0 20px rgba(11,94,215,0.02);
      overflow: hidden;
      position: relative;
      text-align: center;
    }

    /* Full-card circular watermark (soft) - using uploaded local path */
    .watermark {
      position: absolute;
      width: 170px;
      height: 170px;
      top: 46%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-image: url('/mnt/data/nsm logo.jpeg');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.10;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      filter: blur(0.2px);
    }

    .id-header {
      background: linear-gradient(90deg, var(--primary), #6fb6ff);
      padding: 8px 6px;
      color: #fff;
      z-index: 2;
      position: relative;
    }
    .id-header h4 { margin:0; font-size:13px; font-weight:700; letter-spacing:0.4px; }
    .id-header small { display:block; font-size:9px; opacity:0.95; margin-top:2px; }

    .photo {
      width:78px;
      height:78px;
      border-radius:50%;
      object-fit:cover;
      border:3px solid #fff;
      margin-top:8px;
      box-shadow: 0 4px 12px rgba(2,6,23,0.18);
      z-index:2;
      position: relative;
    }

    .fullname { color:var(--primary); font-weight:700; margin-top:6px; font-size:14px; z-index:2; position: relative; }
    .details { text-align:left; padding:0 14px; margin-top:6px; font-size:10px; line-height:12px; z-index:2; position: relative; }
    .details p { margin:3px 0; color:#1f2937; }

    .controls { display:flex; gap:12px; justify-content:center; margin-top:14px; z-index:3; position:relative; }
    .btn-print, .btn-home { padding:8px 14px; border-radius:22px; font-weight:700; border:0; cursor:pointer; }
    .btn-print { background:#fff; color:var(--primary); border:2px solid var(--primary); }
    .btn-home { background:var(--primary); color:#fff; }

    @media (max-width:420px){
      body{ padding:12px; }
      .id-card{ transform: scale(0.92); transform-origin: center top; }
    }
  </style>
</head>
<body>

  <div id="idcard" class="id-card" role="region" aria-label="Student ID card">
    <div class="watermark" aria-hidden="true"></div>

    <div class="id-header" role="heading" aria-level="1">
      <h4>NOORUSSALAM SECONDARY MADRASA</h4>
      <small>Kambippalam - Kerala Estate</small>
      <small>Under SKIMVB | Reg No: 6110</small>
    </div>

    <img src="${escapeHtml(s.PhotoURL)}" alt="Student photo" class="photo" />

    <div class="fullname">${escapeHtml(s.FullName)}</div>

    <div class="details" aria-live="polite">
      <p><strong>UID:</strong> ${escapeHtml(s.UID)}</p>
      <p><strong>Admission No:</strong> ${escapeHtml(s.AdmissionNumber)}</p>
      <p><strong>Father's Name:</strong> ${escapeHtml(s.FatherName)}</p>
      <p><strong>Class:</strong> ${escapeHtml(s.ClassLevel)}</p>
      <p><strong>Roll No:</strong> ${escapeHtml(s.RollNumber)}</p>
      <p><strong>Phone:</strong> ${escapeHtml(s.Phone)}</p>
      <p><strong>Address:</strong> ${escapeHtml(s.Address)}</p>
    </div>

  </div>

  <div class="controls" role="group" aria-label="ID controls">
    <button class="btn-print" onclick="window.print();">Print ID Card</button>
    <button class="btn-home" onclick="window.location.href='${location.pathname}';">Back to Home</button>
  </div>

</body>
</html>`;

    // write into new tab and close doc
    win.document.open();
    win.document.write(cardHtml);
    win.document.close();

  } catch (err) {
    console.error(err);
    win.document.body.innerHTML = `<div style="font-family:Nunito,Arial,sans-serif;padding:28px;text-align:center;color:#b91c1c;">
      <h3>Error fetching data</h3><p>Check Apps Script deployment or network. See console for details.</p></div>`;
  }
});

/* helper for safety */
function escapeHtml(str){
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
</script>

</body>
</html>
