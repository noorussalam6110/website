<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noorussalam Madrasa — ID Card Generator</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --primary:#0b5ed7; --primary-dark:#0849a2; --card-width:328px; --card-height:205px; } /* 86×54 mm -> px approximated */
    body {
      font-family: "Poppins",sans-serif;
      min-height:100vh;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg, var(--primary) 0%, #74b9ff 100%);
      padding:28px;
    }

    .id-form {
      width:100%;
      max-width:460px;
      background: #fffafc;
      padding:28px;
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      text-align:center;
    }

    .id-form img { margin-bottom:8px; }
    .id-form h1 { font-size:1.05rem; color:var(--primary); margin:0 0 8px; font-weight:700; text-transform:uppercase; }
    .id-form p { color:#556; margin-bottom:18px; }

    .form-control { border-radius:10px; height:46px; }
    .btn-generate {
      background: linear-gradient(90deg,var(--primary),#167bff);
      border: none;
      color:#fff;
      font-weight:600;
      height:46px;
      border-radius:10px;
      box-shadow: 0 8px 20px rgba(11,94,215,0.28);
    }
    .btn-generate:hover { background: var(--primary-dark); transform:translateY(-2px); }

    small.hint { display:block; margin-top:10px; color:#999; }

    /* small responsive */
    @media (max-width:520px){
      .id-form{ padding:20px; border-radius:14px; }
    }
  </style>
</head>
<body>

  <div class="id-form">
    <img src="https://i.ibb.co/7Jw5TBJg/NSM-LOGO-PNG.png" alt="logo" width="86">
    <h1>NOORUSSALAM MADRASA</h1>
    <p>Enter Class and Roll Number to generate the ID card (opens in new tab)</p>

    <form id="idForm" class="mt-3">
      <div class="mb-3 text-start">
        <label class="form-label">Class</label>
        <input name="class" class="form-control" placeholder="e.g. 7A or 8" required>
      </div>

      <div class="mb-3 text-start">
        <label class="form-label">Roll Number</label>
        <input name="roll" class="form-control" placeholder="e.g. 12" required inputmode="numeric" pattern="[0-9]*">
      </div>

      <button type="submit" class="btn btn-generate w-100">Generate Digital ID Card</button>
      <small class="hint">Printed card size: 86 × 54 mm (CR-80). Use 'Print' in the new tab for best results.</small>
    </form>
  </div>

<script>
/*
  Replace SCRIPT_URL with your deployed Apps Script web app URL if different.
  The script is expected to respond with JSON:
  { result: "success", student: { FullName, UID, AdmissionNumber, FatherName, ClassLevel, RollNumber, Phone, Address, PhotoURL } }
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwNp2D-Kg6yGaiGaP5npYiyGXRoGI3eTrf_DdHCXo-4Lo2mw2kLQEBucmNl5VkQs8R/exec";

document.getElementById('idForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const form = new FormData(ev.target);
  const cls = form.get('class').trim();
  const roll = form.get('roll').trim();
  if (!cls || !roll) return alert('Please enter class and roll number.');

  const url = `${SCRIPT_URL}?class=${encodeURIComponent(cls)}&roll=${encodeURIComponent(roll)}`;

  // open blank tab first to avoid popup blocking
  const win = window.open('', '_blank');
  win.document.write(`<div style="font-family:Poppins, sans-serif; text-align:center; padding:40px; color:${'#0b5ed7'}"><h3>Loading ID Card...</h3></div>`);

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (!data || data.result !== 'success') {
      const msg = (data && data.message) ? data.message : 'Student not found or server error.';
      win.document.body.innerHTML = `<h3 style="color:red; text-align:center; font-family:Poppins;">${msg}</h3>`;
      return;
    }

    const s = data.student || {};
    // fallback values
    s.FullName = s.FullName || 'STUDENT NAME';
    s.UID = s.UID || '';
    s.AdmissionNumber = s.AdmissionNumber || '';
    s.FatherName = s.FatherName || '';
    s.ClassLevel = s.ClassLevel || cls;
    s.RollNumber = s.RollNumber || roll;
    s.Phone = s.Phone || '';
    s.Address = s.Address || '';
    s.PhotoURL = s.PhotoURL || 'https://via.placeholder.com/200';

    // build ID card html (no QR)
    const cardHtml = `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(s.FullName)} — ID Card</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{ --primary:#0b5ed7; --card-w:328px; --card-h:205px; }
  body{ font-family: Poppins, sans-serif; background:#eef4ff; margin:0; padding:28px; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  /* print only the card */
  @media print {
    body * { visibility:hidden; }
    #idcard, #idcard * { visibility:visible; }
    #idcard { position:absolute; left:50%; top:20px; transform:translateX(-50%); }
  }
  .id-card {
    width: var(--card-w);
    height: var(--card-h);
    background:#fff;
    border-radius:16px;
    border:4px solid var(--primary);
    box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 0 12px rgba(0,0,0,0.06);
    overflow:hidden;
    position:relative;
    text-align:center;
  }
  /* circular watermark (placeholder) */
  .watermark {
    position:absolute;
    width:120px; height:120px;
    top:36%; left:50%;
    transform:translate(-50%,-50%);
    background-image:url('https://i.ibb.co/7SRxgqT/round-placeholder.png');
    background-size:contain;
    background-repeat:no-repeat;
    opacity:0.10;
    border-radius:50%;
    pointer-events:none;
    z-index:0;
  }
  .id-header { background:linear-gradient(90deg,var(--primary),#6fb6ff); color:#fff; padding:6px 8px; z-index:2; position:relative; }
  .id-header h4{ margin:0; font-size:13px; font-weight:700; }
  .id-header small{ display:block; font-size:9px; opacity:0.95; margin-top:2px; }

  .photo { width:74px; height:74px; border-radius:50%; object-fit:cover; border:3px solid #fff; margin-top:10px; box-shadow:0 3px 10px rgba(0,0,0,0.28); z-index:2; position:relative; }

  .fullname { color:var(--primary); font-weight:700; margin-top:6px; font-size:14px; z-index:2; position:relative; }
  .info { font-size:10px; line-height:12px; margin-top:4px; z-index:2; position:relative; padding:0 12px; text-align:left; }
  .info p { margin:2px 0; color:#222; }

  .controls { margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:center; }
  .btn-print, .btn-home { padding:8px 16px; border-radius:24px; font-weight:600; border:0; cursor:pointer; }
  .btn-print { background:#fff; color:var(--primary); border:2px solid var(--primary); }
  .btn-home { background:var(--primary); color:#fff; }

  /* small screens */
  @media (max-width:420px){
    body { padding:10px; }
    .id-card { transform:scale(0.9); transform-origin:center top; }
  }
</style>
</head>
<body>

  <div id="idcard" class="id-card" role="region" aria-label="Student ID card">
    <div class="watermark" aria-hidden="true"></div>

    <div class="id-header">
      <h4>NOORUSSALAM SECONDARY MADRASA</h4>
      <small>Kambippalam - Kerala Estate</small>
      <small>Under SKIMVB | Reg No: 6110</small>
    </div>

    <img src="${escapeHtml(s.PhotoURL)}" alt="Student photo" class="photo">

    <div class="fullname">${escapeHtml(s.FullName)}</div>

    <div class="info">
      <p><strong>UID:</strong> ${escapeHtml(s.UID)}</p>
      <p><strong>Admission No:</strong> ${escapeHtml(s.AdmissionNumber)}</p>
      <p><strong>Father's Name:</strong> ${escapeHtml(s.FatherName)}</p>
      <p><strong>Class:</strong> ${escapeHtml(s.ClassLevel)}</p>
      <p><strong>Roll No:</strong> ${escapeHtml(s.RollNumber)}</p>
      <p><strong>Phone:</strong> ${escapeHtml(s.Phone)}</p>
      <p><strong>Address:</strong> ${escapeHtml(s.Address)}</p>
    </div>

    <div style="height:6px;"></div>
  </div>

  <div class="controls">
    <button class="btn-print" onclick="window.print()">Print ID Card</button>
    <button class="btn-home" onclick="window.location.href='${location.pathname}'">Back to Home</button>
  </div>

</body>
</html>`;

    // write full HTML into new tab
    win.document.open();
    win.document.write(cardHtml);
    win.document.close();

  } catch (err) {
    console.error(err);
    win.document.body.innerHTML = `<div style="text-align:center;color:#b00;font-family:Poppins;padding:30px;">
      <h3>Error fetching data</h3><p>Please check your Apps Script deployment and console for details.</p></div>`;
  }
});

/* small helper to avoid HTML injection in template */
function escapeHtml(str){
  if (!str && str !== 0) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
</script>
</body>
</html>
